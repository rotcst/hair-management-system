<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Firebaseè¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: Arial; background: #1a1a1a; color: #fff; padding: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        button { background: #D4AF37; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        #log { background: #333; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Firebaseè¯Šæ–­å·¥å…·</h1>
    
    <div id="mainStatus" class="status warning">æ­£åœ¨æ£€æŸ¥...</div>
    
    <button onclick="checkFirestoreEnabled()">æ£€æŸ¥Firestoreæ˜¯å¦å¯ç”¨</button>
    <button onclick="testEmployeeOperations()">æµ‹è¯•å‘˜å·¥æ“ä½œ</button>
    <button onclick="forceReset()">å¼ºåˆ¶é‡ç½®çŠ¶æ€</button>
    
    <h3>è¯¦ç»†æ—¥å¿—ï¼š</h3>
    <div id="log"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAcLyCy4FIL34AUd6vKrE_EqHV69qcFDYQ",
            authDomain: "mesiahair.firebaseapp.com",
            projectId: "mesiahair",
            storageBucket: "mesiahair.firebasestorage.app",
            messagingSenderId: "538029419112",
            appId: "1:538029419112:web:e2bb82a5fe0356e8d769dd"
        };

        let db;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('log').textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function updateMainStatus(message, type) {
            const status = document.getElementById('mainStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // åˆå§‹åŒ–Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            window.db = db;
            log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
            
            // ç«‹å³æ£€æŸ¥è¿æ¥
            setTimeout(checkFirestoreEnabled, 1000);
        } catch (error) {
            log(`âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            updateMainStatus('Firebaseåˆå§‹åŒ–å¤±è´¥', 'error');
        }

        async function checkFirestoreEnabled() {
            log('ğŸ” æ£€æŸ¥Firestoreæ•°æ®åº“çŠ¶æ€...');
            updateMainStatus('æ­£åœ¨æ£€æŸ¥Firestore...', 'warning');
            
            try {
                // å°è¯•è·å–ä¸€ä¸ªç®€å•çš„é›†åˆä¿¡æ¯
                const snapshot = await db.collection('_test_connection').limit(1).get();
                log('âœ… Firestoreæ•°æ®åº“å·²å¯ç”¨å¹¶å¯è®¿é—®');
                updateMainStatus('Firestoreæ­£å¸¸ï¼ç°åœ¨æ£€æŸ¥ä¸»é¡µé¢...', 'success');
                
                // æ£€æŸ¥ä¸»é¡µé¢çŠ¶æ€
                checkMainPageStatus();
                
            } catch (error) {
                log(`âŒ Firestoreè®¿é—®å¤±è´¥: ${error.code} - ${error.message}`);
                
                if (error.code === 'failed-precondition') {
                    updateMainStatus('Firestoreæ•°æ®åº“æœªå¯ç”¨ï¼', 'error');
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šåœ¨Firebaseæ§åˆ¶å°å¯ç”¨Firestoreæ•°æ®åº“');
                } else if (error.code === 'permission-denied') {
                    updateMainStatus('å®‰å…¨è§„åˆ™é˜»æ­¢è®¿é—®', 'error');
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥Firestoreå®‰å…¨è§„åˆ™è®¾ç½®');
                } else {
                    updateMainStatus('Firestoreè¿æ¥å¤±è´¥', 'error');
                }
            }
        }

        function checkMainPageStatus() {
            log('ğŸ” æ£€æŸ¥ä¸»é¡µé¢FirebaseçŠ¶æ€...');
            
            // æ¨¡æ‹Ÿä¸»é¡µé¢çš„çŠ¶æ€æ£€æŸ¥é€»è¾‘
            const isOnline = navigator.onLine;
            const hasDb = window.db !== undefined;
            const hasFirebase = window.firebase !== undefined;
            
            log(`ç½‘ç»œçŠ¶æ€: ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
            log(`Firebaseå¯¹è±¡: ${hasFirebase ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            log(`Firestoreæ•°æ®åº“: ${hasDb ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            
            if (isOnline && hasDb && hasFirebase) {
                log('âœ… ä¸»é¡µé¢åº”è¯¥æ˜¾ç¤º"å·²è¿æ¥äº‘ç«¯æ•°æ®åº“"');
                updateMainStatus('æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ä¸»é¡µé¢åº”è¯¥æ­£å¸¸', 'success');
            } else {
                log('âŒ ä¸»é¡µé¢çŠ¶æ€æ£€æŸ¥å¤±è´¥');
                updateMainStatus('ä¸»é¡µé¢çŠ¶æ€å¼‚å¸¸', 'error');
            }
        }

        async function testEmployeeOperations() {
            log('ğŸ”„ æµ‹è¯•å‘˜å·¥æ•°æ®æ“ä½œ...');
            
            const testEmployee = {
                name: 'æµ‹è¯•å‘˜å·¥_' + Date.now(),
                position: 'salesperson',
                username: 'test_' + Date.now(),
                password: 'test123',
                mobile: '010-1234-5678',
                createTime: new Date().toLocaleString('zh-CN'),
                id: Date.now().toString()
            };
            
            try {
                // æ·»åŠ å‘˜å·¥
                await db.collection('employees').doc(testEmployee.id).set(testEmployee);
                log(`âœ… æˆåŠŸæ·»åŠ æµ‹è¯•å‘˜å·¥: ${testEmployee.name}`);
                
                // è¯»å–å‘˜å·¥
                const doc = await db.collection('employees').doc(testEmployee.id).get();
                if (doc.exists) {
                    log(`âœ… æˆåŠŸè¯»å–å‘˜å·¥æ•°æ®: ${JSON.stringify(doc.data())}`);
                    
                    // åˆ é™¤æµ‹è¯•å‘˜å·¥
                    await db.collection('employees').doc(testEmployee.id).delete();
                    log('âœ… æˆåŠŸåˆ é™¤æµ‹è¯•å‘˜å·¥');
                    
                    updateMainStatus('å‘˜å·¥æ“ä½œæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');
                    
                } else {
                    log('âŒ å‘˜å·¥æ•°æ®å†™å…¥æˆåŠŸä½†è¯»å–å¤±è´¥');
                }
                
            } catch (error) {
                log(`âŒ å‘˜å·¥æ“ä½œå¤±è´¥: ${error.code} - ${error.message}`);
                updateMainStatus('å‘˜å·¥æ“ä½œæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        function forceReset() {
            log('ğŸ”„ å¼ºåˆ¶é‡ç½®æœ¬åœ°çŠ¶æ€...');
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.clear();
            log('âœ… å·²æ¸…é™¤localStorage');
            
            // é‡æ–°åŠ è½½é¡µé¢
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    </script>
</body>
</html> 