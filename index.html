<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MAKE IT HAIR Professional - 管理系统</title>
    <!-- SheetJS库用于处理Excel文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK - 用于云端数据同步 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #FFD700;
            --black: #000000;
            --dark-gray: #1a1a1a;
            --text-light: #ffffff;
        }
        
        /* 浅色模式变量 */
        body.light-theme {
            --gold: #B8860B;
            --gold-light: #DAA520;
            --black: #f8f9fa;
            --dark-gray: #f5f5f5;
            --text-light: #212529;
        }
        
        /* 浅色模式特定样式 */
        body.light-theme .menu-item {
            background: #ffffff;
            border: 1px solid var(--gold);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        body.light-theme .menu-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        body.light-theme .content-area {
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        body.light-theme .top-nav .store-info,
        body.light-theme .top-nav .user-info,
        body.light-theme .top-nav .language-switcher {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background: #ffffff !important;
            border-color: var(--gold) !important;
            color: var(--text-light) !important;
        }
        
        body.light-theme .submenu-item {
            background: rgba(184, 134, 11, 0.1);
            border: 1px solid rgba(184, 134, 11, 0.3);
        }
        
        body.light-theme .submenu-item:hover {
            background: rgba(184, 134, 11, 0.2);
        }
        
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--black);
            color: var(--text-light);
        }
        
        .container {
            max-width: 1200px;
            margin: 60px auto 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
            padding: 20px;
            border-bottom: 2px solid var(--gold);
        }
        
        .logo {
            font-size: 2.5em;
            color: var(--gold);
            margin-bottom: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .logo:hover {
            color: var(--gold-light);
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .subtitle {
            color: var(--gold-light);
            font-style: italic;
            font-size: 1.2em;
        }
        
        .menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .menu-item {
            background: var(--dark-gray);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid var(--gold);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.2);
            border-color: var(--gold-light);
        }
        
        .menu-item:hover h2 {
            color: var(--gold-light);
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(212, 175, 55, 0.1), transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }
        
        .menu-item:hover::before {
            transform: translateX(100%);
        }
        
        h1 {
            color: var(--gold);
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        
        h2 {
            color: var(--gold);
            margin: 0 0 15px 0;
            font-size: 1.5em;
            transition: color 0.3s ease;
        }
        
        p {
            color: var(--text-light);
            margin: 0;
            line-height: 1.6;
            font-size: 1.1em;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid var(--gold);
            color: var(--gold-light);
        }
        
        /* 子菜单样式 */
        .submenu {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gold);
        }
        
        .submenu.active {
            display: block;
        }
        
        .submenu-item {
            background: rgba(212, 175, 55, 0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submenu-item:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold);
            transform: translateX(10px);
        }
        
        .submenu-item h3 {
            color: var(--gold-light);
            margin: 0 0 5px 0;
            font-size: 1.1em;
        }
        
        .submenu-item p {
            margin: 0;
            font-size: 0.9em;
            color: #cccccc;
        }
        
        .back-button {
            background: var(--gold);
            color: var(--black);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
        }
        
        .content-area {
            display: none;
            background: var(--dark-gray);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid var(--gold);
            margin-top: 20px;
        }
        
        .content-area.active {
            display: block;
        }
        
        .content-area h1 {
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
        }
        
        /* 顶部导航栏样式 */
        .top-nav {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 代理店名称显示样式 */
        .store-info {
            background: var(--dark-gray);
            padding: 8px 15px;
            border-radius: 8px;
            height: 40px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }
        
        .store-info span {
            color: var(--gold);
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* 右侧导航组 */
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* 用户信息显示样式 */
        .user-info {
            background: var(--dark-gray);
            padding: 8px 15px;
            border-radius: 8px;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-sizing: border-box;
        }
        
        .user-position {
            background: var(--gold);
            color: var(--black);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .user-name {
            color: var(--text-light);
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .user-name:hover {
            background-color: rgba(212, 175, 55, 0.2);
            border-radius: 3px;
            padding: 2px 6px;
        }
        
        .user-name::after {
            content: ' ▼';
            font-size: 0.8em;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        /* 语言切换样式 */
        .language-switcher {
            display: flex;
            gap: 5px;
            background: var(--dark-gray);
            padding: 8px 15px;
            border-radius: 8px;
            height: 40px;
            align-items: center;
            box-sizing: border-box;
        }
        
        .language-btn {
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--gold);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            background: var(--gold);
            color: var(--black);
        }
        
        .language-btn.active {
            background: var(--gold);
            color: var(--black);
            font-weight: bold;
        }
        
        /* 隐藏数字输入框的上下调节按钮 */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* 固定表格和输入框尺寸，防止输入时变化 */
        #productTable {
            table-layout: fixed;
            width: 100%;
        }
        
        #productTable th:nth-child(1) { width: 25%; }  /* 产品名 */
        #productTable th:nth-child(2) { width: 18%; }  /* 单价 */
        #productTable th:nth-child(3) { width: 12%; }  /* 数量 */
        #productTable th:nth-child(4) { width: 12%; }  /* 赠送 */
        #productTable th:nth-child(5) { width: 18%; }  /* 总金额 */
        #productTable th:nth-child(6) { width: 15%; }  /* 操作 */
        
        #productTable input {
            min-width: 0;
            max-width: 100%;
        }
        
        /* 固定模态框宽度 */
        #transactionModal > div {
            min-width: 600px;
            max-width: 600px;
        }
        
        /* 自定义日期输入框样式 */
        input[type="date"] {
            position: relative;
            background: var(--dark-gray);
            border: 1px solid var(--gold);
            color: var(--text-light);
            border-radius: 5px;
        }
        
        /* 隐藏浏览器默认的日期提示文字（保持输入框结构） */
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        /* 完全隐藏所有日期输入框的默认文字显示 */
        input[type="date"]::-webkit-datetime-edit,
        input[type="date"]::-webkit-datetime-edit-text,
        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field {
            color: transparent !important;
            background: transparent !important;
        }
        
        /* 强制隐藏聚焦时的文字显示 */
        input[type="date"]:focus::-webkit-datetime-edit,
        input[type="date"]:focus::-webkit-datetime-edit-text,
        input[type="date"]:focus::-webkit-datetime-edit-month-field,
        input[type="date"]:focus::-webkit-datetime-edit-day-field,
        input[type="date"]:focus::-webkit-datetime-edit-year-field {
            color: transparent !important;
            background: transparent !important;
        }
        
        /* 只有在有有效值且不是焦点状态时才显示 */
        input[type="date"]:valid:not(:focus)::-webkit-datetime-edit,
        input[type="date"]:valid:not(:focus)::-webkit-datetime-edit-text,
        input[type="date"]:valid:not(:focus)::-webkit-datetime-edit-month-field,
        input[type="date"]:valid:not(:focus)::-webkit-datetime-edit-day-field,
        input[type="date"]:valid:not(:focus)::-webkit-datetime-edit-year-field {
            color: var(--text-light) !important;
        }
        
        /* 自定义日期选择器的图标 */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            right: 0;
            width: 30px;
            height: 100%;
            cursor: pointer;
        }
        
        /* 日期输入框focus状态 */
        input[type="date"]:focus {
            border-color: var(--gold-light);
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
            outline: none;
        }
        
        /* 自定义placeholder容器 */
        .date-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        /* 覆盖层隐藏默认文字 */
        .date-input-wrapper::after {
            content: '';
            position: absolute;
            left: 1px;
            top: 1px;
            right: 28px;
            bottom: 1px;
            background: var(--dark-gray);
            pointer-events: none;
            z-index: 1;
            border-radius: 3px;
        }
        
        .date-input-wrapper.has-value::after,
        .date-input-wrapper.focused::after {
            display: none;
        }
        
        .date-input-wrapper::before {
            display: none !important;
        }
        
        .date-input-wrapper.has-value::before,
        .date-input-wrapper.focused::before {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="top-nav">
        <!-- 代理店名称显示（左侧） -->
        <div class="store-info">
            <span id="storeName" data-i18n="store-name">메시아서부지점관리시스템</span>
        </div>
        
        <!-- 右侧信息组 -->
        <div class="nav-right">
            <!-- 用户信息显示 -->
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userPosition" class="user-position"></span>
                <span id="userName" class="user-name" onclick="showUserMenu()" style="cursor: pointer; position: relative;"></span>
            </div>
            
            <!-- 主题切换器 -->
            <div class="theme-switcher" style="margin-right: 15px;">
                <button id="theme-toggle" onclick="toggleTheme()" style="background: none; border: 2px solid var(--gold); color: var(--gold); padding: 6px 10px; border-radius: 20px; cursor: pointer; font-size: 1.2em; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" title="切换深浅色模式">
                    <span id="theme-icon">🌙</span>
                </button>
            </div>
            
            <!-- 语言切换器 -->
            <div class="language-switcher">
                <button class="language-btn active" onclick="switchLanguage('zh')" id="btn-zh">中文</button>
                <button class="language-btn" onclick="switchLanguage('ko')" id="btn-ko">한국어</button>
            </div>
        </div>
    </div>
    
    <div class="container" style="margin-top: 80px;">
        <div class="header">
            <div class="logo" onclick="goToHomePage()" title="点击返回首页">M</div>
            <div class="subtitle">MAKE IT HAIR Professional</div>
        </div>
        
        <div id="main-menu" class="menu">
            <div class="menu-item" onclick="showSubmenu('employee')">
                <h2 data-i18n="employee-management">职员管理</h2>
                <p data-i18n="employee-management-desc">管理业务员信息、权限和账号</p>
                <div id="employee-submenu" class="submenu">
                    <div class="submenu-item" onclick="showContent('new-employee', event)" id="new-employee-menu" style="display: none;">
                        <h3 data-i18n="new-employee">新增职员</h3>
                        <p data-i18n="new-employee-desc">添加新的业务员账号</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('employee-list', event)">
                        <h3 data-i18n="employee-list">职员列表</h3>
                        <p data-i18n="employee-list-desc">查看和编辑职员信息</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('delete-employee', event)" id="delete-employee-menu" style="display: none;">
                        <h3 data-i18n="delete-employee">删除职员</h3>
                        <p data-i18n="delete-employee-desc">删除不需要的职员账号</p>
                    </div>
                </div>
            </div>
            
            <div class="menu-item" onclick="showSubmenu('customer')">
                <h2 data-i18n="customer-management">客户信息管理</h2>
                <p data-i18n="customer-management-desc">管理客户资料、交易记录、服务历史等信息</p>
                <div id="customer-submenu" class="submenu">
                    <div class="submenu-item" onclick="showContent('new-salon', event)">
                        <h3 data-i18n="new-salon">新增沙龙</h3>
                        <p data-i18n="new-salon-desc">添加新的沙龙客户信息</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('salon-info', event)">
                        <h3 data-i18n="salon-info">沙龙信息</h3>
                        <p data-i18n="salon-info-desc">查看和编辑现有沙龙信息</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('delete-salon', event)" id="delete-salon-menu" style="display: none;">
                        <h3 data-i18n="delete-salon">删除沙龙</h3>
                        <p data-i18n="delete-salon-desc">删除不需要的沙龙客户</p>
                    </div>
                </div>
            </div>
            <div class="menu-item" onclick="showSubmenu('product')">
                <h2 data-i18n="product-management">产品信息管理</h2>
                <p data-i18n="product-management-desc">管理美发产品目录、库存、价格等信息</p>
                <div id="product-submenu" class="submenu">
                    <div class="submenu-item" onclick="showContent('add-product', event)">
                        <h3 data-i18n="add-product">新增产品</h3>
                        <p data-i18n="add-product-desc">添加新的美发产品</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('product-list', event)">
                        <h3 data-i18n="product-list">产品列表</h3>
                        <p data-i18n="product-list-desc">查看所有产品信息</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('product-category', event)">
                        <h3 data-i18n="product-category">产品分类</h3>
                        <p data-i18n="product-category-desc">管理产品分类</p>
                    </div>
                </div>
            </div>
            <div class="menu-item" onclick="showSubmenu('inventory')">
                <h2 data-i18n="inventory-management">库存信息管理</h2>
                <p data-i18n="inventory-management-desc">跟踪产品库存、补货预警、使用记录等</p>
                <div id="inventory-submenu" class="submenu">
                    <div class="submenu-item" onclick="showContent('stock-check', event)">
                        <h3 data-i18n="stock-check">库存盘点</h3>
                        <p data-i18n="stock-check-desc">检查当前库存状态</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('restock-alert', event)">
                        <h3 data-i18n="restock-alert">补货提醒</h3>
                        <p data-i18n="restock-alert-desc">设置库存预警</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('usage-record', event)">
                        <h3 data-i18n="usage-record">使用记录</h3>
                        <p data-i18n="usage-record-desc">查看产品使用历史</p>
                    </div>
                </div>
            </div>
            <div class="menu-item" onclick="showSubmenu('finance')">
                <h2 data-i18n="finance-management">财务信息管理</h2>
                <p data-i18n="finance-management-desc">管理收支记录、服务收入、产品销售等</p>
                <div id="finance-submenu" class="submenu">
                    <div class="submenu-item" onclick="showContent('income-record', event)">
                        <h3 data-i18n="income-record">收入记录</h3>
                        <p data-i18n="income-record-desc">记录服务和销售收入</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('expense-record', event)">
                        <h3 data-i18n="expense-record">支出记录</h3>
                        <p data-i18n="expense-record-desc">记录各项支出</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('financial-report', event)">
                        <h3 data-i18n="financial-report">财务报表</h3>
                        <p data-i18n="financial-report-desc">生成财务分析报告</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('performance-target', event)">
                        <h3 data-i18n="performance-target">业绩目标</h3>
                        <p data-i18n="performance-target-desc">管理个人和团队业绩目标</p>
                    </div>
                </div>
            </div>
            
            <div class="menu-item" onclick="showSubmenu('audit')">
                <h2 data-i18n="audit-management">操作历史管理</h2>
                <p data-i18n="audit-management-desc">管理系统操作记录、数据审计和安全监控</p>
                <div id="audit-submenu" class="submenu">
                    <div class="submenu-item" onclick="showContent('operation-history', event)">
                        <h3 data-i18n="operation-history">操作历史记录</h3>
                        <p data-i18n="operation-history-desc">查看所有用户的操作历史和数据变更记录</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('data-comparison', event)">
                        <h3 data-i18n="data-comparison">数据对比查看</h3>
                        <p data-i18n="data-comparison-desc">对比查看修改前后的数据变化</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('audit-report', event)">
                        <h3 data-i18n="audit-report">审计报告</h3>
                        <p data-i18n="audit-report-desc">生成操作统计和安全审计报告</p>
                    </div>
                    <div class="submenu-item" onclick="showContent('approval-management', event)" id="approval-management-menu" style="display: none;">
                        <h3 data-i18n="approval-management">审批管理</h3>
                        <p data-i18n="approval-management-desc">处理待审批的操作请求</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 内容显示区域 -->
        <!-- 职员管理页面 -->
        <div id="new-employee" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="new-employee">新增职员</h1>
            <form id="newEmployeeForm">
                <div style="margin-bottom: 20px;">
                    <label for="employeeName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-name">姓名：</label>
                    <input type="text" id="employeeName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="employeePosition" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-position">职位：</label>
                    <select id="employeePosition" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                        <option value="salesperson" data-i18n="salesperson">业务员</option>
                        <option value="manager" data-i18n="manager">经理</option>
                        <option value="admin" data-i18n="admin">管理员</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="employeeUsername" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-username">登录账号：</label>
                    <input type="text" id="employeeUsername" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="employeePassword" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-password">密码：</label>
                    <input type="password" id="employeePassword" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="employeeMobile" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-mobile">手机号：</label>
                    <input type="tel" id="employeeMobile" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                
                <!-- 银行账户信息 -->
                <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 20px;">
                    <h3 style="color: var(--gold); margin: 0 0 15px 0;" data-i18n="bank-account-info">银行账户信息</h3>
                    <div style="margin-bottom: 15px;">
                        <label for="employeeBankName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="bank-name">银行名称：</label>
                        <input type="text" id="employeeBankName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;" placeholder="例：中国银行">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="employeeAccountNumber" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="account-number">银行账号：</label>
                        <input type="text" id="employeeAccountNumber" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="employeeAccountHolder" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="account-holder">账户持有人：</label>
                        <input type="text" id="employeeAccountHolder" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;" placeholder="默认使用职员姓名">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="employeeBankBranch" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="bank-branch">开户支行（选填）：</label>
                        <input type="text" id="employeeBankBranch" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                    </div>
                </div>
                
                <button type="submit" style="background: var(--gold); color: var(--black); border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 1.1em;" data-i18n="add">添加</button>
            </form>
        </div>
        
        <div id="employee-list" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="employee-list">职员列表</h1>
            <p data-i18n="employee-list-desc">这里显示所有职员的详细信息列表。</p>
            <div id="employee-list-content" style="margin-top: 20px;">
                <!-- 职员列表将在这里动态生成 -->
            </div>
        </div>
        
        <div id="delete-employee" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="delete-employee">删除职员</h1>
            <p style="color: #ff6666; margin-bottom: 20px;" data-i18n="delete-warning">⚠️ 删除操作无法撤销，请谨慎操作！</p>
            <div style="background: rgba(255, 102, 102, 0.1); padding: 20px; border-radius: 5px; border: 1px solid #ff6666;">
                <h3 style="color: #ff6666;" data-i18n="select-employee-to-delete">选择要删除的职员</h3>
                <select id="deleteEmployeeSelect" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid #ff6666; color: var(--text-light); border-radius: 5px; margin: 10px 0;">
                    <option value="" data-i18n="please-select-employee">请选择职员...</option>
                </select>
                <button onclick="deleteSelectedEmployee()" style="background: #ff6666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;" data-i18n="confirm-delete">确认删除</button>
            </div>
        </div>
        
        <div id="new-salon" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="new-salon">新增沙龙</h1>
            
            <!-- 批量上传功能（仅管理员和经理可见） -->
            <div id="batch-upload-section" style="display: none; background: rgba(135, 206, 235, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(135, 206, 235, 0.3); margin-bottom: 30px;">
                <h3 style="color: #87CEEB; margin: 0 0 15px 0;" data-i18n="batch-upload-salons">批量上传沙龙</h3>
                <p style="color: #cccccc; font-size: 0.9em; margin-bottom: 15px;" data-i18n="batch-upload-description">
                    上传包含沙龙信息的Excel表格文件，系统将自动解析"업소명"和"영업소 주소"列，并根据地址关键字自动设置区域。
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #87CEEB; margin-bottom: 5px;" data-i18n="select-file">选择文件：</label>
                    <!-- 隐藏原生文件输入框 -->
                    <input type="file" id="salon-file-upload" accept=".xlsx,.xls" style="display: none;">
                    <!-- 自定义文件上传控件 -->
                    <div style="position: relative; width: 100%;">
                        <button type="button" onclick="document.getElementById('salon-file-upload').click()" style="width: 100%; padding: 8px 12px; background: var(--dark-gray); border: 1px solid #87CEEB; color: var(--text-light); border-radius: 5px; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <span id="file-upload-text" data-i18n="choose-file">选择文件</span>
                            <span style="color: #87CEEB;">📁</span>
                        </button>
                        <div id="selected-file-name" style="margin-top: 5px; color: #4CAF50; font-size: 0.9em; display: none;"></div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" onclick="processSalonFile()" style="background: #87CEEB; color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="process-file">处理文件</button>
                    <button type="button" onclick="downloadSampleFile()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="download-sample">下载样例模板</button>
                </div>
                
                <!-- 预览区域 -->
                <div id="file-preview" style="margin-top: 20px; display: none;">
                    <h4 style="color: #87CEEB;" data-i18n="preview-data">数据预览：</h4>
                    <div id="preview-table" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 15px;"></div>
                    
                    <!-- 批量创建进度条 -->
                    <div id="batch-progress-container" style="display: none; margin: 15px 0; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 5px; border: 1px solid rgba(212, 175, 55, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: var(--gold); font-weight: bold;" id="batch-progress-text">正在创建沙龙...</span>
                            <span style="color: var(--text-light);" id="batch-progress-count">0/0</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                            <div id="batch-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--gold), #FFD700); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                <span id="batch-progress-percent" style="color: var(--black); font-weight: bold; font-size: 0.8em;">0%</span>
                            </div>
                        </div>
                        <div style="color: #cccccc; font-size: 0.9em;" id="batch-progress-status">准备开始...</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="confirm-batch-btn" onclick="confirmBatchCreate()" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="confirm-batch-create">确认批量创建</button>
                        <button type="button" onclick="cancelBatchUpload()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="cancel">取消</button>
                    </div>
                </div>
            </div>
            
            <form id="newSalonForm">
                <div style="margin-bottom: 20px;">
                    <label for="salonName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-name">沙龙名称：</label>
                    <input type="text" id="salonName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="salonAddress" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-address">沙龙地址：</label>
                    <input type="text" id="salonAddress" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="businessLicense" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="business-license">营业执照号码：</label>
                    <input type="text" id="businessLicense" maxlength="14" oninput="formatBusinessLicense(this)" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;" placeholder="000-00-00000">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="salonDistrict" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-district">沙龙区域：</label>
                    <select id="salonDistrict" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                        <option value="" data-i18n="please-select-district">请选择区域...</option>
                        <option value="guro" data-i18n="guro-district">九老区</option>
                        <option value="yeongdeungpo" data-i18n="yeongdeungpo-district">永登浦区</option>
                        <option value="geumcheon" data-i18n="geumcheon-district">衿川区</option>
                        <option value="overseas" data-i18n="overseas-district">海外区域</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="responsibleEmployee" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="responsible-employee">负责职员：</label>
                    <select id="responsibleEmployee" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                        <option value="" data-i18n="please-select-employee">请选择职员...</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="salonPhone" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-phone">店铺电话：</label>
                    <input type="tel" id="salonPhone" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="directorName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="director-name">院长姓名：</label>
                    <input type="text" id="directorName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="directorMobile" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="director-mobile">手机：</label>
                    <input type="tel" id="directorMobile" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                </div>
                <button type="submit" style="background: var(--gold); color: var(--black); border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 1.1em;" data-i18n="add">添加</button>
            </form>
        </div>
        
        <div id="salon-info" class="content-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="color: var(--gold); white-space: nowrap;" data-i18n="filter-by-responsible">按负责人员：</label>
                    <select id="responsible-filter" onchange="filterSalons()" style="padding: 8px 12px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                        <option value="" data-i18n="all-employees">全部人员</option>
                    </select>
                    <label style="color: var(--gold); white-space: nowrap;" data-i18n="filter-by-district">按区域筛选：</label>
                    <select id="district-filter" onchange="filterSalons()" style="padding: 8px 12px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                        <option value="" data-i18n="all-districts">全部区域</option>
                        <option value="guro" data-i18n="guro-district">九老区</option>
                        <option value="yeongdeungpo" data-i18n="yeongdeungpo-district">永登浦区</option>
                        <option value="geumcheon" data-i18n="geumcheon-district">衿川区</option>
                        <option value="overseas" data-i18n="overseas-district">海外区域</option>
                    </select>
                    <input type="text" id="salon-search" placeholder="搜索沙龙名、院长名或手机号..." style="padding: 8px 12px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; width: 250px;" onkeyup="searchSalons()" data-i18n-placeholder="search-salon-placeholder">
                    <button onclick="clearSearch()" style="background: var(--gold); color: var(--black); border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;" data-i18n="clear-search">清空</button>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h1 data-i18n="salon-info" style="margin: 0;">沙龙信息</h1>
                <div id="batch-controls" style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 5px; color: var(--gold); cursor: pointer;">
                        <input type="checkbox" id="select-all-salons" onchange="toggleSelectAllSalons()" style="cursor: pointer;">
                        <span data-i18n="select-all">全选</span>
                    </label>
                    <button id="batch-delete-btn" onclick="batchDeleteSalons()" disabled style="background: #ff6666; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: not-allowed; font-size: 0.9em; opacity: 0.6;" data-i18n="batch-delete">批量删除</button>
                    <button id="batch-assign-btn" onclick="showBatchAssignModal()" disabled style="background: var(--gold); color: var(--black); border: none; padding: 6px 12px; border-radius: 4px; cursor: not-allowed; font-size: 0.9em; opacity: 0.6;" data-i18n="batch-assign">批量指定负责人</button>
                    <span id="selected-count" style="color: #cccccc; font-size: 0.9em;" data-i18n="selected-count">已选择 0 个沙龙</span>
                </div>
            </div>
            <p data-i18n="salon-info-list-desc">这里显示所有已添加的沙龙详细信息列表。</p>
            <div id="salon-count-display" style="margin: 15px 0; padding: 10px; background: rgba(212, 175, 55, 0.1); border-radius: 5px; border: 1px solid rgba(212, 175, 55, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--gold); font-weight: bold; font-size: 1.1em;" id="salon-count-text" data-i18n="total-salons-count" data-i18n-params='{"count": "0"}'>总计 0 家沙龙</span>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="displaySalonList(null)" style="background: rgba(212, 175, 55, 0.2); color: var(--gold); border: 1px solid var(--gold); padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(212, 175, 55, 0.4)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'" data-i18n="all-districts">全部区域</button>
                        <button onclick="displaySalonList('guro')" style="background: rgba(212, 175, 55, 0.2); color: var(--gold); border: 1px solid var(--gold); padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(212, 175, 55, 0.4)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'" data-i18n="district-guro">九老区</button>
                        <button onclick="displaySalonList('yeongdeungpo')" style="background: rgba(212, 175, 55, 0.2); color: var(--gold); border: 1px solid var(--gold); padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(212, 175, 55, 0.4)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'" data-i18n="district-yeongdeungpo">永登浦区</button>
                        <button onclick="displaySalonList('geumcheon')" style="background: rgba(212, 175, 55, 0.2); color: var(--gold); border: 1px solid var(--gold); padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(212, 175, 55, 0.4)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'" data-i18n="district-geumcheon">衿川区</button>
                        <button onclick="displaySalonList('overseas')" style="background: rgba(212, 175, 55, 0.2); color: var(--gold); border: 1px solid var(--gold); padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(212, 175, 55, 0.4)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'" data-i18n="district-other">해외지역</button>
                    </div>
                </div>
            </div>
            
            <!-- 排序控件 -->
            <div id="salon-sort-controls" style="margin: 15px 0; padding: 15px; background: rgba(135, 206, 235, 0.1); border-radius: 5px; border: 1px solid rgba(135, 206, 235, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; color: #87CEEB;">
                        <span style="font-weight: bold; font-size: 1em;" data-i18n="sort-by">排序方式：</span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="sort-name" onclick="toggleSalonSort('name')" style="background: rgba(135, 206, 235, 0.2); color: #87CEEB; border: 1px solid #87CEEB; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(135, 206, 235, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-name">沙龙名称 ↑</button>
                        <button id="sort-address" onclick="toggleSalonSort('address')" style="background: rgba(135, 206, 235, 0.2); color: #87CEEB; border: 1px solid #87CEEB; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(135, 206, 235, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-address">地址名称 ↑</button>
                        <button id="sort-addTime" onclick="toggleSalonSort('addTime')" style="background: rgba(135, 206, 235, 0.2); color: #87CEEB; border: 1px solid #87CEEB; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(135, 206, 235, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-add-time">新增时间 ↑</button>
                        <button id="sort-lastTransaction" onclick="toggleSalonSort('lastTransaction')" style="background: rgba(135, 206, 235, 0.2); color: #87CEEB; border: 1px solid #87CEEB; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(135, 206, 235, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-last-transaction">最后交易 ↑</button>
                        <button id="sort-outstandingDays" onclick="toggleSalonSort('outstandingDays')" style="background: rgba(135, 206, 235, 0.2); color: #87CEEB; border: 1px solid #87CEEB; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(135, 206, 235, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-outstanding-days">欠款天数 ↑</button>
                        <button id="sort-outstandingAmount" onclick="toggleSalonSort('outstandingAmount')" style="background: rgba(135, 206, 235, 0.2); color: #87CEEB; border: 1px solid #87CEEB; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(135, 206, 235, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-outstanding-amount">欠款金额 ↑</button>
                        <button id="sort-default" onclick="resetSalonSort()" style="background: rgba(255, 182, 193, 0.2); color: #FFB6C1; border: 1px solid #FFB6C1; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 182, 193, 0.4)'" onmouseout="updateSortButtonStyle(this)" data-i18n="sort-default">默认排序</button>
                    </div>
                </div>
            </div>
            <div id="salon-list" style="margin-top: 20px;">
                <!-- 沙龙列表将在这里动态生成 -->
            </div>
        </div>
        
        <div id="delete-salon" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="delete-salon">删除沙龙</h1>
            <p style="color: #ff6666; margin-bottom: 20px;" data-i18n="delete-warning">⚠️ 删除操作无法撤销，请谨慎操作！</p>
            
            <!-- 筛选和搜索框 -->
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <label style="color: var(--gold);" data-i18n="filter-by-district">按区域筛选：</label>
                <select id="delete-district-filter" onchange="filterDeleteSalonList()" style="padding: 8px 12px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                    <option value="" data-i18n="all-districts">全部区域</option>
                    <option value="guro" data-i18n="guro-district">九老区</option>
                    <option value="yeongdeungpo" data-i18n="yeongdeungpo-district">永登浦区</option>
                    <option value="geumcheon" data-i18n="geumcheon-district">衿川区</option>
                    <option value="overseas" data-i18n="overseas-district">海外区域</option>
                </select>
                <input type="text" id="delete-salon-search" placeholder="搜索沙龙名、院长名或手机号..." style="padding: 8px 12px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; width: 250px;" onkeyup="searchDeleteSalons()" data-i18n-placeholder="search-salon-placeholder">
                <button onclick="clearDeleteSearch()" style="background: #666; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;" data-i18n="clear-search">清空</button>
            </div>
            
            <div style="background: rgba(255, 102, 102, 0.1); padding: 20px; border-radius: 5px; border: 1px solid #ff6666;">
                <h3 style="color: #ff6666;" data-i18n="select-salon-to-delete">选择要删除的沙龙</h3>
                <select id="deleteSalonSelect" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid #ff6666; color: var(--text-light); border-radius: 5px; margin: 10px 0;">
                    <option value="" data-i18n="please-select-salon">请选择沙龙...</option>
                </select>
                <button onclick="deleteSelectedSalon()" style="background: #ff6666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;" data-i18n="confirm-delete">确认删除</button>
            </div>
        </div>
        
        <!-- 其他内容区域可以类似地添加 -->
        <div id="add-product" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="add-product">新增产品</h1>
            <p data-i18n="add-product-content">在这里添加新的美发产品信息...</p>
        </div>
        
        <div id="product-list" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="product-list">产品列表</h1>
            <p data-i18n="product-list-content">显示所有产品的列表...</p>
        </div>
        
        <div id="product-category" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="product-category">产品分类</h1>
            <p data-i18n="product-category-content">管理产品分类信息...</p>
        </div>
        
        <div id="stock-check" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="stock-check">库存盘点</h1>
            <p data-i18n="stock-check-content">进行库存盘点操作...</p>
        </div>
        
        <div id="restock-alert" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="restock-alert">补货提醒</h1>
            <p data-i18n="restock-alert-content">设置和查看补货提醒...</p>
        </div>
        
        <div id="usage-record" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="usage-record">使用记录</h1>
            <p data-i18n="usage-record-content">查看产品使用记录...</p>
        </div>
        
        <div id="income-record" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="income-record">收入记录</h1>
            <p data-i18n="income-record-content">记录和查看收入信息...</p>
        </div>
        
        <div id="expense-record" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="expense-record">支出记录</h1>
            <p data-i18n="expense-record-content">记录和查看支出信息...</p>
        </div>
        
        <div id="financial-report" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="financial-report">财务报表</h1>
            <p data-i18n="financial-report-content">生成和查看财务报表...</p>
        </div>
        
        <!-- 业绩目标页面 -->
        <div id="performance-target" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="performance-target">业绩目标</h1>
            
            <!-- 当前月份选择 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <label style="color: var(--gold); font-weight: bold;" data-i18n="select-month">选择月份：</label>
                    <select id="performance-month" onchange="displayPerformanceTargets()" style="padding: 8px 12px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                        <!-- 月份选项将动态生成 -->
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="recalculatePerformanceTargets()" style="background: var(--gold); color: var(--black); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;" data-i18n="recalculate-targets">重新计算目标</button>
                    <button onclick="resetPerformanceTargets()" style="background: #ff6666; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;" data-i18n="reset-targets">重置目标</button>
                </div>
            </div>
            
            <!-- 团队总目标 -->
            <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 30px;">
                <h2 style="color: var(--gold); margin: 0 0 20px 0; text-align: center;" data-i18n="team-target">代理店营业额目标</h2>
                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; align-items: center;">
                    <div style="text-align: center;">
                        <div style="color: #cccccc; font-size: 0.9em; margin-bottom: 5px;" data-i18n="target-label">目标</div>
                        <div id="team-target-amount" style="font-size: 1.8em; color: var(--gold); font-weight: bold;">0</div>
                        <div style="color: #aaa; font-size: 0.8em;" data-i18n="thousand-won">千韩元</div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #cccccc;" data-i18n="actual-label">实际</span>
                            <span id="team-progress-text" style="color: var(--gold); font-weight: bold;">0%</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); height: 20px; border-radius: 10px; overflow: hidden;">
                            <div id="team-progress-bar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8em; color: #aaa;">
                            <span>0</span>
                            <span id="team-target-display">0</span>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #cccccc; font-size: 0.9em; margin-bottom: 5px;" data-i18n="actual-label">实际</div>
                        <div id="team-actual-amount" style="font-size: 1.8em; color: #4CAF50; font-weight: bold;">0</div>
                        <div style="color: #aaa; font-size: 0.8em;" data-i18n="thousand-won">千韩元</div>
                    </div>
                </div>
            </div>
            
            <!-- 个人业绩目标列表 -->
            <div id="performance-list" style="margin-top: 20px;">
                <!-- 个人业绩目标将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 操作历史记录页面 -->
        <div id="operation-history" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="operation-history">操作历史记录</h1>
            
            <!-- 筛选控件 -->
            <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 5px; margin-bottom: 20px; border: 1px solid rgba(212, 175, 55, 0.3);">
                <!-- 第一行：3个下拉筛选 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="filter-by-user">按用户筛选：</label>
                        <select id="history-user-filter" onchange="filterOperationHistory()" style="width: 100%; padding: 8px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="all-users">全部用户</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="filter-by-operation">按操作类型：</label>
                        <select id="history-operation-filter" onchange="filterOperationHistory()" style="width: 100%; padding: 8px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="all-operations">全部操作</option>
                            <option value="create" data-i18n="operation-create">创建</option>
                            <option value="edit" data-i18n="operation-edit">编辑</option>
                            <option value="delete" data-i18n="operation-delete">删除</option>
                            <option value="login" data-i18n="operation-login">登录</option>
                            <option value="logout" data-i18n="operation-logout">登出</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="filter-by-object">按对象类型：</label>
                        <select id="history-object-filter" onchange="filterOperationHistory()" style="width: 100%; padding: 8px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="all-objects">全部对象</option>
                            <option value="salon" data-i18n="object-salon">沙龙</option>
                            <option value="transaction" data-i18n="object-transaction">交易</option>
                            <option value="employee" data-i18n="object-employee">职员</option>
                        </select>
                    </div>
                </div>
                <!-- 第二行：日期筛选和清空按钮 -->
                <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="filter-by-date">按日期筛选：</label>
                        <div style="display: flex; gap: 8px;">
                            <div class="date-input-wrapper" style="flex: 1;">
                                <input type="date" id="history-start-date" lang="zh-CN" onchange="filterOperationHistory()" style="width: 100%; padding: 8px; padding-right: 30px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                                <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--gold); font-size: 12px; pointer-events: none; z-index: 2;">▼</span>
                            </div>
                            <span style="color: var(--gold); align-self: center; white-space: nowrap;" data-i18n="to">至</span>
                            <div class="date-input-wrapper" style="flex: 1;">
                                <input type="date" id="history-end-date" lang="zh-CN" onchange="filterOperationHistory()" style="width: 100%; padding: 8px; padding-right: 30px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                                <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--gold); font-size: 12px; pointer-events: none; z-index: 2;">▼</span>
                            </div>
                        </div>
                    </div>
                    <div style="flex-shrink: 0;">
                        <button onclick="clearHistoryFilters()" style="min-width: 120px; background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; white-space: nowrap;" data-i18n="clear-all-filters">清空筛选</button>
                    </div>
                </div>
            </div>
            
            <div id="operation-history-list" style="margin-top: 20px;">
                <!-- 操作历史记录将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 数据对比查看页面 -->
        <div id="data-comparison" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="data-comparison">数据对比查看</h1>
            <div id="comparison-content" style="margin-top: 20px;">
                <p style="color: #cccccc; text-align: center; padding: 40px;" data-i18n="select-history-record">请从操作历史记录中选择要对比的记录</p>
            </div>
        </div>
        
        <!-- 审计报告页面 -->
        <div id="audit-report" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="audit-report">审计报告</h1>
            
            <!-- 报告统计 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.3); text-align: center;">
                    <h3 style="color: var(--gold); margin: 0 0 10px 0;" data-i18n="total-operations">总操作数</h3>
                    <div id="total-operations-count" style="font-size: 2em; color: var(--text-light); font-weight: bold;">0</div>
                </div>
                <div style="background: rgba(144, 238, 144, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(144, 238, 144, 0.3); text-align: center;">
                    <h3 style="color: #90EE90; margin: 0 0 10px 0;" data-i18n="today-operations">今日操作</h3>
                    <div id="today-operations-count" style="font-size: 2em; color: var(--text-light); font-weight: bold;">0</div>
                </div>
                <div style="background: rgba(135, 206, 235, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(135, 206, 235, 0.3); text-align: center;">
                    <h3 style="color: #87CEEB; margin: 0 0 10px 0;" data-i18n="active-users">活跃用户</h3>
                    <div id="active-users-count" style="font-size: 2em; color: var(--text-light); font-weight: bold;">0</div>
                </div>
                <div style="background: rgba(255, 182, 193, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(255, 182, 193, 0.3); text-align: center;">
                    <h3 style="color: #FFB6C1; margin: 0 0 10px 0;" data-i18n="critical-operations">重要操作</h3>
                    <div id="critical-operations-count" style="font-size: 2em; color: var(--text-light); font-weight: bold;">0</div>
                </div>
            </div>
            
            <div id="audit-report-content" style="margin-top: 20px;">
                <!-- 审计报告内容将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 审批管理页面 -->
        <div id="approval-management" class="content-area">
            <button class="back-button" onclick="backToMenu()" data-i18n="back-to-main">返回主菜单</button>
            <h1 data-i18n="approval-management">审批管理</h1>
            
            <div class="approval-controls" style="margin-bottom: 20px; padding: 20px; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.3);">
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div>
                        <label for="approvalStatusFilter" style="color: var(--gold); margin-right: 10px;" data-i18n="status">状态：</label>
                        <select id="approvalStatusFilter" onchange="displayApprovalList()" style="padding: 8px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="all-status">全部状态</option>
                            <option value="pending" data-i18n="pending">待审批</option>
                            <option value="approved" data-i18n="approved">已批准</option>
                            <option value="rejected" data-i18n="rejected">已拒绝</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="approval-list" id="approvalList">
                <!-- 审批列表将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 交易记录列表页面 -->
        <div id="transaction-list" class="content-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="back-button" onclick="backToSalonInfo()" data-i18n="back-to-salon-info">返回沙龙信息</button>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="color: var(--gold);" data-i18n="filter-by-date">按日期筛选：</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="start-date" lang="zh-CN" style="padding: 5px; padding-right: 25px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 3px; box-sizing: border-box;">
                        <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: var(--gold); font-size: 10px; pointer-events: none; z-index: 2;">▼</span>
                    </div>
                    <span style="color: var(--gold);" data-i18n="to">至</span>
                    <div class="date-input-wrapper">
                        <input type="date" id="end-date" lang="zh-CN" style="padding: 5px; padding-right: 25px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 3px; box-sizing: border-box;">
                        <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: var(--gold); font-size: 10px; pointer-events: none; z-index: 2;">▼</span>
                    </div>
                    <button onclick="filterTransactions()" style="background: var(--gold); color: var(--black); border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;" data-i18n="filter">筛选</button>
                    <button onclick="clearDateFilter()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;" data-i18n="clear-filter">清空筛选</button>
                </div>
            </div>
            <h1 id="transaction-list-title" data-i18n="transaction-records">交易记录</h1>
            <div id="transaction-records" style="margin-top: 20px;">
                <!-- 交易记录将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 交易详情页面 -->
        <div id="transaction-detail" class="content-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="back-button" onclick="backToTransactionList()" data-i18n="back-to-transaction-list">返回交易记录</button>
                <button onclick="printTransaction()" style="background: var(--gold); color: var(--black); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;" data-i18n="print">打印</button>
            </div>
            <h1 data-i18n="transaction-detail">交易详情</h1>
            <div id="transaction-detail-content" style="margin-top: 20px;">
                <!-- 交易详情将在这里动态生成 -->
            </div>
        </div>
        
        <div class="footer">
            © 2025 MAKE IT HAIR Professional. All rights reserved.
                </div>

        <!-- 批量指定负责人模态框 -->
        <div id="batchAssignModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--dark-gray); padding: 30px; border-radius: 10px; border: 1px solid var(--gold); width: 500px; max-width: 95vw; max-height: 95vh; overflow-y: auto;">
                <h2 style="color: var(--gold); margin-top: 0;" data-i18n="batch-assign-responsible">批量指定负责人</h2>
                <form id="batchAssignForm">
                    <div style="margin-bottom: 20px;">
                        <label for="batchAssignEmployee" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="select-responsible-employee">选择负责职员：</label>
                        <select id="batchAssignEmployee" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="please-select-employee">请选择职员...</option>
                        </select>
                    </div>
                    
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 20px;">
                        <p style="color: #cccccc; margin: 0; font-size: 0.9em;" data-i18n="batch-assign-tip">将为所有选中的沙龙统一指定负责人员。此操作需要管理员或经理权限。</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeBatchAssignModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="cancel">取消</button>
                        <button type="button" onclick="executeBatchAssign()" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="confirm">确认</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 编辑职员模态框 -->
        <div id="editEmployeeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--dark-gray); padding: 30px; border-radius: 10px; border: 1px solid var(--gold); width: 500px; max-width: 95vw; max-height: 95vh; overflow-y: auto;">
                <h2 style="color: var(--gold); margin-top: 0;" data-i18n="edit-employee">编辑职员信息</h2>
                <form id="editEmployeeForm">
                    <input type="hidden" id="editEmployeeId">
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editEmployeeName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-name">姓名：</label>
                        <input type="text" id="editEmployeeName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editEmployeePosition" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-position">职位：</label>
                        <select id="editEmployeePosition" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="salesperson" data-i18n="salesperson">业务员</option>
                            <option value="manager" data-i18n="manager">经理</option>
                            <option value="admin" data-i18n="admin">管理员</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editEmployeeUsername" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-username">登录账号：</label>
                        <input type="text" id="editEmployeeUsername" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editEmployeePassword" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-password">密码：</label>
                        <input type="password" id="editEmployeePassword" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;" placeholder="留空则不修改密码">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editEmployeeMobile" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="employee-mobile">手机号：</label>
                        <input type="tel" id="editEmployeeMobile" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <!-- 银行账户信息 -->
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 6px; border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 20px;">
                        <h4 style="color: var(--gold); margin: 0 0 10px 0;" data-i18n="bank-account-info">银行账户信息</h4>
                        <div style="margin-bottom: 12px;">
                            <label for="editEmployeeBankName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="bank-name">银行名称：</label>
                            <input type="text" id="editEmployeeBankName" style="width: 100%; padding: 8px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label for="editEmployeeAccountNumber" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="account-number">银行账号：</label>
                            <input type="text" id="editEmployeeAccountNumber" style="width: 100%; padding: 8px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label for="editEmployeeAccountHolder" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="account-holder">账户持有人：</label>
                            <input type="text" id="editEmployeeAccountHolder" style="width: 100%; padding: 8px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label for="editEmployeeBankBranch" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="bank-branch">开户支行（选填）：</label>
                            <input type="text" id="editEmployeeBankBranch" style="width: 100%; padding: 8px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditEmployeeModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="cancel">取消</button>
                        <button type="submit" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="save">保存</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 编辑沙龙模态框 -->
        <div id="editSalonModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--dark-gray); padding: 30px; border-radius: 10px; border: 1px solid var(--gold); width: 500px; max-width: 95vw; max-height: 95vh; overflow-y: auto;">
                <h2 style="color: var(--gold); margin-top: 0;" data-i18n="edit-salon">编辑沙龙信息</h2>
                <form id="editSalonForm">
                    <input type="hidden" id="editSalonId">
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editSalonName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-name">沙龙名称：</label>
                        <input type="text" id="editSalonName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editSalonAddress" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-address">沙龙地址：</label>
                        <input type="text" id="editSalonAddress" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editSalonDistrict" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-district">沙龙区域：</label>
                        <select id="editSalonDistrict" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="please-select-district">请选择区域...</option>
                            <option value="guro" data-i18n="guro-district">九老区</option>
                            <option value="yeongdeungpo" data-i18n="yeongdeungpo-district">永登浦区</option>
                            <option value="geumcheon" data-i18n="geumcheon-district">衿川区</option>
                            <option value="overseas" data-i18n="overseas-district">海外区域</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editSalonPhone" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salon-phone">店铺电话（选填）：</label>
                        <input type="tel" id="editSalonPhone" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editDirectorName" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="director-name">院长姓名：</label>
                        <input type="text" id="editDirectorName" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editDirectorMobile" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="director-mobile">手机：</label>
                        <input type="tel" id="editDirectorMobile" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="editResponsibleEmployee" style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="responsible-employee">负责职员：</label>
                        <select id="editResponsibleEmployee" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px;">
                            <option value="" data-i18n="please-select-employee">请选择职员...</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditSalonModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="cancel">取消</button>
                        <button type="submit" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="save">保存</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 添加交易记录模态框 -->
        <div id="transactionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--dark-gray); padding: 30px; border-radius: 10px; border: 1px solid var(--gold); width: 600px; max-width: 95vw; max-height: 95vh; overflow-y: auto;">
                <h2 style="color: var(--gold); margin-top: 0;" data-i18n="add-transaction-record">添加交易记录</h2>
                <form id="transactionForm">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salesperson-name">业务员：</label>
                        <select id="salespersonSelect" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                            <option value="" data-i18n="please-select-salesperson">请选择业务员...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 10px;" data-i18n="transaction-content">交易内容：</label>
                        
                        <!-- 产品表格 -->
                        <div style="border: 1px solid var(--gold); border-radius: 5px; overflow: hidden;">
                            <table id="productTable" style="width: 100%; border-collapse: collapse;">
                                <thead style="background: rgba(212, 175, 55, 0.2);">
                                    <tr>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: left;" data-i18n="product-name">产品名</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="unit-price">单价</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="quantity">数量</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="gift-quantity">赠送</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="total-amount">总金额</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="operation">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <!-- 产品行将在这里动态添加 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <button type="button" onclick="addProductRow()" style="background: var(--gold); color: var(--black); border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-size: 0.9em;" data-i18n="add-product">添加产品</button>
                            <div style="color: var(--gold); font-weight: bold;">
                                <span data-i18n="total-products-amount">产品总金额：</span>
                                <span id="totalProductsAmount">₩0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="received-amount">实收款：</label>
                            <input type="text" id="receivedAmount" placeholder="0,000" oninput="formatReceivedAmountAndCalculate(this)" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="current-outstanding">本次欠款：</label>
                            <input type="text" id="currentOutstanding" placeholder="0,000" readonly style="width: 100%; padding: 10px; background: rgba(100,100,100,0.3); border: 1px solid var(--gold); color: #888; border-radius: 5px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="notes">备注（选填）：</label>
                        <textarea id="transactionNotes" placeholder="其他备注信息..." style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box; height: 50px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- 产品历史交易记录 -->
                    <div id="product-history-section" style="margin-bottom: 15px; display: none;">
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="product-history">产品历史交易记录：</label>
                        <div id="product-history-display" style="max-height: 120px; overflow-y: auto; background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 5px; padding: 10px;">
                            <!-- 历史记录将在这里显示 -->
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeTransactionModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="cancel">取消</button>
                        <button type="submit" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="add">添加</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 编辑交易记录模态框 -->
        <div id="editTransactionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; justify-content: center; align-items: center;">
            <div style="background: var(--dark-gray); padding: 30px; border-radius: 10px; border: 1px solid var(--gold); width: 600px; max-width: 95vw; max-height: 95vh; overflow-y: auto;">
                <h2 style="color: var(--gold); margin-top: 0;" data-i18n="edit-transaction-record">编辑交易记录</h2>
                <form id="editTransactionForm">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="salesperson-name">业务员：</label>
                        <select id="editSalespersonSelect" style="width: 100%; padding: 10px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                            <option value="" data-i18n="please-select-salesperson">请选择业务员...</option>
                        </select>
                    </div>
                    

                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 10px;" data-i18n="transaction-content">交易内容：</label>
                        
                        <!-- 产品表格 -->
                        <div style="border: 1px solid var(--gold); border-radius: 5px; overflow: hidden;">
                            <table id="editProductTable" style="width: 100%; border-collapse: collapse;">
                                <thead style="background: rgba(212, 175, 55, 0.2);">
                                    <tr>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: left;" data-i18n="product-name">产品名</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="unit-price">单价</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="quantity">数量</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="gift-quantity">赠送</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="total-amount">总金额</th>
                                        <th style="padding: 10px; border-bottom: 1px solid var(--gold); color: var(--gold); text-align: center;" data-i18n="operation">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="editProductTableBody">
                                    <!-- 产品行将在这里动态添加 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <button type="button" onclick="addEditProductRow()" style="background: var(--gold); color: var(--black); border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-size: 0.9em;" data-i18n="add-product">添加产品</button>
                            <div style="color: var(--gold); font-weight: bold;">
                                <span data-i18n="total-products-amount">产品总金额：</span>
                                <span id="editTotalProductsAmount">₩0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="received-amount">实收款：</label>
                            <input type="text" id="editReceivedAmount" placeholder="0,000" oninput="formatEditReceivedAmountAndCalculate(this)" style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="current-outstanding">本次欠款：</label>
                            <input type="text" id="editCurrentOutstanding" placeholder="0,000" readonly style="width: 100%; padding: 10px; background: rgba(100,100,100,0.3); border: 1px solid var(--gold); color: #888; border-radius: 5px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--gold); margin-bottom: 5px;" data-i18n="notes">备注（选填）：</label>
                        <textarea id="editTransactionNotes" placeholder="其他备注信息..." style="width: 100%; padding: 10px; background: transparent; border: 1px solid var(--gold); color: var(--text-light); border-radius: 5px; box-sizing: border-box; height: 50px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditTransactionModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="cancel">取消</button>
                        <button type="submit" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;" data-i18n="save">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // 语言系统
        let currentLanguage = 'zh'; // 默认语言为中文
        
        const translations = {
            zh: {
                // 系统信息
                'store-name': 'Mesia首尔西部地区分店管理系统',
                // 区域管理
                'salon-district': '沙龙区域：',
                'please-select-district': '请选择区域...',
                'guro-district': '九老区',
                'yeongdeungpo-district': '永登浦区',
                'geumcheon-district': '衿川区',
                'overseas-district': '海外区域',
                'all-districts': '全部区域',
                'filter-by-district': '按区域筛选：',
        'filter-by-responsible': '按负责人员：',
        'all-employees': '全部人员',
                // 主菜单
                'customer-management': '客户信息管理',
                'customer-management-desc': '管理客户资料、交易记录、服务历史等信息',
                'new-salon': '新增沙龙',
                'new-salon-desc': '添加新的沙龙客户信息',
                'salon-info': '沙龙信息',
                'salon-info-desc': '查看和编辑现有沙龙信息',
                'delete-salon': '删除沙龙',
                'delete-salon-desc': '删除不需要的沙龙客户',
                'product-management': '产品信息管理',
                'product-management-desc': '管理美发产品目录、库存、价格等信息',
                'add-product': '新增产品',
                'add-product-desc': '添加新的美发产品',
                'product-list': '产品列表',
                'product-list-desc': '查看所有产品信息',
                'product-category': '产品分类',
                'product-category-desc': '管理产品分类',
                'inventory-management': '库存信息管理',
                'inventory-management-desc': '跟踪产品库存、补货预警、使用记录等',
                'stock-check': '库存盘点',
                'stock-check-desc': '检查当前库存状态',
                'restock-alert': '补货提醒',
                'restock-alert-desc': '设置库存预警',
                'usage-record': '使用记录',
                'usage-record-desc': '查看产品使用历史',
                'finance-management': '财务信息管理',
                'finance-management-desc': '管理收支记录、服务收入、产品销售等',
                'income-record': '收入记录',
                'income-record-desc': '记录服务和销售收入',
                'expense-record': '支出记录',
                'expense-record-desc': '记录各项支出',
                'financial-report': '财务报表',
                'financial-report-desc': '生成财务分析报告',
                'performance-target': '业绩目标',
                'performance-target-desc': '管理个人和团队业绩目标',
                'select-month': '选择月份：',
                'recalculate-targets': '重新计算目标',
                'reset-targets': '重置目标',
                'team-target': '代理店营业额目标',
                'target-label': '目标',
                'actual-label': '实际',
                'thousand-won': '千韩元',
                'individual-targets': '个人业绩目标',
                'employee-name-column': '职员姓名',
                'monthly-target': '月度目标',
                'monthly-actual': '月度实际',
                'progress-rate': '进度率(%)',
                'last-month-performance': '上月业绩',
                'target-adjustment': '目标调整',
                        'target-increased': '目标上调10%',
        'target-maintained': '目标保持',
        'target-recalculation-complete': '目标重新计算完成！共有 {count} 名员工的目标被上调。',
        'confirm-reset-targets': '确定要将所有员工的目标重置为200万韩元吗？',
        'targets-reset-complete': '所有目标已重置为200万韩元！',
                'auto-calculate': '自动计算',
                'manual-adjust': '手动调整',
                // 通用按钮
                'back-to-main': '返回主菜单',
                'add': '添加',
                'delete': '删除',
                'cancel': '取消',
                'close': '关闭',
                'confirm': '确认',
                'no-data': '无数据',
                'records': '条记录',
                'not-set': '未设置',
                // 操作描述翻译
                'operation-desc-homepage-navigation': '通过点击Logo返回首页',
                'operation-desc-system-logout': '系统登出',
                'operation-desc-user-logout': '用户 {user} ({position}) 登出系统',
                'operation-desc-create-salon': '创建新沙龙：{name}，院长：{director}',
                'operation-desc-delete-salon': '删除沙龙：{name}，院长：{director}',
                'operation-desc-edit-employee': '编辑职员信息：{name}',
                // 对象名称翻译
                'object-name-home-navigation': '首页导航',
                'object-name-system-logout': '系统登出',
                // 数据字段翻译
                'field-name': '姓名',
                'field-position': '职位',
                'field-username': '用户名',
                'field-password': '密码',
                'field-mobile': '手机号',
                'field-createTime': '创建时间',
                'field-bankInfo': '银行信息',
                'field-bankName': '银行名称',
                'field-accountNumber': '账号',
                'field-accountHolder': '账户持有人',
                'field-bankBranch': '开户支行',
                'field-id': 'ID',
                'field-address': '地址',
                'field-district': '区域',
                'field-phone': '电话',
                'field-directorName': '院长姓名',
                'field-directorMobile': '院长手机',
                'field-responsibleEmployeeId': '负责员工ID',
                'field-addTime': '新增时间',
                'field-joinDate': '加入日期',
                'field-transactions': '交易记录',
                'field-lastTransactionDate': '最后交易日期',
                // 表单相关
                'salon-name': '沙龙名称：',
                'salon-address': '沙龙地址：',
                'salon-phone': '店铺电话：',
                'director-name': '院长姓名：',
                'director-mobile': '手机：',
                'transaction-desc': '交易描述：',
                'transaction-amount': '交易金额（选填）：',
                'add-transaction-record': '添加交易记录',
                // 状态文本
                'no-salon-info': '暂无沙龙信息',
                'add-salon-tip': '请前往"新增沙龙"页面添加沙龙信息',
                'active-customer': '活跃客户',
                'needs-attention': '需要关注',
                'long-inactive': '长期未交易',
                'no-transaction': '无交易记录',
                'recent-transactions': '近期交易记录',
                'no-transactions': '暂无交易记录',
                'first-join': '首次加入',
                'last-transaction': '最后交易',
                'transaction-count': '交易记录总数',
                'days-since-last': '距上次交易',
                // 其他界面文本
                'salon-info-list-desc': '这里显示所有已添加的沙龙详细信息列表。',
                'delete-warning': '⚠️ 删除操作无法撤销，请谨慎操作！',
                'select-salon-to-delete': '选择要删除的沙龙',
                'please-select-salon': '请选择沙龙...',
                'confirm-delete': '确认删除',
                // 内容页面描述
                'add-product-content': '在这里添加新的美发产品信息...',
                'product-list-content': '显示所有产品的列表...',
                'product-category-content': '管理产品分类信息...',
                'stock-check-content': '进行库存盘点操作...',
                'restock-alert-content': '设置和查看补货提醒...',
                'usage-record-content': '查看产品使用记录...',
                'income-record-content': '记录和查看收入信息...',
                'expense-record-content': '记录和查看支出信息...',
                'financial-report-content': '生成和查看财务报表...',
                // 动态内容标签
                'salon-address-label': '沙龙地址',
                'salon-phone-label': '店铺电话',
                'director-name-label': '院长姓名',
                'director-mobile-label': '院长手机',
                'first-join-label': '首次加入',
                'status-label': '状态',
                'status-active': '活跃',
                'days-since-last-label': '距上次交易',
                'transaction-count-label': '交易记录总数',
                'last-transaction-label': '最后交易',
                'recent-transactions-label': '近期交易记录',
                'add-transaction-btn': '添加交易',
                'delete-btn': '删除',
                'days-unit': '天',
                'transaction-unit': '笔',
                'transaction-default': '交易',
                'more-records': '还有 {count} 条历史记录...',
                // 提示和确认消息
                'salon-added-success': '沙龙信息已成功添加！',
                'salon-name-text': '沙龙名称',
                'salon-address-text': '沙龙地址',
                'salon-phone-text': '店铺电话',
                'director-name-text': '院长姓名',
                'director-mobile-text': '院长手机',
                'fill-required-fields': '请填写所有必填字段！（店铺电话为选填）',
                'confirm-delete-salon': '确定要删除沙龙"{name}"吗？\n此操作无法撤销！',
                'salon-deleted-success': '沙龙已成功删除！',
                'select-salon-first': '请先选择要删除的沙龙！',
                'transaction-added-success': '交易记录已成功添加！',
                'fill-transaction-desc': '请填写交易描述！',
                // 新功能翻译
                'search-salon-placeholder': '搜索沙龙名、院长名或手机号...',
                'clear-search': '清空',
                'back-to-salon-info': '返回沙龙信息',
                'filter-by-date': '按日期筛选：',
                'to': '至',
                'filter': '筛选',
                'clear-filter': '清空筛选',
                'transaction-records': '交易记录',
                'back-to-transaction-list': '返回交易记录',
                'print': '打印',
                'transaction-detail': '交易详情',
                'products': '产品：',
                'receivable-amount': '应收款：',
                'received-amount': '实收款：',
                'outstanding-amount': '欠款：',
                'notes': '备注（选填）：',
                'view-all-transactions': '查看全部交易',
                'click-to-view-detail': '点击查看详情',
                'transaction-date': '交易日期',
                'transaction-amount-label': '交易金额',
                'no-transactions-found': '未找到符合条件的交易记录',
                'total-transactions': '共 {count} 笔交易',
                'print-transaction-title': '交易记录详情',
                'no-matching-salons': '未找到匹配的沙龙',
                'select-start-end-date': '请选择开始和结束日期',
                // 新的产品表格相关翻译
                'transaction-content': '交易内容：',
                'product-name': '产品名',
                'unit-price': '单价',
                'quantity': '数量',
                'total-amount': '总金额',
                'operation': '操作',
                'add-product': '添加产品',
                'total-products-amount': '产品总金额：',
                'current-outstanding': '本次欠款：',
                'remove': '删除',
                'total-outstanding': '累计欠款：',
                'copy-for-director': '院长留存联',
                'copy-for-agent': '代理店留存联',
                'historical-outstanding': '历史欠款：',
                'add-at-least-one-product': '请至少添加一个产品！',
                // 职员管理相关翻译
                'employee-management': '职员管理',
                'employee-management-desc': '管理业务员信息、权限和账号',
                'new-employee': '新增职员',
                'new-employee-desc': '添加新的业务员账号',
                'employee-list': '职员列表',
                'employee-list-desc': '查看和编辑职员信息',
                'delete-employee': '删除职员',
                'delete-employee-desc': '删除不需要的职员账号',
                'employee-name': '姓名：',
                'employee-position': '职位：',
                'employee-username': '登录账号：',
                'employee-password': '密码：',
                'employee-mobile': '手机号：',
                'bank-account-info': '银行账户信息',
                'bank-name': '银行名称：',
                'account-number': '银行账号：',
                'account-holder': '账户持有人：',
                'bank-branch': '开户支行（选填）：',
                'batch-upload-salons': '批量上传沙龙',
                'batch-upload-description': '上传包含沙龙信息的Excel表格文件。格式要求：第1行为表格标题，第2行为列标题（必须包含沙龙名称和地址列），第3行开始为实际数据。系统将根据地址关键字自动设置区域。',
                        'select-file': '选择文件：',
        'choose-file': '选择文件',
        'no-file-selected': '未选择文件',
        'process-file': '处理文件',
        'download-sample': '下载样例模板',
                'preview-data': '数据预览：',
                'confirm-batch-create': '确认批量创建',
                'file-processed-success': '文件处理成功！共识别到 {count} 个沙龙记录。',
                'batch-create-success': '批量创建成功！共创建了 {count} 个沙龙。',
                'file-processing-error': '文件处理出错：{error}',
                'no-valid-data': '未找到有效的沙龙数据，请检查文件格式。',
                'select-file-first': '请先选择文件！',
                'unsupported-file-type': '不支持的文件类型，请选择Excel文件（.xlsx或.xls）。',
                'salesperson': '业务员',
                'manager': '经理',
                'admin': '管理员',
                'select-employee-to-delete': '选择要删除的职员',
                'please-select-employee': '请选择职员...',
                'employee-added-success': '职员已成功添加！',
                'employee-deleted-success': '职员已成功删除！',
                'username-already-exists': '登录账号已存在，请使用其他账号！',
                'fill-all-employee-fields': '请填写所有职员信息！',
                'confirm-delete-employee': '确定要删除职员"{name}"吗？\n此操作无法撤销！',
                'select-employee-first': '请先选择要删除的职员！',
                'salesperson-name': '业务员：',
                'please-select-salesperson': '请选择业务员...',
                'edit-employee': '编辑职员信息',
                'edit-btn': '编辑',
                'save': '保存',
                'employee-updated-success': '职员信息已成功更新！',
                'username-already-exists-edit': '该登录账号已被其他职员使用，请使用其他账号！',
                'fill-employee-basic-info': '请填写所有必填信息（姓名、账号、手机号）！',
                'cannot-edit-admin-permission': '经理无权修改管理员权限！',
                'gift-quantity': '赠送',
                'salesperson-mobile': '业务员手机',
                        'salesperson-label': '业务员',
        'unassigned': '未指定',
        'create-time': '创建时间',
        'permission-level': '权限级别',
        'status-normal': '正常',
                'agent-store-name': '代理店名称',
                'edit-transaction': '编辑交易',
            'delete-transaction': '删除交易',
            'confirm-delete-transaction': '确认删除此交易记录吗？这个操作无法撤销！',
            'transaction-deleted-success': '交易记录已成功删除！',
                'edit-transaction-record': '编辑交易记录',
                'transaction-updated-success': '交易记录已成功更新！',
                'edit-salon': '编辑沙龙信息',
                'salon-updated-success': '沙龙信息已成功更新！',
                'fill-salon-basic-info': '请填写所有必填信息（沙龙名称、地址、区域、院长姓名、院长手机）！',
                // 操作历史相关翻译
                'audit-management': '操作历史管理',
                'audit-management-desc': '管理系统操作记录、数据审计和安全监控',
                'operation-history': '操作历史记录',
                'operation-history-desc': '查看所有用户的操作历史和数据变更记录',
                'data-comparison': '数据对比查看',
                'data-comparison-desc': '对比查看修改前后的数据变化',
                'audit-report': '审计报告',
                'audit-report-desc': '生成操作统计和安全审计报告',
                'filter-by-user': '按用户筛选：',
                'filter-by-operation': '按操作类型：',
                'filter-by-object': '按对象类型：',
                'all-users': '全部用户',
                'all-operations': '全部操作',
                'all-objects': '全部对象',
                'operation-create': '创建',
                'operation-edit': '编辑',
                'operation-delete': '删除',
                'operation-login': '登录',
                'operation-logout': '登出',
                'operation-navigation': '页面导航',
                'object-salon': '沙龙',
                'object-transaction': '交易',
                'object-employee': '职员',
                'clear-all-filters': '清空筛选',
                'select-history-record': '请从操作历史记录中选择要对比的记录',
                'total-operations': '总操作数',
                'today-operations': '今日操作',
                'active-users': '活跃用户',
                'critical-operations': '重要操作',
                'operation-time': '操作时间',
                'operator': '操作人',
                'operation-type': '操作类型',
                'object-type': '对象类型',
                'object-name': '对象名称',
                'operation-description': '操作描述',
                'view-details': '查看详情',
                'compare-data': '数据对比',
                'data-before': '修改前',
                'data-after': '修改后',
                'no-operation-history': '暂无操作历史记录',
                'operation-details': '操作详情',
                'ip-address': 'IP地址',
                'browser-info': '浏览器信息',
                'user-operation-stats': '用户操作统计',
                'user': '用户',
                'total': '总操作数',
                'create-count': '创建',
                'edit-count': '编辑', 
                'delete-count': '删除',
                'login-count': '登录',
                'recent-critical-operations': '最近重要操作记录',
                'no-critical-operations': '暂无重要操作记录',
                'details': '详情',
                'unknown-user': '未知用户',
                'logout': '退出登录',
                'confirm-logout': '确认退出登录吗？',
                'no-permission-delete-salon': '您没有权限删除沙龙！只有管理员可以执行此操作。',
                'no-permission-delete-employee': '您没有权限删除职员！只有管理员可以执行此操作。',
                'no-permission-delete-transaction': '您没有权限删除交易记录！只有管理员可以执行此操作。',
                'no-salesperson-salons': '您还没有负责的沙龙',
                'salesperson-salon-tip': '当您在沙龙中产生交易记录后，该沙龙就会出现在这里',
                'responsible-employee': '负责职员',
                'business-license': '营业执照号码',
                'product-history': '产品历史交易记录',
                'please-select-employee': '请选择职员...',
                'approval-required': '操作需要管理员审批',
                'approval-submitted': '操作已提交，等待管理员审批',
                'approval-approved': '操作已获得审批',
                'approval-rejected': '操作被管理员拒绝',
                'pending-approvals': '待审批操作',
                'no-pending-approvals': '暂无待审批操作',
                'approve': '批准',
                'reject': '拒绝',
                'approval-reason': '审批意见',
                'approval-management': '审批管理',
                'approval-management-desc': '处理待审批的操作请求',
                'all-status': '全部状态',
                'pending': '待审批',
                'approved': '已批准',
                'rejected': '已拒绝',
                'request-time': '申请时间',
                'requester': '申请人',
                'operation-type': '操作类型',
                'operation-description': '操作描述',
                'process-time': '处理时间',
                'processor': '处理人',
                'approval-actions': '操作',
                'enter-approval-reason': '请输入审批意见',
                'approval-reason-required': '请填写审批意见',
                'approval-processed-success': '审批处理完成',
                // 批量操作相关翻译
                'select-all': '全选',
                'batch-delete': '批量删除',
                'batch-assign': '批量指定负责人',
                'selected-count': '已选择 {count} 个沙龙',
                'no-salons-selected': '请先选择要操作的沙龙！',
                'confirm-batch-delete': '确定要删除选中的 {count} 个沙龙吗？\n沙龙列表：{names}\n此操作无法撤销！',
                'batch-delete-success': '批量删除成功！共删除了 {count} 个沙龙。',
                'batch-assign-responsible': '批量指定负责人',
                'select-responsible-employee': '选择负责职员：',
                'batch-assign-tip': '将为所有选中的沙龙统一指定负责人员。此操作需要管理员或经理权限。',
                'batch-assign-success': '批量指定成功！共为 {count} 个沙龙指定了负责人：{employee}',
                'all-districts': '全部区域',
                        'total-salons-count': '总计 {count} 家沙龙',
        'district-salons-count': '共 {count} 家沙龙',
        'sort-by': '排序方式：',
        'sort-name': '沙龙名称 ↑',
        'sort-address': '地址名称 ↑',
        'sort-add-time': '新增时间 ↑',
        'sort-last-transaction': '最后交易 ↑',
        'sort-outstanding-days': '欠款天数 ↑',
        'sort-outstanding-amount': '欠款金额 ↑',
        'sort-default': '默认排序',
        'items-per-page': '每页显示：',
        'items': '条',
                'district-other': '海外地区',
                'district-guro': '九老区',
                'district-yeongdeungpo': '永登浦区',
                'district-geumcheon': '衿川区',
                'loading': '加载中',
                'unassigned': '未指定',
                'salon-name-required': '请填写沙龙名称！',
                // 分页控件
                'first-page': '首页',
                'prev-page': '上一页',
                'next-page': '下一页',
                'last-page': '末页',
                'page-info': '第 {current} 页 / 共 {total} 页 ({items} 个项目)',
                'go-to-page': '跳转到第',
                'jump': '跳转',
                'invalid-page-number': '无效的页码！请输入1到{max}之间的数字。',
                // 操作描述
                'batch-assign-description': '批量指定负责人：将{salons}（共{count}个沙龙）的负责人设为{employee}'
            },
            ko: {
                // 시스템 정보
                'store-name': '메시아서부지점관리시스템',
                // 지역 관리
                'salon-district': '살롱 지역：',
                'please-select-district': '지역을 선택해주세요...',
                'guro-district': '구로구',
                'yeongdeungpo-district': '영등포구',
                'geumcheon-district': '금천구',
                'overseas-district': '해외지역',
                'all-districts': '전체 지역',
                'filter-by-district': '지역별 필터링：',
        'filter-by-responsible': '담당자별：',
        'all-employees': '모든 직원',
                // 주 메뉴
                'customer-management': '고객 정보 관리',
                'customer-management-desc': '고객 자료, 거래 기록, 서비스 이력 등 정보 관리',
                'new-salon': '새 살롱 추가',
                'new-salon-desc': '새로운 살롱 고객 정보 추가',
                'salon-info': '살롱 정보',
                'salon-info-desc': '기존 살롱 정보 조회 및 편집',
                'delete-salon': '살롱 삭제',
                'delete-salon-desc': '불필요한 살롱 고객 삭제',
                'product-management': '제품 정보 관리',
                'product-management-desc': '헤어 제품 목록, 재고, 가격 등 정보 관리',
                'add-product': '새 제품 추가',
                'add-product-desc': '새로운 헤어 제품 추가',
                'product-list': '제품 목록',
                'product-list-desc': '모든 제품 정보 조회',
                'product-category': '제품 분류',
                'product-category-desc': '제품 분류 관리',
                'inventory-management': '재고 정보 관리',
                'inventory-management-desc': '제품 재고 추적, 보충 알림, 사용 기록 등',
                'stock-check': '재고 확인',
                'stock-check-desc': '현재 재고 상태 확인',
                'restock-alert': '보충 알림',
                'restock-alert-desc': '재고 경고 설정',
                'usage-record': '사용 기록',
                'usage-record-desc': '제품 사용 이력 조회',
                'finance-management': '재무 정보 관리',
                'finance-management-desc': '수익 기록, 서비스 수입, 제품 판매 등 관리',
                'income-record': '수입 기록',
                'income-record-desc': '서비스 및 판매 수입 기록',
                'expense-record': '지출 기록',
                'expense-record-desc': '각종 지출 기록',
                'financial-report': '재무 보고서',
                'financial-report-desc': '재무 분석 보고서 생성',
                'performance-target': '실적 목표',
                'performance-target-desc': '개인 및 팀 실적 목표 관리',
                'select-month': '월 선택：',
                'recalculate-targets': '목표 재계산',
                'reset-targets': '목표 초기화',
                'team-target': '대리점 매출 목표',
                'target-label': '목표',
                'actual-label': '실적',
                'thousand-won': '천원',
                'individual-targets': '개인 실적 목표',
                'employee-name-column': '직원명',
                'monthly-target': '월 목표',
                'monthly-actual': '월 실적',
                'progress-rate': '진도율(%)',
                'last-month-performance': '전월 실적',
                'target-adjustment': '목표 조정',
                'target-increased': '목표 10% 증가',
                'target-maintained': '목표 유지',
                'target-recalculation-complete': '목표 재계산 완료! 총 {count}명의 직원 목표가 상향 조정되었습니다.',
                'confirm-reset-targets': '모든 직원의 목표를 200만원으로 재설정하시겠습니까?',
                'targets-reset-complete': '모든 목표가 200만원으로 재설정되었습니다!',
                'auto-calculate': '자동 계산',
                'manual-adjust': '수동 조정',
                // 공통 버튼
                'back-to-main': '메인 메뉴로 돌아가기',
                'add': '추가',
                'delete': '삭제',
                'cancel': '취소',
                'close': '닫기',
                'confirm': '확인',
                'no-data': '데이터 없음',
                'records': '개 기록',
                'not-set': '설정되지 않음',
                // 작업 설명 번역
                'operation-desc-homepage-navigation': '로고 클릭으로 홈페이지 돌아가기',
                'operation-desc-system-logout': '시스템 로그아웃',
                'operation-desc-user-logout': '사용자 {user} ({position}) 시스템 로그아웃',
                'operation-desc-create-salon': '새 살롱 생성：{name}，원장：{director}',
                'operation-desc-delete-salon': '살롱 삭제：{name}，원장：{director}',
                'operation-desc-edit-employee': '직원 정보 편집：{name}',
                // 객체 이름 번역
                'object-name-home-navigation': '홈페이지 내비게이션',
                'object-name-system-logout': '시스템 로그아웃',
                // 데이터 필드 번역
                'field-name': '이름',
                'field-position': '직위',
                'field-username': '사용자명',
                'field-password': '비밀번호',
                'field-mobile': '휴대폰',
                'field-createTime': '생성 시간',
                'field-bankInfo': '은행 정보',
                'field-bankName': '은행명',
                'field-accountNumber': '계좌번호',
                'field-accountHolder': '계좌 소유자',
                'field-bankBranch': '개설 지점',
                'field-id': 'ID',
                'field-address': '주소',
                'field-district': '지역',
                'field-phone': '전화번호',
                'field-directorName': '원장명',
                'field-directorMobile': '원장 휴대폰',
                'field-responsibleEmployeeId': '담당 직원 ID',
                'field-addTime': '추가 시간',
                'field-joinDate': '가입 날짜',
                'field-transactions': '거래 기록',
                'field-lastTransactionDate': '마지막 거래 날짜',
                // 양식 관련
                'salon-name': '살롱 이름：',
                'salon-address': '살롱 주소：',
                'salon-phone': '매장 전화번호：',
                'director-name': '원장 이름：',
                'director-mobile': '휴대폰：',
                'transaction-desc': '거래 설명：',
                'transaction-amount': '거래 금액 (선택사항)：',
                'add-transaction-record': '거래 기록 추가',
                // 상태 텍스트
                'no-salon-info': '살롱 정보가 없습니다',
                'add-salon-tip': '"새 살롱 추가" 페이지에서 살롱 정보를 추가해주세요',
                'active-customer': '활성 고객',
                'needs-attention': '주의 필요',
                'long-inactive': '장기 미거래',
                'no-transaction': '거래 기록 없음',
                'recent-transactions': '최근 거래 기록',
                'no-transactions': '거래 기록이 없습니다',
                'first-join': '최초 가입',
                'last-transaction': '최근 거래',
                'transaction-count': '총 거래 기록',
                'days-since-last': '마지막 거래 후',
                // 기타 인터페이스 텍스트
                'salon-info-list-desc': '추가된 모든 살롱의 상세 정보 목록이 여기에 표시됩니다.',
                'delete-warning': '⚠️ 삭제 작업은 되돌릴 수 없습니다. 신중하게 진행해주세요!',
                'select-salon-to-delete': '삭제할 살롱 선택',
                'please-select-salon': '살롱을 선택해주세요...',
                'confirm-delete': '삭제 확인',
                // 컨텐츠 페이지 설명
                'add-product-content': '여기에 새로운 헤어 제품 정보를 추가합니다...',
                'product-list-content': '모든 제품의 목록을 표시합니다...',
                'product-category-content': '제품 분류 정보를 관리합니다...',
                'stock-check-content': '재고 확인 작업을 수행합니다...',
                'restock-alert-content': '보충 알림을 설정하고 확인합니다...',
                'usage-record-content': '제품 사용 기록을 확인합니다...',
                'income-record-content': '수입 정보를 기록하고 확인합니다...',
                'expense-record-content': '지출 정보를 기록하고 확인합니다...',
                'financial-report-content': '재무 보고서를 생성하고 확인합니다...',
                // 동적 컨텐츠 라벨
                'salon-address-label': '살롱 주소',
                'salon-phone-label': '매장 전화',
                'director-name-label': '원장 이름',
                'director-mobile-label': '원장 휴대폰',
                'first-join-label': '최초 가입',
                'status-label': '상태',
                'status-active': '활성',
                'days-since-last-label': '마지막 거래 후',
                'transaction-count-label': '총 거래 기록',
                'last-transaction-label': '최근 거래',
                'recent-transactions-label': '최근 거래 기록',
                'add-transaction-btn': '거래 추가',
                'delete-btn': '삭제',
                'days-unit': '일',
                'transaction-unit': '건',
                'transaction-default': '거래',
                'more-records': '추가로 {count}개의 기록이 더 있습니다...',
                // 알림 및 확인 메시지
                'salon-added-success': '살롱 정보가 성공적으로 추가되었습니다!',
                'salon-name-text': '살롱 이름',
                'salon-address-text': '살롱 주소',
                'salon-phone-text': '매장 전화',
                'director-name-text': '원장 이름',
                'director-mobile-text': '원장 휴대폰',
                'fill-required-fields': '모든 필수 항목을 입력해주세요! (매장 전화는 선택사항)',
                'confirm-delete-salon': '살롱 "{name}"을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다!',
                'salon-deleted-success': '살롱이 성공적으로 삭제되었습니다!',
                'select-salon-first': '먼저 삭제할 살롱을 선택해주세요!',
                'transaction-added-success': '거래 기록이 성공적으로 추가되었습니다!',
                'fill-transaction-desc': '거래 설명을 입력해주세요!',
                // 새로운 기능 번역
                'search-salon-placeholder': '살롱명, 원장명 또는 휴대폰 번호 검색...',
                'clear-search': '지우기',
                'back-to-salon-info': '살롱 정보로 돌아가기',
                'filter-by-date': '날짜별 필터링：',
                'to': '에서',
                'filter': '필터',
                'clear-filter': '필터 지우기',
                'transaction-records': '거래 기록',
                'back-to-transaction-list': '거래 기록으로 돌아가기',
                'print': '인쇄',
                'transaction-detail': '거래 상세정보',
                'products': '제품：',
                'receivable-amount': '미수금：',
                'received-amount': '실수금：',
                'outstanding-amount': '외상：',
                'notes': '비고 (선택사항)：',
                'view-all-transactions': '모든 거래 보기',
                'click-to-view-detail': '상세정보 보기',
                'transaction-date': '거래 날짜',
                'transaction-amount-label': '거래 금액',
                'no-transactions-found': '조건에 맞는 거래 기록이 없습니다',
                'total-transactions': '총 {count}건의 거래',
                'print-transaction-title': '거래 기록 상세정보',
                'no-matching-salons': '일치하는 살롱을 찾을 수 없습니다',
                'select-start-end-date': '시작 날짜와 종료 날짜를 선택해주세요',
                // 새로운 제품 테이블 관련 번역
                'transaction-content': '거래 내용：',
                'product-name': '제품명',
                'unit-price': '단가',
                'quantity': '수량',
                'total-amount': '총금액',
                'operation': '작업',
                'add-product': '제품 추가',
                'total-products-amount': '제품 총금액：',
                'current-outstanding': '이번 외상：',
                'remove': '삭제',
                'total-outstanding': '누적 외상：',
                'copy-for-director': '원장 보관용',
                'copy-for-agent': '대리점 보관용',
                'historical-outstanding': '이전 외상：',
                'add-at-least-one-product': '최소 하나의 제품을 추가해주세요!',
                // 직원 관리 관련 번역
                'employee-management': '직원 관리',
                'employee-management-desc': '영업사원 정보, 권한 및 계정 관리',
                'new-employee': '새 직원 추가',
                'new-employee-desc': '새로운 영업사원 계정 추가',
                'employee-list': '직원 목록',
                'employee-list-desc': '직원 정보 조회 및 편집',
                'delete-employee': '직원 삭제',
                'delete-employee-desc': '불필요한 직원 계정 삭제',
                'employee-name': '이름：',
                'employee-position': '직위：',
                'employee-username': '로그인 계정：',
                'employee-password': '비밀번호：',
                'employee-mobile': '휴대폰：',
                'bank-account-info': '은행 계좌 정보',
                'bank-name': '은행명：',
                'account-number': '계좌번호：',
                'account-holder': '계좌 소유자：',
                'bank-branch': '개설 지점 (선택사항)：',
                'batch-upload-salons': '살롱 일괄 업로드',
                'batch-upload-description': '살롱 정보가 포함된 Excel 표 파일을 업로드하세요. 형식 요구사항: 1행은 표 제목, 2행은 열 제목(살롱 이름 및 주소 열 포함 필수), 3행부터 실제 데이터. 시스템이 주소 키워드에 따라 자동으로 지역을 설정합니다.',
                        'select-file': '파일 선택：',
        'choose-file': '파일 선택',
        'no-file-selected': '파일이 선택되지 않음',
        'process-file': '파일 처리',
        'download-sample': '샘플 템플릿 다운로드',
                'preview-data': '데이터 미리보기：',
                'confirm-batch-create': '일괄 생성 확인',
                'file-processed-success': '파일 처리 성공! 총 {count}개의 살롱 기록이 식별되었습니다.',
                'batch-create-success': '일괄 생성 성공! 총 {count}개의 살롱이 생성되었습니다.',
                'file-processing-error': '파일 처리 오류: {error}',
                'no-valid-data': '유효한 살롱 데이터를 찾을 수 없습니다. 파일 형식을 확인해주세요.',
                'select-file-first': '먼저 파일을 선택해주세요!',
                'unsupported-file-type': '지원되지 않는 파일 형식입니다. Excel 파일(.xlsx 또는 .xls)을 선택해주세요.',
                'salesperson': '영업사원',
                'manager': '매니저',
                'admin': '관리자',
                'select-employee-to-delete': '삭제할 직원 선택',
                'please-select-employee': '직원을 선택해주세요...',
                'employee-added-success': '직원이 성공적으로 추가되었습니다!',
                'employee-deleted-success': '직원이 성공적으로 삭제되었습니다!',
                'username-already-exists': '로그인 계정이 이미 존재합니다. 다른 계정을 사용해주세요!',
                'fill-all-employee-fields': '모든 직원 정보를 입력해주세요!',
                'confirm-delete-employee': '직원 "{name}"을(를) 삭제하시겠습니까?\n이 작업은 취소할 수 없습니다!',
                'select-employee-first': '먼저 삭제할 직원을 선택해주세요!',
                'salesperson-name': '영업사원：',
                'please-select-salesperson': '영업사원을 선택해주세요...',
                'edit-employee': '직원 정보 편집',
                'edit-btn': '편집',
                'save': '저장',
                'employee-updated-success': '직원 정보가 성공적으로 업데이트되었습니다!',
                'username-already-exists-edit': '해당 로그인 계정이 다른 직원에 의해 사용 중입니다. 다른 계정을 사용해주세요!',
                'fill-employee-basic-info': '모든 필수 정보를 입력해주세요 (이름, 계정, 휴대폰 번호)!',
                'cannot-edit-admin-permission': '매니저는 관리자 권한을 수정할 수 없습니다!',
                'gift-quantity': '증정',
                'salesperson-mobile': '영업사원 휴대폰',
                                'salesperson-label': '영업사원',
        'unassigned': '미지정',
        'create-time': '생성 시간',
        'permission-level': '권한 등급',
        'status-normal': '정상',
                'agent-store-name': '대리점명',
                'edit-transaction': '거래 편집',
            'delete-transaction': '거래 삭제',
            'confirm-delete-transaction': '이 거래 기록을 삭제하시겠습니까? 이 작업은 취소할 수 없습니다!',
            'transaction-deleted-success': '거래 기록이 성공적으로 삭제되었습니다!',
                'edit-transaction-record': '거래 기록 편집',
                'transaction-updated-success': '거래 기록이 성공적으로 업데이트되었습니다!',
                'edit-salon': '살롱 정보 편집',
                'salon-updated-success': '살롱 정보가 성공적으로 업데이트되었습니다!',
                'fill-salon-basic-info': '모든 필수 정보를 입력해주세요 (살롱명, 주소, 지역, 원장명, 원장 휴대폰)!',
                // 操作历史相关翻译
                'audit-management': '운영 기록 관리',
                'audit-management-desc': '시스템 운영 기록, 데이터 감사 및 보안 모니터링 관리',
                'operation-history': '운영 기록 이력',
                'operation-history-desc': '모든 사용자의 운영 기록과 데이터 변경 기록 보기',
                'data-comparison': '데이터 비교 보기',
                'data-comparison-desc': '수정 전후 데이터 변화 비교 보기',
                'audit-report': '감사 보고서',
                'audit-report-desc': '운영 통계 및 보안 감사 보고서 생성',
                'filter-by-user': '사용자별 필터링：',
                'filter-by-operation': '운영 유형별：',
                'filter-by-object': '객체 유형별：',
                'all-users': '모든 사용자',
                'all-operations': '모든 운영',
                'all-objects': '모든 객체',
                'operation-create': '생성',
                'operation-edit': '편집',
                'operation-delete': '삭제',
                'operation-login': '로그인',
                'operation-logout': '로그아웃',
                'operation-navigation': '페이지 탐색',
                'object-salon': '살롱',
                'object-transaction': '거래',
                'object-employee': '직원',
                'clear-all-filters': '모든 필터 지우기',
                'select-history-record': '운영 기록 이력에서 비교할 기록을 선택하세요',
                'total-operations': '총 운영 수',
                'today-operations': '오늘 운영',
                'active-users': '활성 사용자',
                'critical-operations': '중요 운영',
                'operation-time': '운영 시간',
                'operator': '운영자',
                'operation-type': '운영 유형',
                'object-type': '객체 유형',
                'object-name': '객체 이름',
                'operation-description': '운영 설명',
                'view-details': '세부 정보 보기',
                'compare-data': '데이터 비교',
                'data-before': '수정 전',
                'data-after': '수정 후',
                'no-operation-history': '운영 기록 이력이 없습니다',
                'operation-details': '운영 세부 정보',
                'ip-address': 'IP 주소',
                'browser-info': '브라우저 정보',
                'user-operation-stats': '사용자 운영 통계',
                'user': '사용자',
                'total': '총 운영 수',
                'create-count': '생성',
                'edit-count': '편집',
                'delete-count': '삭제', 
                'login-count': '로그인',
                'recent-critical-operations': '최근 중요 운영 기록',
                'no-critical-operations': '중요 운영 기록이 없습니다',
                'details': '세부 정보',
                'unknown-user': '알 수 없는 사용자',
                'logout': '로그아웃',
                'confirm-logout': '로그아웃 하시겠습니까？',
                'no-permission-delete-salon': '살롱을 삭제할 권한이 없습니다! 관리자만 이 작업을 수행할 수 있습니다.',
                'no-permission-delete-employee': '직원을 삭제할 권한이 없습니다! 관리자만 이 작업을 수행할 수 있습니다.',
                'no-permission-delete-transaction': '거래 기록을 삭제할 권한이 없습니다! 관리자만 이 작업을 수행할 수 있습니다.',
                'no-salesperson-salons': '아직 담당하는 살롱이 없습니다',
                'salesperson-salon-tip': '살롱에서 거래 기록이 생성되면 여기에 표시됩니다',
                'responsible-employee': '담당 직원',
                'please-select-employee': '직원을 선택해주세요...',
                'approval-required': '관리자 승인이 필요한 작업입니다',
                'approval-submitted': '작업이 제출되었습니다. 관리자 승인을 기다리고 있습니다',
                'approval-approved': '작업이 승인되었습니다',
                'approval-rejected': '작업이 관리자에 의해 거부되었습니다',
                'pending-approvals': '승인 대기 중인 작업',
                'no-pending-approvals': '승인 대기 중인 작업이 없습니다',
                'approve': '승인',
                'reject': '거부',
                'approval-reason': '승인 의견',
                'approval-management': '승인 관리',
                'approval-management-desc': '승인 대기 중인 작업 요청 처리',
                'all-status': '모든 상태',
                'pending': '승인 대기',
                'approved': '승인됨',
                'rejected': '거부됨',
                'request-time': '신청 시간',
                'requester': '신청자',
                'operation-type': '작업 유형',
                'operation-description': '작업 설명',
                'process-time': '처리 시간',
                'processor': '처리자',
                'approval-actions': '작업',
                'enter-approval-reason': '승인 의견을 입력해주세요',
                'approval-reason-required': '승인 의견을 입력해주세요',
                'approval-processed-success': '승인 처리가 완료되었습니다',
                // 일괄 작업 관련 번역
                'select-all': '전체 선택',
                'batch-delete': '일괄 삭제',
                'batch-assign': '일괄 담당자 지정',
                'selected-count': '{count}개 살롱 선택됨',
                'no-salons-selected': '먼저 작업할 살롱을 선택해주세요!',
                'confirm-batch-delete': '선택한 {count}개 살롱을 삭제하시겠습니까?\n살롱 목록: {names}\n이 작업은 되돌릴 수 없습니다!',
                'batch-delete-success': '일괄 삭제 성공! 총 {count}개 살롱을 삭제했습니다.',
                'batch-assign-responsible': '일괄 담당자 지정',
                'select-responsible-employee': '담당 직원 선택：',
                'batch-assign-tip': '선택된 모든 살롱에 담당자를 일괄 지정합니다. 이 작업은 관리자 또는 매니저 권한이 필요합니다.',
                'batch-assign-success': '일괄 지정 성공! 총 {count}개 살롱의 담당자를 {employee}으로 지정했습니다.',
                'all-districts': '전체 지역',
                'total-salons-count': '총 {count}개 살롱',
                'district-salons-count': '총 {count}개 살롱',
                'sort-by': '정렬 방식：',
                'sort-name': '살롱명 ↑',
                'sort-address': '주소명 ↑',
                'sort-add-time': '추가시간 ↑',
                'sort-last-transaction': '최종거래 ↑',
                'sort-outstanding-days': '외상일수 ↑',
                'sort-outstanding-amount': '외상금액 ↑',
                'sort-default': '기본 정렬',
                'items-per-page': '페이지당：',
                'items': '개',
                'district-other': '해외지역',
                'district-guro': '구로구',
                'district-yeongdeungpo': '영등포구',
                'district-geumcheon': '금천구',
                'loading': '로딩 중',
                'unassigned': '미지정',
                'salon-name-required': '살롱 이름을 입력해주세요！',
                // 분페이지 컨트롤
                'first-page': '첫 페이지',
                'prev-page': '이전 페이지',
                'next-page': '다음 페이지',
                'last-page': '마지막 페이지',
                'page-info': '{current}페이지 / 총 {total}페이지 ({items}개 항목)',
                'go-to-page': '페이지로 이동',
                'jump': '이동',
                'invalid-page-number': '잘못된 페이지 번호입니다! 1부터 {max}까지의 숫자를 입력해주세요.',
                // 작업 설명
                'batch-assign-description': '일괄 담당자 지정: {salons}(총 {count}개 살롱)의 담당자를 {employee}로 설정'
            }
        };
        
        // 언어 전환 함수
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // 버튼 활성 상태 변경
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('btn-' + lang).classList.add('active');
            
            // 텍스트 업데이트
            updateTexts();
            
            // 更新用户信息显示
            updateUserInfo();
            
            // 强制更新所有动态选项（无论当前是否显示）
            updateAllDynamicOptions();
            
            // 更新日期输入框的语言设置
            updateDateInputLanguages(lang);
            
            // 重新渲染当前活跃的页面内容
            refreshCurrentPageContent();
        }
        
        // 更新日期输入框的语言设置
        function updateDateInputLanguages(lang) {
            const langCode = lang === 'ko' ? 'ko-KR' : 'zh-CN';
            document.querySelectorAll('input[type="date"]').forEach(dateInput => {
                dateInput.setAttribute('lang', langCode);
            });
        }
        
        // 初始化日期输入框
        function initializeDateInputs() {
            document.querySelectorAll('.date-input-wrapper').forEach(wrapper => {
                const dateInput = wrapper.querySelector('input[type="date"]');
                if (!dateInput) return;
                
                // 更新wrapper状态
                function updateWrapperState() {
                    if (dateInput.value) {
                        wrapper.classList.add('has-value');
                    } else {
                        wrapper.classList.remove('has-value');
                    }
                }
                
                // 初始状态
                updateWrapperState();
                
                // 监听值变化
                dateInput.addEventListener('input', function(e) {
                    let value = e.target.value;
                    
                    // 如果是纯数字输入，自动格式化
                    if (value && !value.includes('-') && value.length === 8) {
                        // 假设输入格式为 YYYYMMDD
                        const year = value.substring(0, 4);
                        const month = value.substring(4, 6);
                        const day = value.substring(6, 8);
                        
                        // 验证日期合法性
                        const date = new Date(year, month - 1, day);
                        if (date.getFullYear() == year && 
                            date.getMonth() == month - 1 && 
                            date.getDate() == day) {
                            e.target.value = `${year}-${month}-${day}`;
                        }
                    }
                    
                    updateWrapperState();
                });
                
                dateInput.addEventListener('change', updateWrapperState);
                dateInput.addEventListener('focus', function() {
                    wrapper.classList.add('focused');
                });
                
                dateInput.addEventListener('blur', function() {
                    wrapper.classList.remove('focused');
                    updateWrapperState();
                });
            });
        }
        
        // 更新负责人员筛选选项
        function updateResponsibleFilterOptions() {
            const selectElement = document.getElementById('responsible-filter');
            if (!selectElement) return;
            
            const employees = getEmployees();
            let optionsHtml = `<option value="">${getText('all-employees')}</option>`;
            optionsHtml += `<option value="unassigned">${getText('unassigned')}</option>`;
            
            // 根据权限筛选可见的负责人员
            if (currentUser) {
                if (currentUser.position === 'admin') {
                    // 管理员可以看到所有人员
                    employees.forEach(employee => {
                        const positionText = getPositionText(employee.position);
                        optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                    });
                } else if (currentUser.position === 'manager') {
                    // 经理可以看到业务员和自己
                    employees.forEach(employee => {
                        if (employee.position === 'salesperson' || employee.id === currentUser.id) {
                            const positionText = getPositionText(employee.position);
                            optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                        }
                    });
                } else if (currentUser.position === 'salesperson') {
                    // 业务员只能看到自己
                    const positionText = getPositionText(currentUser.position);
                    optionsHtml += `<option value="${currentUser.id}">${currentUser.name} - ${positionText}</option>`;
                }
            } else {
                // 如果没有登录用户（向后兼容），显示所有
                employees.forEach(employee => {
                    const positionText = getPositionText(employee.position);
                    optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                });
            }
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 更新所有动态选项
        function updateAllDynamicOptions() {
            // 安全更新函数（检查元素是否存在）
            function safeUpdate(updateFn) {
                try {
                    updateFn();
                } catch (e) {
                    // 忽略不存在的元素错误
                }
            }
            
            safeUpdate(() => updateResponsibleEmployeeOptions());
            safeUpdate(() => updateEditResponsibleEmployeeOptions());
            safeUpdate(() => updateSalespersonOptions());
            safeUpdate(() => updateEditSalespersonOptions());
            safeUpdate(() => updateDeleteSalonOptions());
            safeUpdate(() => updateDeleteEmployeeOptions());
            safeUpdate(() => updateResponsibleFilterOptions());
        }
        
        // 刷新当前页面内容
        async function refreshCurrentPageContent() {
            // 检查当前激活的页面并重新渲染
            const activePages = document.querySelectorAll('.content-area.active');
            
            for (const page of activePages) {
                const pageId = page.id;
                
                switch(pageId) {
                    case 'employee-list':
                        await displayEmployeeList();
                        break;
                    case 'salon-info':
                        await displaySalonList(null, 1); // 初始化时显示第一页
                        break;
                    case 'delete-salon':
                        await updateDeleteSalonOptions();
                        break;
                    case 'delete-employee':
                        await updateDeleteEmployeeOptions();
                        break;
                    case 'transaction-list':
                        if (currentViewingSalonId) {
                            displayTransactionList(currentViewingSalonId);
                        }
                        break;
                    case 'transaction-detail':
                        if (currentViewingSalonId && currentTransactionId) {
                displayTransactionDetail(currentViewingSalonId, currentTransactionId);
            }
                        break;
                    case 'approval-management':
                        displayApprovalList();
                        break;
                    case 'operation-history':
                        displayOperationHistory(1); // 刷新时显示第一页
                        break;
                    case 'audit-report':
                        displayAuditReport();
                        break;
                    case 'performance-target':
                        generateMonthOptions();
                        displayPerformanceTargets();
                        break;
                    case 'data-comparison':
                        // 如果有保存的操作记录，重新显示数据对比
                        if (currentComparisonOperation) {
                            displayDataComparison(currentComparisonOperation);
                        }
                        break;
                }
            }
            
            // 更新模态框中的选项（如果有打开的模态框）
            await updateModalOptions();
            
            // 重新初始化日期输入框
            setTimeout(() => {
                initializeDateInputs();
            }, 100);
        }
        
        // 更新模态框选项
        async function updateModalOptions() {
            // 检查并更新新增沙龙模态框
            const newSalonModal = document.getElementById('newSalonForm');
            if (newSalonModal && newSalonModal.closest('.content-area').classList.contains('active')) {
                await updateResponsibleEmployeeOptions();
            }
            
            // 检查并更新编辑沙龙模态框
            const editSalonModal = document.getElementById('editSalonModal');
            if (editSalonModal && editSalonModal.style.display === 'flex') {
                await updateEditResponsibleEmployeeOptions();
            }
            
            // 检查并更新交易模态框
            const transactionModal = document.getElementById('transactionModal');
            if (transactionModal && transactionModal.style.display === 'flex') {
                await updateSalespersonOptions();
            }
            
            // 检查并更新编辑交易模态框
            const editTransactionModal = document.getElementById('editTransactionModal');
            if (editTransactionModal && editTransactionModal.style.display === 'flex') {
                await updateEditSalespersonOptions();
            }
        }
        
        // 모든 텍스트 업데이트
        function updateTexts() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    let text = translations[currentLanguage][key];
                    
                    // 处理带参数的翻译
                    const params = element.getAttribute('data-i18n-params');
                    if (params) {
                        try {
                            const paramObj = JSON.parse(params);
                            Object.keys(paramObj).forEach(paramKey => {
                                text = text.replace(`{${paramKey}}`, paramObj[paramKey]);
                            });
                        } catch (e) {
                            console.warn('Invalid data-i18n-params:', params);
                        }
                    }
                    
                    element.textContent = text;
                }
            });
            
            // 更新placeholder文本
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
            
            // 特别更新排序按钮文本（确保不被通用更新覆盖）
            setTimeout(() => {
                if (typeof updateAllSortButtonStyles === 'function') {
                    updateAllSortButtonStyles();
                }
            }, 50);
            
            // 更新文件上传控件文字
            const fileUploadText = document.getElementById('file-upload-text');
            if (fileUploadText) {
                fileUploadText.textContent = getText('choose-file');
            }
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            const userInfoElement = document.getElementById('userInfo');
            const userPositionElement = document.getElementById('userPosition');
            const userNameElement = document.getElementById('userName');
            
            if (currentUser) {
                // 获取权限名称的翻译
                let positionText = '';
                switch (currentUser.position) {
                    case 'admin':
                        positionText = getText('admin');
                        break;
                    case 'manager':
                        positionText = getText('manager');
                        break;
                    case 'salesperson':
                        positionText = getText('salesperson');
                        break;
                    default:
                        positionText = currentUser.position;
                }
                
                userPositionElement.textContent = positionText;
                userNameElement.textContent = currentUser.name;
                userInfoElement.style.display = 'flex';
                
                // 根据权限显示/隐藏菜单项
                const deleteEmployeeMenu = document.getElementById('delete-employee-menu');
                const deleteSalonMenu = document.getElementById('delete-salon-menu');
                const newEmployeeMenu = document.getElementById('new-employee-menu');
                const approvalManagementMenu = document.getElementById('approval-management-menu');
                
                if (currentUser.position === 'admin') {
                    // 管理员可以看到所有选项
                    if (deleteEmployeeMenu) deleteEmployeeMenu.style.display = 'block';
                    if (deleteSalonMenu) deleteSalonMenu.style.display = 'block';
                    if (newEmployeeMenu) newEmployeeMenu.style.display = 'block';
                    if (approvalManagementMenu) approvalManagementMenu.style.display = 'block';
                } else if (currentUser.position === 'manager') {
                    // 经理可以新增职员，但不能删除
                    if (deleteEmployeeMenu) deleteEmployeeMenu.style.display = 'none';
                    if (deleteSalonMenu) deleteSalonMenu.style.display = 'none';
                    if (newEmployeeMenu) newEmployeeMenu.style.display = 'block';
                    if (approvalManagementMenu) approvalManagementMenu.style.display = 'none';
                } else {
                    // 业务员不能看到新增和删除选项
                    if (deleteEmployeeMenu) deleteEmployeeMenu.style.display = 'none';
                    if (deleteSalonMenu) deleteSalonMenu.style.display = 'none';
                    if (newEmployeeMenu) newEmployeeMenu.style.display = 'none';
                    if (approvalManagementMenu) approvalManagementMenu.style.display = 'none';
                }
            } else {
                userInfoElement.style.display = 'none';
                
                // 未登录时隐藏相关选项
                const deleteEmployeeMenu = document.getElementById('delete-employee-menu');
                const deleteSalonMenu = document.getElementById('delete-salon-menu');
                const newEmployeeMenu = document.getElementById('new-employee-menu');
                const approvalManagementMenu = document.getElementById('approval-management-menu');
                if (deleteEmployeeMenu) deleteEmployeeMenu.style.display = 'none';
                if (deleteSalonMenu) deleteSalonMenu.style.display = 'none';
                if (newEmployeeMenu) newEmployeeMenu.style.display = 'none';
                if (approvalManagementMenu) approvalManagementMenu.style.display = 'none';
            }
        }
        
        // 페이지 로드 시 저장된 언어 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            const savedLanguage = localStorage.getItem('language') || 'zh';
            if (savedLanguage !== 'zh') {
                switchLanguage(savedLanguage);
            } else {
                // 确保中文也能正确显示
                updateTexts();
                // 初始化日期输入框的语言设置
                updateDateInputLanguages('zh');
            }
            
            // 初始化主题
            initializeTheme();
            
            // 初始化日期输入框
            initializeDateInputs();
            
            // 更新用户信息显示
            updateUserInfo();
            
            // 初始化排序按钮样式
            setTimeout(() => {
                if (typeof updateAllSortButtonStyles === 'function') {
                    // 确保初始状态正确
                    currentSortField = 'default';
                    currentSortOrder = '';
                    updateAllSortButtonStyles();
                }
            }, 100);
            
            // 初始化文件上传控件
            initializeFileUpload();
        });
        
        // 다국어 텍스트 가져오기 함수
        function getText(key) {
            return translations[currentLanguage] && translations[currentLanguage][key] 
                ? translations[currentLanguage][key] 
                : key;
        }
        
        // ==================== 主题切换功能 ====================
        
        // 检测系统主题偏好
        function getSystemTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                return 'light';
            }
            return 'dark';
        }
        
        // 获取当前主题
        function getCurrentTheme() {
            return localStorage.getItem('theme') || getSystemTheme();
        }
        
        // 应用主题
        function applyTheme(theme) {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (theme === 'light') {
                body.classList.add('light-theme');
                themeIcon.textContent = '☀️';
            } else {
                body.classList.remove('light-theme');
                themeIcon.textContent = '🌙';
            }
            
            localStorage.setItem('theme', theme);
        }
        
        // 切换主题
        function toggleTheme() {
            const currentTheme = getCurrentTheme();
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }
        
        // 监听系统主题变化
        function initializeTheme() {
            const savedTheme = getCurrentTheme();
            applyTheme(savedTheme);
            
            // 监听系统主题变化（如果用户没有手动设置过）
            if (!localStorage.getItem('theme')) {
                window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                    const systemTheme = e.matches ? 'light' : 'dark';
                    applyTheme(systemTheme);
                });
            }
        }
        
        // ==================== 营业执照号码格式化 ====================
        
        // 格式化营业执照号码为 000-00-00000 格式
        function formatBusinessLicense(input) {
            // 移除所有非数字字符
            let value = input.value.replace(/\D/g, '');
            
            // 限制最多11位数字
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // 添加格式化
            if (value.length > 5) {
                value = value.substring(0, 3) + '-' + value.substring(3, 5) + '-' + value.substring(5);
            } else if (value.length > 3) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
            
            input.value = value;
        }
        
        // ==================== 产品历史记录检查 ====================
        
        // 检查产品历史交易记录
        async function checkProductHistory(input) {
            const productName = input.value.trim();
            const historySection = document.getElementById('product-history-section');
            const historyDisplay = document.getElementById('product-history-display');
            
            if (!productName || productName.length < 2) {
                historySection.style.display = 'none';
                return;
            }
            
            // 获取当前沙龙ID
            if (!currentSalonId) {
                historySection.style.display = 'none';
                return;
            }
            
            // 获取沙龙数据
            const salons = await getSalons();
            const salon = salons.find(s => s.id === currentSalonId);
            
            if (!salon || !salon.transactions || salon.transactions.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            // 查找包含相同产品的历史交易
            const matchingTransactions = [];
            salon.transactions.forEach(transaction => {
                if (transaction.products && transaction.products.length > 0) {
                    const matchingProducts = transaction.products.filter(product => 
                        product.name && product.name.toLowerCase().includes(productName.toLowerCase())
                    );
                    
                    if (matchingProducts.length > 0) {
                        matchingTransactions.push({
                            transaction: transaction,
                            products: matchingProducts
                        });
                    }
                }
            });
            
            if (matchingTransactions.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            // 显示历史记录
            displayProductHistory(matchingTransactions, productName);
            historySection.style.display = 'block';
        }
        
        // 显示产品历史记录
        function displayProductHistory(matchingTransactions, searchProductName) {
            const historyDisplay = document.getElementById('product-history-display');
            
            if (matchingTransactions.length === 0) {
                historyDisplay.innerHTML = `<p style="color: #cccccc; margin: 0;">未找到相关产品的历史交易记录</p>`;
                return;
            }
            
            // 按交易时间排序，最新的在前面
            matchingTransactions.sort((a, b) => new Date(b.transaction.date) - new Date(a.transaction.date));
            
            let html = `<div style="margin-bottom: 8px; color: var(--gold); font-weight: bold;">产品"${searchProductName}"的历史交易记录：</div>`;
            
            // 只显示最近的3条记录
            const recentTransactions = matchingTransactions.slice(0, 3);
            
            recentTransactions.forEach((item, index) => {
                const transaction = item.transaction;
                const products = item.products;
                const transactionDate = new Date(transaction.date);
                const daysSince = Math.floor((new Date() - transactionDate) / (1000 * 60 * 60 * 24));
                
                html += `<div style="background: rgba(0,0,0,0.2); padding: 8px; margin: 5px 0; border-radius: 3px; border: 1px solid rgba(212, 175, 55, 0.2);">`;
                html += `<div style="color: #87CEEB; font-size: 0.9em; margin-bottom: 5px;">距上次交易：${daysSince}天前 (${transactionDate.toLocaleDateString()})</div>`;
                
                products.forEach(product => {
                    html += `<div style="color: #cccccc; font-size: 0.9em;">`;
                    html += `${product.name} - 单价: ${formatCurrency(product.unitPrice || 0)} - 数量: ${product.quantity || 0}`;
                    if (product.giftQuantity && product.giftQuantity > 0) {
                        html += ` - 赠送: ${product.giftQuantity}`;
                    }
                    html += ` - 金额: ${formatCurrency(product.totalAmount || 0)}`;
                    html += `</div>`;
                });
                
                if (transaction.salesperson) {
                    html += `<div style="color: #aaa; font-size: 0.8em; margin-top: 3px;">业务员：${transaction.salesperson}</div>`;
                }
                html += `</div>`;
            });
            
            if (matchingTransactions.length > 3) {
                html += `<div style="text-align: center; color: #aaa; font-size: 0.8em; margin-top: 5px;">还有 ${matchingTransactions.length - 3} 条相关记录...</div>`;
            }
            
            historyDisplay.innerHTML = html;
        }
        
        // 初始化文件上传控件
        function initializeFileUpload() {
            const fileInput = document.getElementById('salon-file-upload');
            const fileUploadText = document.getElementById('file-upload-text');
            const selectedFileName = document.getElementById('selected-file-name');
            
            if (fileInput && fileUploadText && selectedFileName) {
                // 监听文件选择变化
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // 有文件被选择
                        fileUploadText.textContent = getText('choose-file');
                        selectedFileName.textContent = `✓ ${file.name}`;
                        selectedFileName.style.display = 'block';
                    } else {
                        // 没有文件被选择
                        fileUploadText.textContent = getText('choose-file');
                        selectedFileName.style.display = 'none';
                    }
                });
                
                // 初始化显示
                fileUploadText.textContent = getText('choose-file');
                selectedFileName.style.display = 'none';
            }
        }
        
        // 获取职位名称翻译
        function getPositionText(position) {
            return getText(position);
        }
        
        // 获取区域名称翻译
        function getDistrictText(district) {
            return getText(district + '-district');
        }
        
        // 살롱 데이터 관리 - 云端同步版本
        async function getSalons() {
            return await cloudDataManager.getSalons();
        }
        
        async function saveSalons(salons) {
            // 清除所有沙龙的缓存数据，确保下次计算时使用最新数据
            salons.forEach(salon => {
                delete salon._cachedTotalOutstanding;
                delete salon._lastCalculatedTime;
                delete salon._cachedOutstandingMonths;
                delete salon._lastMonthsCalculatedTime;
            });
            
            // 批量保存到云端
            for (const salon of salons) {
                await cloudDataManager.saveSalon(salon);
            }
        }
        
        async function addSalon(salon) {
            try {
                salon.id = Date.now(); // 简单的ID生成
                salon.addTime = new Date().toLocaleString('zh-CN');
                salon.joinDate = new Date(); // 加入日期，用于计算
                salon.transactions = []; // 初始化交易记录数组
                salon.lastTransactionDate = null; // 最后一次交易日期
                
                // 直接保存到云端
                await cloudDataManager.saveSalon(salon);
                
                // 记录操作历史
                recordOperation(
                    'create', 
                    'salon', 
                    salon.id, 
                    salon.name, 
                    `创建新沙龙：${salon.name}，院长：${salon.directorName}`,
                    null,
                    salon
                );
                
                return true; // 成功返回true
            } catch (error) {
                console.error('addSalon 失败:', error);
                return false; // 失败返回false
            }
        }
        
        async function deleteSalon(salonId) {
            const salons = await getSalons();
            const salonToDelete = salons.find(salon => salon.id === salonId);
            
            // 直接从云端删除
            await cloudDataManager.deleteSalon(salonId);
            
            // 记录操作历史
            if (salonToDelete) {
                recordOperation(
                    'delete', 
                    'salon', 
                    salonToDelete.id, 
                    salonToDelete.name, 
                    `删除沙龙：${salonToDelete.name}，院长：${salonToDelete.directorName}`,
                    salonToDelete,
                    null
                );
            }
        }
        
        async function updateSalon(updatedSalon) {
            const salons = await getSalons();
            const index = salons.findIndex(salon => salon.id === updatedSalon.id);
            
            if (index !== -1) {
                const beforeData = JSON.parse(JSON.stringify(salons[index]));
                
                // 保留原有的创建时间和交易记录
                updatedSalon.addTime = salons[index].addTime;
                updatedSalon.joinDate = salons[index].joinDate;
                updatedSalon.transactions = salons[index].transactions;
                updatedSalon.lastTransactionDate = salons[index].lastTransactionDate;
                
                // 直接保存到云端
                await cloudDataManager.saveSalon(updatedSalon);
                
                // 记录操作历史
                recordOperation(
                    'edit', 
                    'salon', 
                    updatedSalon.id, 
                    updatedSalon.name, 
                    `编辑沙龙信息：${updatedSalon.name}`,
                    beforeData,
                    updatedSalon
                );
                
                return true;
            }
            return false;
        }
        
        // 职员数据管理 - 云端同步版本
        async function getEmployees() {
            return await cloudDataManager.getEmployees();
        }
        
        async function saveEmployees(employees) {
            // 批量保存到云端
            for (const employee of employees) {
                await cloudDataManager.saveEmployee(employee);
            }
        }
        
        async function addEmployee(employee) {
            const employees = await getEmployees();
            
            // 检查用户名是否已存在
            if (employees.some(emp => emp.username === employee.username)) {
                return false; // 用户名已存在
            }
            
            employee.id = Date.now();
            employee.createTime = new Date().toLocaleString('zh-CN');
            
            // 直接保存到云端
            await cloudDataManager.saveEmployee(employee);
            
            // 记录操作历史
            recordOperation(
                'create', 
                'employee', 
                employee.id, 
                employee.name, 
                `创建新职员：${employee.name}，职位：${employee.position}`,
                null,
                employee
            );
            
            return true;
        }
        
        async function deleteEmployee(employeeId) {
            const employees = await getEmployees();
            const employeeToDelete = employees.find(employee => employee.id === employeeId);
            
            // 直接从云端删除
            await cloudDataManager.deleteEmployee(employeeId);
            
            // 记录操作历史
            if (employeeToDelete) {
                recordOperation(
                    'delete', 
                    'employee', 
                    employeeToDelete.id, 
                    employeeToDelete.name, 
                    `删除职员：${employeeToDelete.name}，职位：${employeeToDelete.position}`,
                    employeeToDelete,
                    null
                );
            }
        }
        
        async function updateEmployee(updatedEmployee) {
            const employees = await getEmployees();
            const index = employees.findIndex(emp => emp.id === updatedEmployee.id);
            
            if (index !== -1) {
                // 检查用户名是否被其他职员使用
                const existingUser = employees.find(emp => emp.username === updatedEmployee.username && emp.id !== updatedEmployee.id);
                if (existingUser) {
                    return false; // 用户名已存在
                }
                
                const beforeData = JSON.parse(JSON.stringify(employees[index]));
                
                // 保留创建时间
                updatedEmployee.createTime = employees[index].createTime;
                
                // 如果密码为空，保留原密码
                if (!updatedEmployee.password || updatedEmployee.password.trim() === '') {
                    updatedEmployee.password = employees[index].password;
                }
                
                // 直接保存到云端
                await cloudDataManager.saveEmployee(updatedEmployee);
                
                // 记录操作历史
                recordOperation(
                    'edit', 
                    'employee', 
                    updatedEmployee.id, 
                    updatedEmployee.name, 
                    `编辑职员信息：${updatedEmployee.name}`,
                    beforeData,
                    updatedEmployee
                );
                
                // 如果修改的是当前登录用户，更新当前用户信息
                if (currentUser && currentUser.id === updatedEmployee.id) {
                    setCurrentUser(updatedEmployee);
                    // updateUserInfo会在setCurrentUser中被调用
                }
                
                return true;
            }
            return false;
        }
        
        // 当前登录用户信息
        let currentUser = null;
        
        function getCurrentUser() {
            const userInfo = localStorage.getItem('currentUser');
            return userInfo ? JSON.parse(userInfo) : null;
        }
        
        function setCurrentUser(user, isLogin = false) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // 记录登录历史（只在真正登录时记录，不在系统初始化时记录）
            if (isLogin) {
                recordOperation(
                    'login', 
                    'system', 
                    user.id, 
                    '系统登录', 
                    `用户 ${user.name} (${user.position}) 登录系统`,
                    null,
                    null
                );
            }
            
            // 更新用户信息显示
            updateUserInfo();
        }
        
        function logout() {
            if (currentUser) {
                // 记录登出历史
                recordOperation(
                    'logout', 
                    'system', 
                    currentUser.id, 
                    '系统登出', 
                    `用户 ${currentUser.name} (${currentUser.position}) 登出系统`,
                    null,
                    null
                );
            }
            
            currentUser = null;
            localStorage.removeItem('currentUser');
            // 更新用户信息显示
            updateUserInfo();
            
            // 跳转到登录页面
            window.location.href = 'login.html';
        }
        
        // 显示用户菜单
        function showUserMenu() {
            // 移除已存在的菜单
            const existingMenu = document.getElementById('userDropdownMenu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const userNameElement = document.getElementById('userName');
            const rect = userNameElement.getBoundingClientRect();
            
            const menu = document.createElement('div');
            menu.id = 'userDropdownMenu';
            menu.style.cssText = `
                position: fixed;
                top: ${rect.bottom + 5}px;
                right: ${window.innerWidth - rect.right}px;
                background: var(--dark-gray);
                border: 1px solid var(--gold);
                border-radius: 5px;
                padding: 8px 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                z-index: 10000;
                min-width: 120px;
            `;
            
            const logoutItem = document.createElement('div');
            logoutItem.style.cssText = `
                padding: 10px 15px;
                color: var(--text-light);
                cursor: pointer;
                transition: background-color 0.2s;
            `;
            logoutItem.textContent = getText('logout');
            logoutItem.onmouseover = () => logoutItem.style.backgroundColor = 'rgba(212, 175, 55, 0.2)';
            logoutItem.onmouseout = () => logoutItem.style.backgroundColor = 'transparent';
            logoutItem.onclick = () => {
                menu.remove();
                if (confirm(getText('confirm-logout'))) {
                    logout();
                }
            };
            
            menu.appendChild(logoutItem);
            document.body.appendChild(menu);
            
            // 点击其他地方关闭菜单
            function closeMenu(e) {
                if (!menu.contains(e.target) && e.target !== userNameElement) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            }
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }
        
        // 验证用户权限
        function hasPermission(requiredRole) {
            if (!currentUser) return false;
            
            // 管理员拥有所有权限
            if (currentUser.position === 'admin') return true;
            
            // 经理可以查看和编辑数据，但不能删除沙龙和职员
            if (currentUser.position === 'manager') {
                // 经理不能删除沙龙、不能删除职员、不能执行管理员级别操作
                if (requiredRole === 'delete-salon' || requiredRole === 'delete-employee' || requiredRole === 'admin') {
                    return false;
                }
                return true;
            }
            
            // 业务员只能查看和编辑自己的数据，不能删除任何信息
            if (currentUser.position === 'salesperson') {
                // 业务员不能删除任何信息
                if (requiredRole.startsWith('delete-')) {
                    return false;
                }
                return requiredRole === 'salesperson';
            }
            
            return false;
        }
        
        // 获取职员姓名
        function getEmployeeName(employeeId) {
            if (employeeId === 'unassigned' || employeeId === '' || !employeeId) {
                return getText('unassigned');
            }
            const employees = getEmployees();
            const employee = employees.find(emp => emp.id == employeeId);
            return employee ? employee.name : getText('unassigned');
        }
        
        // 数字格式化函数（千分位）
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // 数字格式化函数（纯数字带千分位）
        function formatNumber(number) {
            return new Intl.NumberFormat('ko-KR').format(number);
        }
        
        // 手机号格式化函数
        function formatMobile(mobile) {
            if (!mobile) return '';
            // 移除所有非数字字符
            const cleaned = mobile.replace(/\D/g, '');
            // 按照000-0000-0000格式化
            if (cleaned.length >= 11) {
                return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 7)}-${cleaned.slice(7, 11)}`;
            } else if (cleaned.length >= 7) {
                return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 7)}-${cleaned.slice(7)}`;
            } else if (cleaned.length >= 3) {
                return `${cleaned.slice(0, 3)}-${cleaned.slice(3)}`;
            } else {
                return cleaned;
            }
        }
        
        // 初始化系统
        async function initializeSystem() {
            // 检查是否有员工，如果没有则创建默认管理员
            const employees = await getEmployees();
            if (employees.length === 0) {
                const defaultAdmin = {
                    name: '시스템 관리자',
                    position: 'admin',
                    username: 'admin',
                    password: 'admin',
                    mobile: '010-0000-0000'
                };
                await addEmployee(defaultAdmin);
            }
            
            // 检查当前登录状态
            currentUser = getCurrentUser();
            if (currentUser) {
                // 如果有登录用户，设置界面状态
                console.log('현재 로그인 사용자:', currentUser.name, '- 권한:', currentUser.position);
                // 更新用户信息显示
                updateUserInfo();
            } else {
                // 临时设置为管理员用户（向后兼容）
                const latestEmployees = await getEmployees();
                currentUser = latestEmployees.find(emp => emp.position === 'admin') || latestEmployees[0];
                if (currentUser) {
                    setCurrentUser(currentUser);
                    // updateUserInfo会在setCurrentUser中被调用
                }
            }
        }
        
        // 添加交易记录
        async function addTransaction(salonId, transaction) {
            const salons = await getSalons();
            const salonIndex = salons.findIndex(salon => salon.id === salonId);
            if (salonIndex !== -1) {
                if (!salons[salonIndex].transactions) {
                    salons[salonIndex].transactions = [];
                }
                transaction.id = Date.now();
                transaction.date = new Date();
                // 确保数字字段是数字类型
                transaction.receivableAmount = parseFloat(transaction.receivableAmount) || 0;
                transaction.receivedAmount = parseFloat(transaction.receivedAmount) || 0;
                transaction.outstandingAmount = transaction.receivableAmount - transaction.receivedAmount;
                // 添加当前用户信息（如果有）
                if (currentUser) {
                    transaction.salesperson = currentUser.name;
                    transaction.salespersonId = currentUser.id;
                }
                salons[salonIndex].transactions.push(transaction);
                salons[salonIndex].lastTransactionDate = new Date();
                
                // 直接保存到云端
                await cloudDataManager.saveSalon(salons[salonIndex]);
                
                // 记录操作历史
                recordOperation(
                    'create', 
                    'transaction', 
                    transaction.id, 
                    `${salons[salonIndex].name} - 交易记录`, 
                    `在沙龙 ${salons[salonIndex].name} 添加新交易记录，金额：${transaction.totalAmount || 0}韩元`,
                    null,
                    transaction
                );
            }
        }
        
        // 确认删除交易记录
        function confirmDeleteTransaction() {
            // 权限检查：只有管理员可以删除交易记录
            if (!hasPermission('admin')) {
                alert(getText('no-permission-delete-transaction'));
                return;
            }
            
            if (confirm(getText('confirm-delete-transaction'))) {
                deleteTransaction(currentViewingSalonId, currentTransactionId);
            }
        }
        
        // 删除交易记录
        async function deleteTransaction(salonId, transactionId) {
            const salons = await getSalons();
            const salon = salons.find(s => s.id === salonId);
            if (!salon) return false;
            
            // 找到并删除交易记录
            const transactionIndex = salon.transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return false;
            
            const transactionToDelete = JSON.parse(JSON.stringify(salon.transactions[transactionIndex]));
            salon.transactions.splice(transactionIndex, 1);
            
            // 更新最后交易日期
            if (salon.transactions.length > 0) {
                const latestTransaction = salon.transactions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                salon.lastTransactionDate = latestTransaction.date;
            } else {
                delete salon.lastTransactionDate; // 如果没有交易记录了，删除最后交易日期
            }
            
            // 直接保存到云端
            await cloudDataManager.saveSalon(salon);
            
            // 记录操作历史
            recordOperation(
                'delete', 
                'transaction', 
                transactionId, 
                `${salon.name} - 交易记录`, 
                `删除沙龙 ${salon.name} 的交易记录`,
                transactionToDelete,
                null
            );
            
            // 删除成功后返回到沙龙信息页面
            document.getElementById('transaction-detail').classList.remove('active');
            document.getElementById('salon-info').classList.add('active');
            
            // 刷新沙龙列表
            displaySalonList();
            
            alert(getText('transaction-deleted-success'));
            return true;
        }
        
        // 更新交易记录
        function updateTransaction(salonId, updatedTransaction) {
            const salons = getSalons();
            const salonIndex = salons.findIndex(salon => salon.id === salonId);
            
            if (salonIndex !== -1 && salons[salonIndex].transactions) {
                const transactionIndex = salons[salonIndex].transactions.findIndex(t => t.id === updatedTransaction.id);
                if (transactionIndex !== -1) {
                    const beforeData = JSON.parse(JSON.stringify(salons[salonIndex].transactions[transactionIndex]));
                    
                    salons[salonIndex].transactions[transactionIndex] = updatedTransaction;
                    saveSalons(salons);
                    
                    // 记录操作历史
                    recordOperation(
                        'edit', 
                        'transaction', 
                        updatedTransaction.id, 
                        `${salons[salonIndex].name} - 交易记录`, 
                        `编辑沙龙 ${salons[salonIndex].name} 的交易记录`,
                        beforeData,
                        updatedTransaction
                    );
                    
                    return true;
                }
            }
            return false;
        }
        
        // 显示职员列表
        async function displayEmployeeList() {
            const employeeListContainer = document.getElementById('employee-list-content');
            const employees = await getEmployees();
            
            if (employees.length === 0) {
                employeeListContainer.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>暂无职员信息</p><p style="font-size: 0.9em;">请前往"新增职员"页面添加职员信息</p></div>`;
                return;
            }
            
            let html = '';
            employees.forEach((employee, index) => {
                // 权限检查：管理员可以看到所有，经理不能看到其他经理和管理员，业务员可以看到所有但只能编辑自己
                let canView = false;
                let canEdit = false;
                
                if (currentUser.position === 'admin') {
                    canView = true;
                    canEdit = true;
                } else if (currentUser.position === 'manager') {
                    canView = true; // 经理可以看到所有职员
                    canEdit = employee.position === 'salesperson' || employee.id === currentUser.id;
                } else {
                    // 业务员可以看到所有职员信息，但只能编辑自己的
                    canView = true;
                    canEdit = employee.id === currentUser.id;
                }
                
                if (!canView) return;
                
                // 获取职位显示名称
                let positionText = getText('salesperson');
                if (employee.position === 'manager') positionText = getText('manager');
                else if (employee.position === 'admin') positionText = getText('admin');
                
                html += `
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 5px; margin-bottom: 15px; border: 1px solid rgba(212, 175, 55, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--gold-light); margin: 0; flex-grow: 1;">${employee.name}</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="background: var(--gold); color: var(--black); padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">${positionText}</span>
                                ${canEdit ? `<button onclick="showEditEmployeeModal(${employee.id})" style="background: var(--gold); color: var(--black); border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('edit-btn')}</button>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>${getText('employee-username').replace('：', '')}：</strong> ${employee.username}</p>
                                <p><strong>${getText('employee-mobile').replace('：', '')}：</strong> ${formatMobile(employee.mobile)}</p>
                                <p><strong>${getText('create-time')}：</strong> ${employee.createTime}</p>
                            </div>
                            
                            <div>
                                <p><strong>${getText('permission-level')}：</strong> 
                                    <span style="color: ${employee.position === 'admin' ? '#ff6666' : employee.position === 'manager' ? '#ffaa00' : '#90EE90'};">
                                        ${positionText}
                                    </span>
                                </p>
                                <p><strong>${getText('status-label')}：</strong> <span style="color: #90EE90;">${getText('status-normal')}</span></p>
                            </div>
                        </div>
                        
                        <!-- 银行账户信息 -->
                        ${employee.bankInfo && (employee.bankInfo.bankName || employee.bankInfo.accountNumber) ? `
                            <div style="background: rgba(212, 175, 55, 0.2); padding: 15px; border-radius: 5px; margin-top: 15px; border: 1px solid rgba(212, 175, 55, 0.4);">
                                <h4 style="color: var(--gold); margin: 0 0 10px 0;">${getText('bank-account-info')}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        ${employee.bankInfo.bankName ? `<p><strong>${getText('bank-name').replace('：', '')}：</strong> ${employee.bankInfo.bankName}</p>` : ''}
                                        ${employee.bankInfo.accountHolder ? `<p><strong>${getText('account-holder').replace('：', '')}：</strong> ${employee.bankInfo.accountHolder}</p>` : ''}
                                    </div>
                                    <div>
                                        ${employee.bankInfo.accountNumber ? `<p><strong>${getText('account-number').replace('：', '')}：</strong> ${employee.bankInfo.accountNumber}</p>` : ''}
                                        ${employee.bankInfo.bankBranch ? `<p><strong>${getText('bank-branch').replace('：', '').replace('（选填）', '')}：</strong> ${employee.bankInfo.bankBranch}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            employeeListContainer.innerHTML = html;
        }
        
        // 确认删除职员
        function confirmDeleteEmployee(employeeId) {
            const employees = getEmployees();
            const employee = employees.find(e => e.id === employeeId);
            if (employee && confirm(getText('confirm-delete-employee').replace('{name}', employee.name))) {
                deleteEmployee(employeeId);
                displayEmployeeList(); // 刷新列表
                updateDeleteEmployeeOptions(); // 更新删除页面的选项
                alert(getText('employee-deleted-success'));
            }
        }
        
        // 更新删除职员页面的选项
        async function updateDeleteEmployeeOptions() {
            const selectElement = document.getElementById('deleteEmployeeSelect');
            if (!selectElement) return;
            
            const employees = await getEmployees();
            let optionsHtml = `<option value="">${getText('please-select-employee')}</option>`;
            
            employees.forEach(employee => {
                // 只有管理员可以看到删除选项，且不能删除自己
                if (currentUser && currentUser.position === 'admin' && employee.id !== currentUser.id) {
                    const positionText = getPositionText(employee.position);
                    optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                }
            });
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 删除选定的职员
        function deleteSelectedEmployee() {
            const selectElement = document.getElementById('deleteEmployeeSelect');
            const selectedEmployeeId = selectElement.value;
            
            if (!selectedEmployeeId) {
                alert(getText('select-employee-first'));
                return;
            }
            
            const employees = getEmployees();
            const employee = employees.find(e => e.id == selectedEmployeeId);
            
            if (employee && confirm(getText('confirm-delete-employee').replace('{name}', employee.name))) {
                deleteEmployee(parseInt(selectedEmployeeId));
                updateDeleteEmployeeOptions(); // 更新下拉列表
                alert(getText('employee-deleted-success'));
                
                // 如果当前在职员列表页面，也刷新那个页面
                const employeeListPage = document.getElementById('employee-list');
                if (employeeListPage && employeeListPage.classList.contains('active')) {
                    displayEmployeeList();
                }
            }
        }
        
        // ==================== 批量上传沙龙功能 ====================
        
        // 批量上传的临时数据存储
        let batchSalonData = [];
        
        // 检查批量上传权限
        function checkBatchUploadPermission() {
            const batchSection = document.getElementById('batch-upload-section');
            if (currentUser && (currentUser.position === 'admin' || currentUser.position === 'manager')) {
                batchSection.style.display = 'block';
            } else {
                batchSection.style.display = 'none';
            }
        }
        
        // 根据地址关键字自动设置区域
        function autoDetectDistrict(address) {
            const addressLower = address.toLowerCase();
            if (addressLower.includes('구로')) {
                return 'guro';
            } else if (addressLower.includes('영등포')) {
                return 'yeongdeungpo';
            } else if (addressLower.includes('금천')) {
                return 'geumcheon';
            } else {
                return 'overseas'; // 默认为海外区域
            }
        }
        
        // 解析Excel文件内容
        function parseExcel(workbook) {
            // 检查是否有工作表
            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                throw new Error('Excel文件中没有找到工作表');
            }
            
            // 获取第一个工作表
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            if (!worksheet) {
                throw new Error(`无法读取工作表：${sheetName}`);
            }
            
            // 转换为JSON格式
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length === 0) {
                throw new Error('工作表中没有数据');
            }
            
            if (jsonData.length < 3) {
                throw new Error('工作表数据不足，至少需要3行（标题行+列标题行+数据行）');
            }
            
            // 从第二行开始查找列标题（索引为1）
            const headers = jsonData[1] || [];
            
            const nameIndex = headers.findIndex(h => {
                if (!h) return false;
                const headerStr = h.toString().toLowerCase();
                return headerStr.includes('업소명') || 
                       headerStr.includes('사업자명') || 
                       headerStr.includes('업체명') ||
                       headerStr.includes('상호명') ||
                       headerStr.includes('상호') ||
                       headerStr.includes('미용실') ||
                       headerStr.includes('헤어샵') ||
                       headerStr.includes('살롱') ||
                       headerStr.includes('매장명') ||
                       headerStr.includes('점포명') ||
                       headerStr.includes('리스트') ||
                       (headerStr.includes('이름') && !headerStr.includes('대표')) ||
                       headerStr.includes('name');
            });
            const addressIndex = headers.findIndex(h => {
                if (!h) return false;
                const headerStr = h.toString().toLowerCase();
                return (headerStr.includes('영업소') && headerStr.includes('주소')) || 
                       headerStr.includes('주소') ||
                       headerStr.includes('위치') ||
                       headerStr.includes('소재지') ||
                       headerStr.includes('address') ||
                       headerStr.includes('location');
            });
            
            if (nameIndex === -1 || addressIndex === -1) {
                const missingColumns = [];
                const foundColumns = headers.filter(h => h).join('、');
                
                if (nameIndex === -1) missingColumns.push('沙龙名称列（如：업소명、미용실、상호명等）');
                if (addressIndex === -1) missingColumns.push('地址列（如：주소、영업소 주소、위치等）');
                
                throw new Error(`Excel文件格式不符合要求！\n\n缺少必需的列：${missingColumns.join('、')}\n\n当前第2行的列标题：${foundColumns}\n\n期望的Excel格式：\n第1行：表格标题\n第2行：列标题（必须包含沙龙名称和地址列）\n第3行开始：实际数据\n\n建议：\n1. 点击"下载样例模板"获取标准格式\n2. 确保第2行包含正确的列标题\n3. 至少需要包含沙龙名称和地址两列`);
            }
            
            const salons = [];
            // 从第3行开始读取数据（索引为2）
            for (let i = 2; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;
                
                const name = row[nameIndex] ? row[nameIndex].toString().trim() : '';
                const address = row[addressIndex] ? row[addressIndex].toString().trim() : '';
                
                if (name && address) {
                    const district = autoDetectDistrict(address);
                    salons.push({
                        name: name,
                        address: address,
                        district: district,
                        phone: '', // 留空
                        directorName: '未指定', // 默认值
                        directorMobile: '', // 留空
                        responsibleEmployeeId: '' // 留空，需要后续设置
                    });
                }
            }
            
            return salons;
        }
        
        // 处理上传的文件
        async function processSalonFile() {
            // 检查SheetJS库是否已加载
            if (typeof XLSX === 'undefined') {
                alert('Excel处理库尚未加载完成，请稍后再试！');
                return;
            }
            
            const fileInput = document.getElementById('salon-file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert(getText('select-file-first'));
                return;
            }
            
            // 检查文件类型
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert(getText('unsupported-file-type'));
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    
                    batchSalonData = parseExcel(workbook);
                    
                    if (batchSalonData.length === 0) {
                        alert(getText('no-valid-data'));
                        return;
                    }
                    
                    // 显示预览
                    await displayBatchPreview();
                    alert(getText('file-processed-success').replace('{count}', batchSalonData.length));
                    
                } catch (error) {
                    alert(getText('file-processing-error').replace('{error}', error.message));
                }
            };
            
            reader.readAsBinaryString(file);
        }
        
        // 显示批量数据预览
        async function displayBatchPreview() {
            const previewDiv = document.getElementById('file-preview');
            const tableDiv = document.getElementById('preview-table');
            
            // 获取职员列表用于负责人选择
            const employees = await getEmployees();
            let employeeOptions = `<option value="">未分配</option>`;
            employees.forEach(employee => {
                if (currentUser) {
                    if (currentUser.position === 'admin') {
                        // 管理员可以选择所有人
                        const positionText = getPositionText(employee.position);
                        employeeOptions += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                    } else if (currentUser.position === 'manager') {
                        // 经理可以选择业务员
                        if (employee.position === 'salesperson') {
                            const positionText = getPositionText(employee.position);
                            employeeOptions += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                        }
                    } else if (currentUser.position === 'salesperson' && employee.id === currentUser.id) {
                        // 业务员只能选择自己
                        const positionText = getPositionText(employee.position);
                        employeeOptions += `<option value="${employee.id}" selected>${employee.name} - ${positionText}</option>`;
                    }
                }
            });

            let tableHTML = `
                <!-- 批量操作控制区 -->
                <div style="margin-bottom: 15px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 5px; border: 1px solid rgba(212, 175, 55, 0.3);">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; color: var(--gold);">
                            <input type="checkbox" id="batch-select-all" onchange="toggleBatchSelectAll()">
                            全选
                        </label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--text-light);">批量分配负责人：</span>
                            <select id="batch-responsible-select" style="padding: 5px; background: var(--dark-gray); color: var(--text-light); border: 1px solid var(--gold); border-radius: 3px;">
                                ${employeeOptions}
                            </select>
                            <button onclick="applyBatchResponsible()" style="background: var(--gold); color: var(--black); border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 0.9em;">
                                应用到选中项
                            </button>
                        </div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
                    <thead>
                        <tr style="background: rgba(212, 175, 55, 0.2);">
                            <th style="border: 1px solid #555; padding: 8px; width: 40px;">选择</th>
                            <th style="border: 1px solid #555; padding: 8px;">${getText('salon-name').replace('：', '')}</th>
                            <th style="border: 1px solid #555; padding: 8px;">${getText('salon-address').replace('：', '')}</th>
                            <th style="border: 1px solid #555; padding: 8px;">${getText('salon-district').replace('：', '')}</th>
                            <th style="border: 1px solid #555; padding: 8px;">${getText('director-name').replace('：', '')}</th>
                            <th style="border: 1px solid #555; padding: 8px;">负责人</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            batchSalonData.forEach((salon, index) => {
                const districtText = getText(salon.district + '-district');
                // 设置默认负责人为当前用户（如果是业务员）
                const defaultResponsibleId = (currentUser && currentUser.position === 'salesperson') ? currentUser.id : '';
                
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #555; padding: 8px; text-align: center;">
                            <input type="checkbox" class="batch-salon-checkbox" data-index="${index}">
                        </td>
                        <td style="border: 1px solid #555; padding: 8px;">${salon.name}</td>
                        <td style="border: 1px solid #555; padding: 8px;">${salon.address}</td>
                        <td style="border: 1px solid #555; padding: 8px;">${districtText}</td>
                        <td style="border: 1px solid #555; padding: 8px;">${salon.directorName}</td>
                        <td style="border: 1px solid #555; padding: 8px;">
                            <select class="salon-responsible-select" data-index="${index}" style="width: 100%; padding: 4px; background: var(--dark-gray); color: var(--text-light); border: 1px solid #666; border-radius: 3px;" onchange="updateSalonResponsible(${index}, this.value)">
                                ${employeeOptions}
                            </select>
                        </td>
                    </tr>
                `;
                
                // 设置默认负责人
                if (defaultResponsibleId) {
                    salon.responsibleEmployeeId = defaultResponsibleId;
                }
            });
            
            tableHTML += '</tbody></table>';
            tableDiv.innerHTML = tableHTML;
            
            // 设置默认选中的负责人
            if (currentUser && currentUser.position === 'salesperson') {
                batchSalonData.forEach((salon, index) => {
                    const selectElement = document.querySelector(`.salon-responsible-select[data-index="${index}"]`);
                    if (selectElement) {
                        selectElement.value = currentUser.id;
                    }
                });
            }
            
            previewDiv.style.display = 'block';
        }
        
        // 更新批量创建进度条
        function updateBatchProgress(current, total, status, isComplete = false) {
            const progressContainer = document.getElementById('batch-progress-container');
            const progressText = document.getElementById('batch-progress-text');
            const progressCount = document.getElementById('batch-progress-count');
            const progressBar = document.getElementById('batch-progress-bar');
            const progressPercent = document.getElementById('batch-progress-percent');
            const progressStatus = document.getElementById('batch-progress-status');
            
            if (!progressContainer) return;
            
            const percentage = Math.round((current / total) * 100);
            
            progressContainer.style.display = 'block';
            progressCount.textContent = `${current}/${total}`;
            progressBar.style.width = `${percentage}%`;
            progressPercent.textContent = `${percentage}%`;
            progressStatus.textContent = status;
            
            if (isComplete) {
                progressText.textContent = '批量创建完成！';
                progressBar.style.background = current === total 
                    ? 'linear-gradient(90deg, #4CAF50, #8BC34A)' 
                    : 'linear-gradient(90deg, #FF9800, #FFC107)';
            } else {
                progressText.textContent = '正在创建沙龙...';
            }
        }
        
        // 确认批量创建
        async function confirmBatchCreate() {
            console.log('confirmBatchCreate 函数被调用');
            console.log('batchSalonData:', batchSalonData);
            console.log('batchSalonData.length:', batchSalonData ? batchSalonData.length : 'undefined');
            
            try {
                if (!batchSalonData || batchSalonData.length === 0) {
                    console.log('没有有效数据，显示提示');
                    alert('没有有效的数据可以创建，请先上传文件！');
                    return;
                }
                
                console.log('开始批量创建，数据量:', batchSalonData.length);
                
                // 如果数据量太大，提醒用户
                if (batchSalonData.length > 100) {
                    const confirm = window.confirm(`您准备创建 ${batchSalonData.length} 个沙龙，数据量较大可能需要较长时间。\n\n建议：\n1. 少于100个为佳\n2. 确保网络稳定\n3. 请耐心等待\n\n是否继续？`);
                    if (!confirm) {
                        return;
                    }
                }
                
                // 禁用创建按钮，防止重复点击
                const confirmBtn = document.getElementById('confirm-batch-btn');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = '创建中...';
                    confirmBtn.style.opacity = '0.6';
                    confirmBtn.style.cursor = 'not-allowed';
                }
                
                // 获取当前用户作为默认负责人（如果没有设置的话）
                const defaultEmployeeId = currentUser ? currentUser.id : '';
                console.log('默认负责人ID:', defaultEmployeeId);
                
                let successCount = 0;
                const batchSize = 5; // 减少每批数量，提高响应性
                
                // 初始化进度条
                updateBatchProgress(0, batchSalonData.length, '准备开始...');
                
                console.log('🚀 开始批量创建沙龙...');
                
                for (let i = 0; i < batchSalonData.length; i++) {
                    const salonData = batchSalonData[i];
                    
                    // 更新进度条
                    updateBatchProgress(i, batchSalonData.length, `正在处理: ${salonData.name}`);
                    
                    // 每处理N个暂停一下，避免过快请求
                    if (i > 0 && i % batchSize === 0) {
                        const progress = Math.round((i / batchSalonData.length) * 100);
                        console.log(`🔄 进度: ${progress}% (${i}/${batchSalonData.length}) - 暂停 50ms...`);
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    console.log(`📝 处理第${i+1}/${batchSalonData.length}个沙龙: ${salonData.name}`);
                    
                    // 设置默认负责人（如果没有设置）
                    if (!salonData.responsibleEmployeeId) {
                        salonData.responsibleEmployeeId = defaultEmployeeId;
                    }
                    
                    // 创建沙龙
                    try {
                        const result = await addSalon(salonData);
                        if (result) {
                            successCount++;
                            console.log(`✅ 第${i+1}个沙龙创建成功: ${salonData.name}`);
                        } else {
                            console.log(`❌ 第${i+1}个沙龙创建失败: ${salonData.name}`);
                        }
                    } catch (error) {
                        console.error(`❌ 第${i+1}个沙龙云端创建失败: ${salonData.name}`, error);
                        // Firebase失败时，尝试本地存储
                        try {
                            const localResult = addSalonToLocalStorage(salonData);
                            if (localResult) {
                                successCount++;
                                console.log(`💾 第${i+1}个沙龙已保存到本地存储: ${salonData.name}`);
                            }
                        } catch (localError) {
                            console.error(`💥 第${i+1}个沙龙本地存储也失败: ${salonData.name}`, localError);
                        }
                    }
                }
                
                // 最终进度条更新
                const finalStatus = successCount === batchSalonData.length 
                    ? `✅ 全部完成！成功创建 ${successCount} 个沙龙`
                    : `⚠️ 部分成功：${successCount}/${batchSalonData.length} 个沙龙创建成功`;
                
                updateBatchProgress(batchSalonData.length, batchSalonData.length, finalStatus, true);
                
                console.log('🎉 批量创建完成！');
                console.log(`📊 总数据: ${batchSalonData.length} 个`);
                console.log(`✅ 成功: ${successCount} 个`);
                console.log(`❌ 失败: ${batchSalonData.length - successCount} 个`);
                
                // 恢复按钮状态
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '确认批量创建';
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                }
                
                if (successCount > 0) {
                    const message = successCount === batchSalonData.length 
                        ? `🎉 批量创建完成！全部 ${successCount} 个沙龙创建成功！`
                        : `⚠️ 批量创建完成！成功创建 ${successCount}/${batchSalonData.length} 个沙龙。\n\n注意：如果Firebase连接失败，数据已保存到本地存储。`;
                    
                    alert(message);
                    
                    // 3秒后自动清理界面并跳转
                    setTimeout(async () => {
                        // 清理数据和界面
                        cancelBatchUpload();
                        
                        // 跳转到沙龙列表页面
                        await showContent('salon-info');
                    }, 3000);
                } else {
                    alert('❌ 批量创建失败！没有成功创建任何沙龙。\n\n可能原因：\n1. 网络连接问题\n2. Firebase配额超出\n3. 数据格式错误\n\n请检查控制台信息或稍后重试。');
                }
                
            } catch (error) {
                console.error('confirmBatchCreate 执行出错:', error);
                alert('批量创建时发生错误: ' + error.message);
            }
        }
        
        // 取消批量上传
        function cancelBatchUpload() {
            batchSalonData = [];
            document.getElementById('file-preview').style.display = 'none';
            document.getElementById('salon-file-upload').value = '';
            
            // 隐藏进度条
            const progressContainer = document.getElementById('batch-progress-container');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            // 恢复按钮状态
            const confirmBtn = document.getElementById('confirm-batch-btn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = '确认批量创建';
                confirmBtn.style.opacity = '1';
                confirmBtn.style.cursor = 'pointer';
            }
        }
        
        // 本地存储备用函数
        function addSalonToLocalStorage(salonData) {
            try {
                const salons = JSON.parse(localStorage.getItem('salons')) || [];
                const newSalon = {
                    id: Date.now() + Math.random(),
                    name: salonData.name,
                    address: salonData.address,
                    businessLicense: salonData.businessLicense || '',
                    district: salonData.district || '',
                    phone: salonData.phone || '',
                    directorName: salonData.directorName || '未指定',
                    directorMobile: salonData.directorMobile || '',
                    responsibleEmployeeId: salonData.responsibleEmployeeId || '',
                    addTime: new Date().toLocaleString('zh-CN'),
                    joinDate: new Date().toISOString(),
                    transactions: [],
                    lastTransactionDate: null
                };
                
                salons.push(newSalon);
                localStorage.setItem('salons', JSON.stringify(salons));
                return true;
            } catch (error) {
                console.error('本地存储失败:', error);
                return false;
            }
        }
        
        // 切换全选状态
        function toggleBatchSelectAll() {
            const selectAllCheckbox = document.getElementById('batch-select-all');
            const salonCheckboxes = document.querySelectorAll('.batch-salon-checkbox');
            
            salonCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // 批量应用负责人
        function applyBatchResponsible() {
            const selectedResponsibleId = document.getElementById('batch-responsible-select').value;
            const checkedCheckboxes = document.querySelectorAll('.batch-salon-checkbox:checked');
            
            if (checkedCheckboxes.length === 0) {
                alert('请先选择要分配负责人的沙龙');
                return;
            }
            
            if (!selectedResponsibleId) {
                alert('请选择要分配的负责人');
                return;
            }
            
            checkedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const selectElement = document.querySelector(`.salon-responsible-select[data-index="${index}"]`);
                
                if (selectElement) {
                    selectElement.value = selectedResponsibleId;
                    // 更新数据
                    updateSalonResponsible(index, selectedResponsibleId);
                }
            });
            
            alert(`已为 ${checkedCheckboxes.length} 个沙龙分配负责人`);
        }
        
        // 更新单个沙龙的负责人
        function updateSalonResponsible(index, responsibleId) {
            if (batchSalonData[index]) {
                batchSalonData[index].responsibleEmployeeId = responsibleId;
            }
        }
        
        // 下载样例模板文件
        function downloadSampleFile() {
            // 检查SheetJS库是否已加载
            if (typeof XLSX === 'undefined') {
                alert('Excel处理库尚未加载完成，请稍后再试！');
                return;
            }
            
            const sampleData = [
                ['살롱 정보 일괄 업로드 템플릿', '', '', ''],  // 第1행：表格标题
                ['업소명', '영업소 주소', '전화번호', '대표자명'],    // 第2행：列标题
                ['미용실 A', '서울 구로구 구로중앙로 12', '02-1234-5678', '김대표'],
                ['헤어샵 B', '서울 영등포구 영등포로 34', '02-2345-6789', '이사장'],
                ['뷰티샵 C', '서울 금천구 금천로 56', '02-3456-7890', '박원장'],
                ['살롱 D', '부산 해운대구 해운대로 78', '051-4567-8901', '최원장']
            ];
            
            // 创建新的工作簿
            const workbook = XLSX.utils.book_new();
            
            // 创建工作表
            const worksheet = XLSX.utils.aoa_to_sheet(sampleData);
            
            // 设置列宽
            worksheet['!cols'] = [
                { width: 25 }, // 업소명/标题
                { width: 35 }, // 영업소 주소
                { width: 15 }, // 전화번호
                { width: 15 }  // 대표자명
            ];
            
            // 合并第一行的单元格作为标题
            worksheet['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }  // 合并第1行的A1到D1单元格
            ];
            
            // 添加工작表到工作簿
            XLSX.utils.book_append_sheet(workbook, worksheet, '沙龙信息');
            
            // 下载Excel文件
            XLSX.writeFile(workbook, 'salon_template_sample.xlsx');
        }
        
        // 更新业务员选择下拉框
        async function updateSalespersonOptions() {
            const selectElement = document.getElementById('salespersonSelect');
            if (!selectElement) return;
            
            const employees = await getEmployees();
            let optionsHtml = `<option value="">${getText('please-select-salesperson')}</option>`;
            
            employees.forEach(employee => {
                // 根据权限过滤可见的业务员
                if (currentUser) {
                    if (currentUser.position === 'admin' || currentUser.position === 'manager') {
                        // 管理员和经理可以看到所有业务员
                        const positionText = getPositionText(employee.position);
                        optionsHtml += `<option value="${employee.id}" ${currentUser.id === employee.id ? 'selected' : ''}>${employee.name} - ${positionText}</option>`;
                    } else if (currentUser.position === 'salesperson' && currentUser.id === employee.id) {
                        // 业务员只能选择自己
                        optionsHtml += `<option value="${employee.id}" selected>${employee.name}</option>`;
                    }
                } else {
                    // 如果没有登录用户（向后兼容），显示所有
                    const positionText = getPositionText(employee.position);
                    optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                }
            });
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 获取业务员手机号
        function getSalespersonMobile(salespersonId) {
            if (!salespersonId) return '';
            const employees = getEmployees();
            const employee = employees.find(emp => emp.id == salespersonId);
            return employee ? employee.mobile : '';
        }
        
        // 显示编辑职员模态框
        async function showEditEmployeeModal(employeeId) {
            const employees = await getEmployees();
            const employee = employees.find(emp => emp.id === employeeId);
            
            if (!employee) return;
            
            // 填充表单数据
            document.getElementById('editEmployeeId').value = employee.id;
            document.getElementById('editEmployeeName').value = employee.name;
            document.getElementById('editEmployeePosition').value = employee.position;
            document.getElementById('editEmployeeUsername').value = employee.username;
            document.getElementById('editEmployeePassword').value = ''; // 密码字段留空
            document.getElementById('editEmployeeMobile').value = employee.mobile;
            
            // 填充银行账户信息
            const bankInfo = employee.bankInfo || {};
            document.getElementById('editEmployeeBankName').value = bankInfo.bankName || '';
            document.getElementById('editEmployeeAccountNumber').value = bankInfo.accountNumber || '';
            document.getElementById('editEmployeeAccountHolder').value = bankInfo.accountHolder || '';
            document.getElementById('editEmployeeBankBranch').value = bankInfo.bankBranch || '';
            
            // 权限控制：经理不能修改管理员权限，业务员不能修改自己的权限，管理员不能调低自己的权限
            const positionSelect = document.getElementById('editEmployeePosition');
            if (currentUser.position === 'manager' && employee.position === 'admin') {
                positionSelect.disabled = true;
            } else if (currentUser.position === 'manager') {
                // 经理只能设置业务员职位
                positionSelect.innerHTML = `
                    <option value="salesperson" data-i18n="salesperson">业务员</option>
                `;
                updateTexts(); // 更新翻译
            } else if (currentUser.position === 'salesperson' && employee.id === currentUser.id) {
                // 业务员不能修改自己的权限等级
                positionSelect.disabled = true;
            } else if (currentUser.position === 'admin' && employee.id === currentUser.id) {
                // 管理员不能调低自己的权限，只能保持管理员
                positionSelect.innerHTML = `
                    <option value="admin" data-i18n="admin" selected>管理员</option>
                `;
                positionSelect.disabled = true;
                updateTexts(); // 更新翻译
            } else {
                positionSelect.disabled = false;
                positionSelect.innerHTML = `
                    <option value="salesperson" data-i18n="salesperson">业务员</option>
                    <option value="manager" data-i18n="manager">经理</option>
                    <option value="admin" data-i18n="admin">管理员</option>
                `;
                updateTexts(); // 更新翻译
            }
            
            // 添加姓名自动填充到账户持有人的功能
            const editNameField = document.getElementById('editEmployeeName');
            const editAccountHolderField = document.getElementById('editEmployeeAccountHolder');
            
            // 移除之前的事件监听器（如果存在）
            editNameField.removeEventListener('input', editNameAutoFill);
            
            // 添加新的事件监听器
            function editNameAutoFill() {
                if (!editAccountHolderField.value.trim() || editAccountHolderField.value === employee.name) {
                    editAccountHolderField.value = editNameField.value.trim();
                }
            }
            editNameField.addEventListener('input', editNameAutoFill);
            
            // 显示模态框
            const modal = document.getElementById('editEmployeeModal');
            modal.style.display = 'flex';
        }
        
        // 关闭编辑职员模态框
        function closeEditEmployeeModal() {
            const modal = document.getElementById('editEmployeeModal');
            modal.style.display = 'none';
            document.getElementById('editEmployeeForm').reset();
        }
        
        // 搜索沙龙功能
        let originalSalonList = [];
        function searchSalons() {
            const searchTerm = document.getElementById('salon-search').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // 如果搜索框为空，但有其他筛选条件，应用筛选
                const selectedResponsible = document.getElementById('responsible-filter').value;
                const selectedDistrict = document.getElementById('district-filter').value;
                
                if (selectedResponsible || selectedDistrict) {
                    filterSalons();
                } else {
                displaySalonList();
                }
                return;
            }
            
            // 有搜索内容时，使用统一筛选逻辑
            filterSalons();
        }
        
        // 显示筛选后的沙龙列表
        function displayFilteredSalonList(salons) {
            const salonListContainer = document.getElementById('salon-list');
            
            // 根据权限进一步筛选
            if (currentUser && currentUser.position === 'salesperson') {
                salons = salons.filter(salon => canSalespersonViewSalon(salon, currentUser.id));
            }
            
            if (salons.length === 0) {
                salonListContainer.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${getText('no-matching-salons')}</p></div>`;
                return;
            }
            
            let html = '';
            salons.forEach((salon, index) => {
                const overdueDays = calculateOverdueDays(salon);
                const overdueColor = overdueDays > 30 ? '#ff6666' : overdueDays > 7 ? '#ffaa00' : '#90EE90';
                const transactionHistory = formatTransactionHistory(salon.transactions, salon.id);
                
                // 状态显示
                let statusText = '';
                if (overdueDays > 30) {
                    statusText = `<span style="color: #ff6666;">（${getText('long-inactive')}）</span>`;
                } else if (overdueDays > 7) {
                    statusText = `<span style="color: #ffaa00;">（${getText('needs-attention')}）</span>`;
                } else {
                    statusText = `<span style="color: #90EE90;">（${getText('active-customer')}）</span>`;
                }
                
                html += `
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 5px; margin-bottom: 15px; border: 1px solid rgba(212, 175, 55, 0.3);">
                        <!-- 折叠头部：沙龙名称和地址 -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="flex-grow: 1; display: flex; align-items: center; gap: 10px;">
                                <button id="salon-toggle-${salon.id}" onclick="toggleSalonCollapse(${salon.id})" style="background: none; border: none; color: var(--gold); font-size: 1.2em; cursor: pointer; padding: 0; width: 20px; text-align: center;" title="展开">▶</button>
                                <div>
                                    <h3 style="color: var(--gold-light); margin: 0;">${salon.name}</h3>
                                    <p style="margin: 2px 0 0 0; color: #cccccc; font-size: 0.9em;">${salon.address}</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="showEditSalonModal(${salon.id})" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('edit-btn')}</button>
                                <button onclick="showAddTransactionModal(${salon.id})" style="background: var(--gold); color: var(--black); border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('add-transaction-btn')}</button>
                            </div>
                        </div>
                        
                        <!-- 可折叠的详细信息 -->
                        <div id="salon-details-${salon.id}" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    ${salon.phone ? `<p><strong>${getText('salon-phone-label')}：</strong> ${salon.phone}</p>` : ''}
                                    <p><strong>${getText('director-name-label')}：</strong> ${salon.directorName}</p>
                                    <p><strong>${getText('director-mobile-label')}：</strong> ${formatMobile(salon.directorMobile)}</p>
                                    <p><strong>${getText('first-join-label')}：</strong> ${salon.addTime}</p>
                                    <p style="color: var(--gold-light);"><strong>${getText('status-label')}：</strong> ${getText('status-active')}</p>
                                </div>
                                
                                <div>
                                    <p><strong>${getText('days-since-last-label')}：</strong> <span style="color: ${overdueColor}; font-weight: bold;">${overdueDays} ${getText('days-unit')}</span> 
                                        ${statusText}
                                    </p>
                                    <p><strong>${getText('transaction-count-label')}：</strong> ${salon.transactions ? salon.transactions.length : 0} ${getText('transaction-unit')}</p>
                                    ${salon.lastTransactionDate ? `<p><strong>${getText('last-transaction-label')}：</strong> ${new Date(salon.lastTransactionDate).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN')}</p>` : `<p><strong>${getText('last-transaction-label')}：</strong> <span style="color: #cccccc;">${getText('no-transaction')}</span></p>`}
                                    
                                    <div style="margin-top: 15px;">
                                        <strong>${getText('recent-transactions-label')}：</strong>
                                        ${transactionHistory}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            salonListContainer.innerHTML = html;
        }
        
        // 清空搜索
        function clearSearch() {
            document.getElementById('salon-search').value = '';
            document.getElementById('district-filter').value = '';
            document.getElementById('responsible-filter').value = '';
            displaySalonList();
        }
        
        // 沙龙综合筛选函数
        function filterSalons() {
            const selectedResponsible = document.getElementById('responsible-filter').value;
            const selectedDistrict = document.getElementById('district-filter').value;
            const searchTerm = document.getElementById('salon-search').value.toLowerCase().trim();
            let salons = getSalons();
            
            // 业务员权限筛选
            if (currentUser && currentUser.position === 'salesperson') {
                salons = salons.filter(salon => canSalespersonViewSalon(salon, currentUser.id));
            }
            
            let filteredSalons = salons;
            
            // 按负责人员筛选
            if (selectedResponsible) {
                filteredSalons = filteredSalons.filter(salon => 
                    salon.responsibleEmployeeId && salon.responsibleEmployeeId.toString() === selectedResponsible
                );
            }
            
            // 按区域筛选
            if (selectedDistrict) {
                filteredSalons = filteredSalons.filter(salon => salon.district === selectedDistrict);
            }
            
            // 按搜索词筛选
            if (searchTerm) {
                filteredSalons = filteredSalons.filter(salon => {
                    return salon.name.toLowerCase().includes(searchTerm) ||
                           salon.directorName.toLowerCase().includes(searchTerm) ||
                           salon.directorMobile.includes(searchTerm);
                });
            }
            
            displayFilteredSalonList(filteredSalons);
        }
        
        // 向后兼容：保留原有函数名
        function filterByDistrict() {
            filterSalons();
        }
        
        // 计算欠款天数
        function calculateOverdueDays(salon) {
            // 确保兼容性，初始化缺失的字段
            if (!salon.transactions) {
                salon.transactions = [];
            }
            
            if (!salon.lastTransactionDate || salon.transactions.length === 0) {
                // 如果没有交易记录，从加入时间开始计算
                const joinDate = salon.joinDate ? new Date(salon.joinDate) : new Date(salon.addTime);
                const today = new Date();
                const diffTime = today - joinDate;
                return Math.floor(diffTime / (1000 * 60 * 60 * 24));
            } else {
                const lastTransaction = new Date(salon.lastTransactionDate);
                const today = new Date();
                const diffTime = today - lastTransaction;
                return Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }
        }
        
        // 格式化交易记录显示
        function formatTransactionHistory(transactions, salonId) {
            if (!transactions || transactions.length === 0) {
                return `<span style="color: #cccccc;">${getText('no-transactions')}</span>`;
            }
            
            let html = '<div style="margin-top: 10px;">';
            // 按时间倒序排列，只显示最新的1条
            const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentTransactions = sortedTransactions.slice(0, 1);
            
            recentTransactions.forEach(transaction => {
                const date = new Date(transaction.date).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
                const totalAmount = transaction.totalAmount || 0;
                const receivedAmount = transaction.receivedAmount || 0;
                const outstandingAmount = transaction.outstandingAmount || (totalAmount - receivedAmount);
                
                // 获取业务员名称
                const salespersonName = transaction.salesperson || getText('unassigned');
                
                html += `
                    <div onclick="event.stopPropagation(); viewTransactionDetail(${salonId}, ${transaction.id});" style="background: rgba(0,0,0,0.2); padding: 8px; margin: 5px 0; border-radius: 3px; font-size: 0.9em; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(212, 175, 55, 0.2)'" onmouseout="this.style.background='rgba(0,0,0,0.2)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="color: var(--gold-light);">${date}</span><br>
                                <span style="color: white;">${transaction.description || ''}</span><br>
                                <span style="color: #cccccc; font-size: 0.8em;">${getText('salesperson-label')}：${salespersonName}</span>
                            </div>
                            <div style="text-align: right;">
                                ${totalAmount > 0 ? `<div><span style="color: #90EE90;">${getText('total-products-amount').replace('：', '')} ${formatCurrency(totalAmount)}</span></div>` : ''}
                                ${receivedAmount > 0 ? `<div><span style="color: #87CEEB;">${getText('received-amount').replace('：', '')} ${formatCurrency(receivedAmount)}</span></div>` : ''}
                                ${outstandingAmount > 0 ? `<div><span style="color: #ff6666;">${getText('current-outstanding').replace('：', '')} ${formatCurrency(outstandingAmount)}</span></div>` : ''}
                            </div>
                        </div>
                        <div style="font-size: 0.8em; color: #cccccc; margin-top: 5px;">${getText('click-to-view-detail')}</div>
                    </div>
                `;
            });
            
            if (transactions.length > 1) {
                const moreCount = transactions.length - 1;
                html += `<div style="text-align: center; color: #cccccc; font-size: 0.8em; margin-top: 5px;">${getText('more-records').replace('{count}', moreCount)}</div>`;
            }
            
            // 添加查看全部交易按钮（只要有交易记录就显示）
            if (transactions.length > 0) {
                html += `<div style="text-align: center; margin-top: 10px;">
                            <button onclick="viewAllTransactions(${salonId}, event)" style="background: var(--gold); color: var(--black); border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('view-all-transactions')}</button>
                         </div>`;
            }
            
            html += '</div>';
            return html;
        }
        
        // 切换沙龙折叠状态（优化版本）
        function toggleSalonCollapse(salonId) {
            const detailsElement = document.querySelector(`.salon-details[data-salon-id="${salonId}"]`);
            const toggleButton = document.querySelector(`.salon-toggle-btn[data-salon-id="${salonId}"]`);
            
            if (!detailsElement || !toggleButton) return;
            
            if (detailsElement.style.display === 'none' || detailsElement.style.display === '') {
                // 展开 - 延迟加载详细信息
                loadSalonDetails(salonId);
                detailsElement.style.display = 'block';
                toggleButton.textContent = '▼';
                toggleButton.title = '收起';
            } else {
                // 收起
                detailsElement.style.display = 'none';
                toggleButton.textContent = '▶';
                toggleButton.title = '展开';
            }
        }

        // 事件委托处理沙龙列表点击事件
        function initializeSalonListEvents() {
            const salonListContainer = document.getElementById('salon-list');
            
            // 移除旧的事件监听器
            salonListContainer.removeEventListener('click', handleSalonListClick);
            salonListContainer.removeEventListener('change', handleSalonListChange);
            
            // 添加新的事件监听器
            salonListContainer.addEventListener('click', handleSalonListClick);
            salonListContainer.addEventListener('change', handleSalonListChange);
        }

        // 处理沙龙列表中的点击事件
        function handleSalonListClick(e) {
            const target = e.target;
            
            // 处理折叠/展开按钮
            if (target.classList.contains('salon-toggle-btn')) {
                const salonId = parseInt(target.dataset.salonId);
                toggleSalonCollapse(salonId);
                return;
            }
            
            // 处理编辑按钮
            if (target.classList.contains('edit-salon-btn')) {
                const salonId = parseInt(target.dataset.salonId);
                showEditSalonModal(salonId);
                return;
            }
            
            // 处理添加交易按钮
            if (target.classList.contains('add-transaction-btn')) {
                const salonId = parseInt(target.dataset.salonId);
                showAddTransactionModal(salonId);
                return;
            }
        }

        // 处理沙龙列表中的change事件
        function handleSalonListChange(e) {
            const target = e.target;
            
            // 处理复选框变化
            if (target.classList.contains('salon-checkbox')) {
                updateBatchControls();
                return;
            }
        }
        
        // 检查业务员是否有权查看某个沙龙
        function canSalespersonViewSalon(salon, salespersonId) {
            // 业务员只能查看指定给自己负责的沙龙
            return salon.responsibleEmployeeId && salon.responsibleEmployeeId.toString() === salespersonId.toString();
        }
        
        // 沙龙列表分页配置
        let currentPage = 1;
        let itemsPerPage = 20; // 每页显示的沙龙数量（可变）
        let currentSalonsData = []; // 当前的沙龙数据
        let currentFilter = null; // 当前的筛选条件
        let currentSortField = 'default'; // 当前排序字段
        let currentSortOrder = ''; // 当前排序顺序
        
        // 操作历史记录分页配置
        let currentHistoryPage = 1;
        let historyItemsPerPage = 20; // 每页显示的历史记录数量（可变）
        let currentHistoryData = []; // 当前的历史记录数据
        
        // 数据对比页面配置
        let currentComparisonOperation = null; // 当前显示的操作记录

        // 显示沙龙列表（优化版本 - 支持分页和排序）
        async function displaySalonList(filteredByDistrict = null, page = 1) {
            const salonListContainer = document.getElementById('salon-list');
            const salonCountText = document.getElementById('salon-count-text');
            let salons = await getSalons();
            
            // 根据权限筛选沙龙列表
            if (currentUser && currentUser.position === 'salesperson') {
                // 业务员只能看到指定给自己负责的沙龙
                salons = salons.filter(salon => canSalespersonViewSalon(salon, currentUser.id));
            }
            
            // 如果有区域筛选
            if (filteredByDistrict) {
                salons = salons.filter(salon => salon.district === filteredByDistrict);
            }
            
            // 应用排序
            if (currentSortField !== 'default') {
                salons = applySalonSort(salons, currentSortField, currentSortOrder);
            }
            
            // 保存当前数据和筛选条件
            currentSalonsData = salons;
            currentFilter = filteredByDistrict;
            currentPage = page;
            
            // 更新沙龙总数显示
            if (filteredByDistrict) {
                salonCountText.setAttribute('data-i18n', 'district-salons-count');
                salonCountText.setAttribute('data-i18n-params', `{"count": "${salons.length}"}`);
                salonCountText.textContent = getText('district-salons-count').replace('{count}', salons.length);
            } else {
                salonCountText.setAttribute('data-i18n', 'total-salons-count');
                salonCountText.setAttribute('data-i18n-params', `{"count": "${salons.length}"}`);
                salonCountText.textContent = getText('total-salons-count').replace('{count}', salons.length);
            }
            
            if (salons.length === 0) {
                let noSalonMessage = getText('no-salon-info');
                let tipMessage = getText('add-salon-tip');
                
                if (currentUser && currentUser.position === 'salesperson') {
                    noSalonMessage = getText('no-salesperson-salons');
                    tipMessage = getText('salesperson-salon-tip');
                }
                
                salonListContainer.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${noSalonMessage}</p><p style="font-size: 0.9em;">${tipMessage}</p></div>`;
                
                // 更新沙龙总数显示
                if (filteredByDistrict) {
                    salonCountText.setAttribute('data-i18n', 'district-salons-count');
                    salonCountText.setAttribute('data-i18n-params', '{"count": "0"}');
                    salonCountText.textContent = getText('district-salons-count').replace('{count}', 0);
                } else {
                    salonCountText.setAttribute('data-i18n', 'total-salons-count');
                    salonCountText.setAttribute('data-i18n-params', '{"count": "0"}');
                    salonCountText.textContent = getText('total-salons-count').replace('{count}', 0);
                }
                return;
            }
            
            // 计算分页
            const totalPages = Math.ceil(salons.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSalons = salons.slice(startIndex, endIndex);
            
            // 渲染沙龙列表
            renderSalonItems(paginatedSalons, startIndex);
            
            // 渲染分页控件
            renderPagination(totalPages, page, salons.length);
            
            // 延迟初始化批量控制状态（不更新排序按钮样式，避免覆盖排序状态）
            requestAnimationFrame(() => {
                updateBatchControls();
            });
        }

        // 渲染沙龙项目（优化版本 - 简化DOM结构，包含醒目提示）
        function renderSalonItems(salons, startIndex) {
            const salonListContainer = document.getElementById('salon-list');
            
            let html = '';
            salons.forEach((salon, index) => {
                const globalIndex = startIndex + index + 1;
                const responsibleEmployeeName = getEmployeeName(salon.responsibleEmployeeId);
                
                // 计算醒目提示（优化：只在需要时计算）
                const daysSinceLastTransaction = calculateOverdueDays(salon);
                // 高效计算警告状态
                const hasLongInactive = daysSinceLastTransaction > 30;
                
                // 计算欠款天数和金额（使用新的高性能函数）
                let outstandingDays = 0;
                let outstandingAmount = 0;
                
                if (salon.transactions && salon.transactions.length > 0) {
                    outstandingDays = calculateOutstandingDays(salon);
                    outstandingAmount = calculateOutstandingAmount(salon);
                }
                
                const hasLongOutstandingDays = outstandingDays > 60; // 超过60天
                const hasHighOutstandingAmount = outstandingAmount > 500000; // 超过50万韩元
                
                // 确定边框颜色和背景色（更新警告逻辑）
                let borderColor = 'rgba(212, 175, 55, 0.3)';
                let backgroundColor = 'rgba(212, 175, 55, 0.1)';
                
                const hasAnyWarning = hasLongInactive || hasLongOutstandingDays || hasHighOutstandingAmount;
                
                if (hasAnyWarning) {
                    if ((hasLongInactive && hasLongOutstandingDays) || (hasLongInactive && hasHighOutstandingAmount) || 
                        (hasLongOutstandingDays && hasHighOutstandingAmount)) {
                        borderColor = '#FF4500'; // 橙红色 - 多重警告
                        backgroundColor = 'rgba(255, 69, 0, 0.1)';
                    } else if (hasLongInactive) {
                        borderColor = '#FFA500'; // 橙色 - 长期未交易
                        backgroundColor = 'rgba(255, 165, 0, 0.1)';
                    } else if (hasLongOutstandingDays) {
                        borderColor = '#FF6666'; // 红色 - 长期欠款天数
                        backgroundColor = 'rgba(255, 102, 102, 0.1)';
                    } else if (hasHighOutstandingAmount) {
                        borderColor = '#FF1493'; // 深粉色 - 高额欠款
                        backgroundColor = 'rgba(255, 20, 147, 0.1)';
                    }
                }
                
                // 生成警告标签
                let warningTags = '';
                if (hasLongInactive) {
                    warningTags += `<span style="background: #FFA500; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-right: 5px;">超${daysSinceLastTransaction}天未订货</span>`;
                }
                if (hasLongOutstandingDays) {
                    warningTags += `<span style="background: #FF6666; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-right: 5px;">欠款${outstandingDays}天</span>`;
                }
                if (hasHighOutstandingAmount) {
                    const formattedAmount = (outstandingAmount / 10000).toFixed(1);
                    warningTags += `<span style="background: #FF1493; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em;">欠款${formattedAmount}万元</span>`;
                }
                
                html += `
                    <div class="salon-item" data-salon-id="${salon.id}" style="background: ${backgroundColor}; padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 2px solid ${borderColor};">
                        <!-- 简化的头部信息 -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex-grow: 1; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="salon-checkbox" data-salon-id="${salon.id}" style="cursor: pointer;">
                                <button class="salon-toggle-btn" data-salon-id="${salon.id}" style="background: none; border: none; color: var(--gold); font-size: 1.1em; cursor: pointer; padding: 0; width: 18px; text-align: center;" title="展开">▶</button>
                                <div style="flex-grow: 1;">
                                    <div style="color: #999; font-size: 0.9em; margin-bottom: 2px;">#${globalIndex}</div>
                                    <h3 style="color: var(--gold-light); margin: 0; font-size: 1.1em;">${salon.name}</h3>
                                    <p style="margin: 2px 0 0 0; color: #cccccc; font-size: 0.9em;">${salon.address}</p>
                                    <p style="margin: 2px 0 0 0; color: #aaa; font-size: 0.8em;">${getText('responsible-employee')}：${responsibleEmployeeName}</p>
                                    ${warningTags ? `<div style="margin-top: 5px;">${warningTags}</div>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="edit-salon-btn" data-salon-id="${salon.id}" style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('edit-btn')}</button>
                                <button class="add-transaction-btn" data-salon-id="${salon.id}" style="background: var(--gold); color: var(--black); border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('add-transaction-btn')}</button>
                            </div>
                        </div>
                        
                        <!-- 详细信息（延迟加载） -->
                        <div class="salon-details" data-salon-id="${salon.id}" style="display: none; margin-top: 15px;">
                            <div class="loading-placeholder" style="text-align: center; color: #999; padding: 20px;">${getText('loading')}...</div>
                        </div>
                    </div>
                `;
            });
            
            salonListContainer.innerHTML = html;
            
            // 初始化事件监听器
            initializeSalonListEvents();
        }
        
        // 计算欠款天数（从最近的实收金额开始计算，超高性能版本）
        function calculateOutstandingDays(salon) {
            if (!salon.transactions || !Array.isArray(salon.transactions) || salon.transactions.length === 0) {
                // 没有交易记录，从开户时间算起
                if (salon.addTime) {
                    const openDate = new Date(salon.addTime);
                    const now = new Date();
                    return Math.floor((now - openDate) / (1000 * 60 * 60 * 24));
                }
                return 0;
            }
            
            // 使用缓存避免重复计算
            if (salon._cachedOutstandingDays !== undefined && salon._lastDaysCalculatedTime) {
                const now = Date.now();
                // 如果缓存时间小于10秒，直接返回缓存值
                if (now - salon._lastDaysCalculatedTime < 10000) {
                    return salon._cachedOutstandingDays;
                }
            }
            
            // 找到最近的收款记录
            let latestReceiptDate = null;
            
            for (let i = 0; i < salon.transactions.length; i++) {
                const transaction = salon.transactions[i];
                if (transaction.status === '收款' || transaction.status === '实收') {
                    const transactionDate = new Date(transaction.date || transaction.time);
                    if (!isNaN(transactionDate.getTime())) {
                        if (!latestReceiptDate || transactionDate > latestReceiptDate) {
                            latestReceiptDate = transactionDate;
                        }
                    }
                }
            }
            
            let daysDiff = 0;
            const now = new Date();
            
            if (latestReceiptDate) {
                // 从最近收款日期算起
                daysDiff = Math.floor((now - latestReceiptDate) / (1000 * 60 * 60 * 24));
            } else {
                // 没有收款记录，从开户时间算起
                const openDate = new Date(salon.addTime);
                daysDiff = Math.floor((now - openDate) / (1000 * 60 * 60 * 24));
            }
            
            // 缓存结果
            salon._cachedOutstandingDays = Math.max(0, daysDiff);
            salon._lastDaysCalculatedTime = Date.now();
            
            return salon._cachedOutstandingDays;
        }
        
        // 计算欠款金额（超高性能版本）
        function calculateOutstandingAmount(salon) {
            if (!salon.transactions || !Array.isArray(salon.transactions) || salon.transactions.length === 0) {
                return 0;
            }
            
            // 使用缓存避免重复计算
            if (salon._cachedOutstandingAmount !== undefined && salon._lastAmountCalculatedTime) {
                const now = Date.now();
                // 如果缓存时间小于10秒，直接返回缓存值
                if (now - salon._lastAmountCalculatedTime < 10000) {
                    return salon._cachedOutstandingAmount;
                }
            }
            
            let totalOutstanding = 0;
            
            // 高性能循环计算
            for (let i = 0; i < salon.transactions.length; i++) {
                const transaction = salon.transactions[i];
                const amount = parseFloat(transaction.amount) || 0;
                
                if (transaction.status === '欠款') {
                    totalOutstanding += amount;
                } else if (transaction.status === '收款' || transaction.status === '实收') {
                    totalOutstanding -= amount;
                }
            }
            
            // 缓存结果
            salon._cachedOutstandingAmount = Math.max(0, totalOutstanding);
            salon._lastAmountCalculatedTime = Date.now();
            
            return salon._cachedOutstandingAmount;
        }

        // 渲染分页控件
        function renderPagination(totalPages, currentPage, totalItems) {
            const salonListContainer = document.getElementById('salon-list');
            
            if (totalPages <= 1) return; // 不需要分页
            
            // 获取翻译文字
            const firstPageText = getText('first-page');
            const prevPageText = getText('prev-page');
            const nextPageText = getText('next-page');
            const lastPageText = getText('last-page');
            const goToPageText = getText('go-to-page');
            const itemsPerPageText = getText('items-per-page');
            const itemsText = getText('items');
            const jumpText = getText('jump');
            const pageInfoText = getText('page-info')
                .replace('{current}', currentPage)
                .replace('{total}', totalPages)
                .replace('{items}', totalItems);
            
            let paginationHtml = `
                <div class="pagination-container" style="display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; flex-wrap: wrap;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === 1 ? '#666' : 'var(--gold)'}; color: ${currentPage === 1 ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${firstPageText}</button>
                        <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === 1 ? '#666' : 'var(--gold)'}; color: ${currentPage === 1 ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${prevPageText}</button>
                        
                        <span style="color: var(--gold); font-size: 0.9em; margin: 0 10px;">${pageInfoText}</span>
                        
                        <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === totalPages ? '#666' : 'var(--gold)'}; color: ${currentPage === totalPages ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${nextPageText}</button>
                        <button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === totalPages ? '#666' : 'var(--gold)'}; color: ${currentPage === totalPages ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${lastPageText}</button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center; margin-left: 20px;">
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="color: var(--gold); font-size: 0.9em;">${goToPageText}：</span>
                            <input type="number" id="page-jump-input" min="1" max="${totalPages}" value="${currentPage}" onkeydown="if(event.key==='Enter')jumpToPage()" style="width: 60px; padding: 6px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 4px; text-align: center; font-size: 0.9em;">
                            <button onclick="jumpToPage()" style="padding: 6px 12px; background: var(--gold); color: var(--black); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">${jumpText}</button>
                        </div>
                        
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="color: var(--gold); font-size: 0.9em;">${itemsPerPageText}</span>
                            <select id="items-per-page-select" onchange="changeItemsPerPage()" style="padding: 6px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 4px; font-size: 0.9em;">
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span style="color: var(--gold); font-size: 0.9em;">${itemsText}</span>
                        </div>
                    </div>
                </div>
            `;
            
            salonListContainer.insertAdjacentHTML('beforeend', paginationHtml);
            
            // 设置每页显示条数选择器的当前值
            const itemsPerPageSelect = document.getElementById('items-per-page-select');
            if (itemsPerPageSelect) {
                itemsPerPageSelect.value = itemsPerPage.toString();
            }
        }

        // 跳转到指定页面
        function goToPage(page) {
            if (page < 1 || page > Math.ceil(currentSalonsData.length / itemsPerPage)) return;
            displaySalonList(currentFilter, page);
        }

        // 通过输入框跳转到指定页面
        function jumpToPage() {
            const input = document.getElementById('page-jump-input');
            if (!input) return;
            
            const page = parseInt(input.value);
            const maxPage = Math.ceil(currentSalonsData.length / itemsPerPage);
            
            if (isNaN(page) || page < 1 || page > maxPage) {
                alert(getText('invalid-page-number').replace('{max}', maxPage));
                input.value = currentPage; // 重置为当前页
                return;
            }
            
            goToPage(page);
        }
        
        // 切换沙龙排序（彻底修复版本）
        function toggleSalonSort(sortField) {
            if (currentSortField === sortField) {
                // 如果是相同字段，切换排序顺序：asc -> desc -> asc
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果是不同字段，设置为新字段，默认正序
                currentSortField = sortField;
                currentSortOrder = 'asc';
            }
            
            // 立即更新按钮样式，不等待任何延迟
            updateAllSortButtonStyles();
            
            // 立即更新列表显示
            displaySalonList(currentFilter, 1);
        }
        
        // 重置排序
        function resetSalonSort() {
            currentSortField = 'default';
            currentSortOrder = '';
            
            // 更新排序按钮样式
            updateAllSortButtonStyles();
            
            // 重新显示列表，保持当前筛选条件，回到第一页
            displaySalonList(currentFilter, 1);
        }
        
        // 改变每页显示条数
        function changeItemsPerPage() {
            const select = document.getElementById('items-per-page-select');
            itemsPerPage = parseInt(select.value);
            
            // 重新显示列表，保持当前筛选和排序条件，回到第一页
            displaySalonList(currentFilter, 1);
        }
        
        // 应用沙龙排序
        function applySalonSort(salons, sortField, sortOrder) {
            if (sortField === 'default') {
                return salons; // 返回原始顺序
            }
            
            return salons.sort((a, b) => {
                let valueA, valueB;
                
                switch (sortField) {
                    case 'name':
                        valueA = a.name ? a.name.toLowerCase() : '';
                        valueB = b.name ? b.name.toLowerCase() : '';
                        break;
                    case 'address':
                        valueA = a.address ? a.address.toLowerCase() : '';
                        valueB = b.address ? b.address.toLowerCase() : '';
                        break;
                    case 'addTime':
                        // 确保日期字符串可以正确比较，如果没有时间则使用默认值
                        valueA = a.addTime ? new Date(a.addTime).getTime() : 0;
                        valueB = b.addTime ? new Date(b.addTime).getTime() : 0;
                        break;
                    case 'lastTransaction':
                        // 最后交易时间排序
                        valueA = a.lastTransactionDate ? new Date(a.lastTransactionDate).getTime() : 0;
                        valueB = b.lastTransactionDate ? new Date(b.lastTransactionDate).getTime() : 0;
                        break;
                    case 'outstandingDays':
                        // 欠款天数排序
                        valueA = calculateOutstandingDays(a);
                        valueB = calculateOutstandingDays(b);
                        break;
                    case 'outstandingAmount':
                        // 欠款金额排序
                        valueA = calculateOutstandingAmount(a);
                        valueB = calculateOutstandingAmount(b);
                        break;
                    default:
                        return 0;
                }
                
                // 如果是时间字段或数值字段，直接比较数值
                if (sortField === 'addTime' || sortField === 'lastTransaction' || sortField === 'outstandingDays' || sortField === 'outstandingAmount') {
                    if (sortOrder === 'asc') {
                        return valueA - valueB;
                    } else {
                        return valueB - valueA;
                    }
                }
                
                // 字符串比较
                if (sortOrder === 'asc') {
                    return valueA.localeCompare(valueB);
                } else {
                    return valueB.localeCompare(valueA);
                }
            });
        }
        
        // 计算沙龙的累积欠款金额（优化性能版本）
        function calculateTotalOutstanding(salon) {
            if (!salon.transactions || !Array.isArray(salon.transactions) || salon.transactions.length === 0) {
                return 0;
            }
            
            // 使用缓存避免重复计算
            if (salon._cachedTotalOutstanding !== undefined && salon._lastCalculatedTime) {
                const now = Date.now();
                // 如果缓存时间小于5秒，直接返回缓存值
                if (now - salon._lastCalculatedTime < 5000) {
                    return salon._cachedTotalOutstanding;
                }
            }
            
            let totalOutstanding = 0;
            // 优化循环，提前退出条件
            for (let i = 0; i < salon.transactions.length; i++) {
                const transaction = salon.transactions[i];
                if (transaction.currentOutstanding) {
                    const amount = parseFloat(transaction.currentOutstanding);
                    if (!isNaN(amount)) {
                        totalOutstanding += amount;
                    }
                }
            }
            
            // 缓存结果
            salon._cachedTotalOutstanding = totalOutstanding;
            salon._lastCalculatedTime = Date.now();
            
            return totalOutstanding;
        }
        
        // 更新排序按钮样式（简化版本 - 鼠标移出时恢复原色）
        function updateSortButtonStyle(button) {
            // 此函数由onmouseout事件调用，恢复原始背景色
            if (button.id === 'sort-default') {
                button.style.background = 'rgba(255, 182, 193, 0.2)';
            } else {
                button.style.background = 'rgba(135, 206, 235, 0.2)';
            }
        }
        
        // 更新所有排序按钮样式（完全重写版本，修复箭头变化问题）
        function updateAllSortButtonStyles() {
            // 获取所有排序按钮
            const sortButtons = document.querySelectorAll('[id^="sort-"]:not(#sort-default)');
            
            sortButtons.forEach(button => {
                const fieldName = button.id.replace('sort-', '');
                let buttonText = '';
                
                // 根据字段名获取对应的翻译文本（支持多语言）
                switch(fieldName) {
                    case 'name':
                        buttonText = currentLanguage === 'ko' ? '살롱명' : '沙龙名称';
                        break;
                    case 'address':
                        buttonText = currentLanguage === 'ko' ? '주소명' : '地址名称';
                        break;
                    case 'addTime':
                        buttonText = currentLanguage === 'ko' ? '추가시간' : '新增时间';
                        break;
                    case 'lastTransaction':
                        buttonText = currentLanguage === 'ko' ? '최종거래' : '最后交易';
                        break;
                    case 'outstandingDays':
                        buttonText = currentLanguage === 'ko' ? '외상일수' : '欠款天数';
                        break;
                    case 'outstandingAmount':
                        buttonText = currentLanguage === 'ko' ? '외상금액' : '欠款金额';
                        break;
                    default:
                        buttonText = fieldName;
                }
                
                // 根据当前排序状态添加正确的箭头
                if (currentSortField === fieldName) {
                    const arrow = currentSortOrder === 'asc' ? ' ↑' : ' ↓';
                    buttonText += arrow;
                } else {
                    // 不是当前字段时显示默认上箭头
                    buttonText += ' ↑';
                }
                
                // 直接设置文本内容
                button.textContent = buttonText;
            });
        }

        // 延迟加载沙龙详细信息
        function loadSalonDetails(salonId) {
            const salon = currentSalonsData.find(s => s.id === salonId);
            if (!salon) return;
            
            const detailsContainer = document.querySelector(`.salon-details[data-salon-id="${salonId}"]`);
            if (!detailsContainer) return;
            
            // 计算相关数据
            const overdueDays = calculateOverdueDays(salon);
            const overdueColor = overdueDays > 30 ? '#ff6666' : overdueDays > 7 ? '#ffaa00' : '#90EE90';
            const transactionHistory = formatTransactionHistory(salon.transactions, salon.id);
            
            // 状态显示
            let statusText = '';
            if (overdueDays > 30) {
                statusText = `<span style="color: #ff6666;">（${getText('long-inactive')}）</span>`;
            } else if (overdueDays > 7) {
                statusText = `<span style="color: #ffaa00;">（${getText('needs-attention')}）</span>`;
            } else {
                statusText = `<span style="color: #90EE90;">（${getText('active-customer')}）</span>`;
            }
            
            const detailsHtml = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        ${salon.phone ? `<p><strong>${getText('salon-phone-label')}：</strong> ${salon.phone}</p>` : ''}
                        <p><strong>${getText('director-name-label')}：</strong> ${salon.directorName}</p>
                        <p><strong>${getText('director-mobile-label')}：</strong> ${formatMobile(salon.directorMobile)}</p>
                        <p><strong>${getText('first-join-label')}：</strong> ${salon.addTime}</p>
                        <p style="color: var(--gold-light);"><strong>${getText('status-label')}：</strong> ${getText('status-active')}</p>
                    </div>
                    
                    <div>
                        <p><strong>${getText('days-since-last-label')}：</strong> <span style="color: ${overdueColor}; font-weight: bold;">${overdueDays} ${getText('days-unit')}</span> 
                            ${statusText}
                        </p>
                        <p><strong>${getText('transaction-count-label')}：</strong> ${salon.transactions ? salon.transactions.length : 0} ${getText('transaction-unit')}</p>
                        ${salon.lastTransactionDate ? `<p><strong>${getText('last-transaction-label')}：</strong> ${new Date(salon.lastTransactionDate).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN')}</p>` : `<p><strong>${getText('last-transaction-label')}：</strong> <span style="color: #cccccc;">${getText('no-transaction')}</span></p>`}
                        
                        <div style="margin-top: 10px;">
                            <strong>${getText('recent-transactions-label')}：</strong>
                            ${transactionHistory}
                        </div>
                    </div>
                </div>
            `;
            
            detailsContainer.innerHTML = detailsHtml;
        }
        
        // 确认删除沙龙
        function confirmDeleteSalon(salonId) {
            const salons = getSalons();
            const salon = salons.find(s => s.id === salonId);
            if (salon && confirm(getText('confirm-delete-salon').replace('{name}', salon.name))) {
                // 检查是否需要审批
                if (currentUser.position === 'admin') {
                    // 管理员直接删除
                                    deleteSalon(salonId);
                displaySalonList(currentFilter, 1); // 刷新列表到第一页
                updateDeleteSalonOptions(); // 更新删除页面的选项
                alert(getText('salon-deleted-success'));
                } else {
                    // 经理和业务员需要审批
                    const description = `删除沙龙：${salon.name} (${salon.address})`;
                    submitApprovalRequest('delete-salon', { salonId: salonId }, description);
                    
                    alert(getText('approval-submitted'));
                }
            }
        }
        
        // 更新删除沙龙页面的选项
        function updateDeleteSalonOptions() {
            const selectElement = document.getElementById('deleteSalonSelect');
            if (!selectElement) return;
            
            const salons = getSalons();
            let optionsHtml = `<option value="">${getText('please-select-salon')}</option>`;
            
            salons.forEach(salon => {
                optionsHtml += `<option value="${salon.id}">${salon.name} - ${salon.address}</option>`;
            });
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 删除选定的沙龙
        function deleteSelectedSalon() {
            const selectElement = document.getElementById('deleteSalonSelect');
            const selectedSalonId = selectElement.value;
            
            if (!selectedSalonId) {
                alert(getText('select-salon-first'));
                return;
            }
            
            const salons = getSalons();
            const salon = salons.find(s => s.id == selectedSalonId);
            
            if (!salon) return;
            
            if (confirm(getText('confirm-delete-salon').replace('{name}', salon.name))) {
                // 检查是否需要审批
                if (currentUser.position === 'admin') {
                    // 管理员直接删除
                deleteSalon(parseInt(selectedSalonId));
                updateDeleteSalonOptions(); // 更新下拉列表
                alert(getText('salon-deleted-success'));
                
                // 如果当前在沙龙信息页面，也刷新那个页面
                const salonInfoPage = document.getElementById('salon-info');
                if (salonInfoPage && salonInfoPage.classList.contains('active')) {
                    displaySalonList(currentFilter, 1); // 刷新到第一页
                    }
                } else {
                    // 经理和业务员需要审批
                    const description = `删除沙龙：${salon.name} (${salon.address})`;
                    submitApprovalRequest('delete-salon', { salonId: parseInt(selectedSalonId) }, description);
                    
                    alert(getText('approval-submitted'));
                }
            }
        }
        
        // 筛选删除沙龙列表（按区域）
        function filterDeleteSalonList() {
            const districtFilter = document.getElementById('delete-district-filter').value;
            const searchValue = document.getElementById('delete-salon-search').value.toLowerCase();
            
            const salons = getSalons();
            let filteredSalons = salons;
            
            // 按区域筛选
            if (districtFilter) {
                filteredSalons = filteredSalons.filter(salon => salon.district === districtFilter);
            }
            
            // 按搜索词筛选
            if (searchValue) {
                filteredSalons = filteredSalons.filter(salon => {
                    return salon.name.toLowerCase().includes(searchValue) ||
                           salon.directorName.toLowerCase().includes(searchValue) ||
                           salon.directorMobile.toLowerCase().includes(searchValue);
                });
            }
            
            updateDeleteSalonOptionsWithFilter(filteredSalons);
        }
        
        // 搜索删除沙龙列表
        function searchDeleteSalons() {
            filterDeleteSalonList(); // 重用筛选逻辑
        }
        
        // 清空删除页面搜索
        function clearDeleteSearch() {
            document.getElementById('delete-salon-search').value = '';
            document.getElementById('delete-district-filter').value = '';
            updateDeleteSalonOptions(); // 重置为显示所有沙龙
        }
        
        // 使用筛选结果更新删除沙龙选项
        function updateDeleteSalonOptionsWithFilter(filteredSalons) {
            const selectElement = document.getElementById('deleteSalonSelect');
            selectElement.innerHTML = `<option value="">${getText('please-select-salon')}</option>`;
            
            filteredSalons.forEach(salon => {
                const option = document.createElement('option');
                option.value = salon.id;
                const districtText = getDistrictText(salon.district);
                option.textContent = `${salon.name} (${districtText}, ${salon.directorName})`;
                selectElement.appendChild(option);
            });
        }
        
        // 显示添加交易记录模态框
        function showAddTransactionModal(salonId) {
            currentSalonId = salonId;
            updateSalespersonOptions(); // 加载业务员选项
            
            // 隐藏产品历史记录区域
            const historySection = document.getElementById('product-history-section');
            if (historySection) {
                historySection.style.display = 'none';
            }
            
            const modal = document.getElementById('transactionModal');
            modal.style.display = 'flex';
            // 如果业务员只能选择自己，则自动聚焦到产品输入
            const salespersonSelect = document.getElementById('salespersonSelect');
            if (salespersonSelect.options.length === 2) { // 只有默认选项和当前用户
                salespersonSelect.selectedIndex = 1;
            }
        }
        
        // 关闭交易记录模态框
        function closeTransactionModal() {
            const modal = document.getElementById('transactionModal');
            modal.style.display = 'none';
            document.getElementById('transactionForm').reset();
            
            // 隐藏产品历史记录区域
            const historySection = document.getElementById('product-history-section');
            if (historySection) {
                historySection.style.display = 'none';
            }
            
            currentSalonId = null;
        }
        
        // 编辑交易记录相关函数
        let editProductRowCounter = 0;
        
        // 显示编辑交易记录模态框
        function showEditTransactionModal() {
            const salons = getSalons();
            const salon = salons.find(s => s.id === currentViewingSalonId);
            if (!salon) return;
            
            const transaction = salon.transactions.find(t => t.id === currentTransactionId);
            if (!transaction) return;
            
            // 填充表单数据
            document.getElementById('editReceivedAmount').value = formatNumber(transaction.receivedAmount || 0);
            document.getElementById('editTransactionNotes').value = transaction.notes || '';
            
            // 填充业务员选择
            updateEditSalespersonOptions();
            if (transaction.salespersonId) {
                document.getElementById('editSalespersonSelect').value = transaction.salespersonId;
            }
            
            // 清空并重新填充产品表格
            document.getElementById('editProductTableBody').innerHTML = '';
            editProductRowCounter = 0;
            
            if (transaction.products && Array.isArray(transaction.products)) {
                transaction.products.forEach(product => {
                    addEditProductRow();
                    const currentRow = editProductRowCounter;
                    const row = document.getElementById(`editProductRow_${currentRow}`);
                    const inputs = row.querySelectorAll('input');
                    inputs[0].value = product.name || '';
                    inputs[1].value = formatNumber(product.unitPrice || 0);
                    inputs[2].value = product.quantity || 0;
                    inputs[3].value = product.giftQuantity || 0;
                    calculateEditRowTotal(currentRow);
                });
            } else {
                addEditProductRow(); // 至少添加一行
            }
            
            calculateEditTotalAmount();
            
            const modal = document.getElementById('editTransactionModal');
            modal.style.display = 'flex';
            updateTexts(); // 更新翻译
        }
        
        // 关闭编辑交易记录模态框
        function closeEditTransactionModal() {
            const modal = document.getElementById('editTransactionModal');
            modal.style.display = 'none';
            document.getElementById('editTransactionForm').reset();
            document.getElementById('editProductTableBody').innerHTML = '';
            editProductRowCounter = 0;
        }
        
        // 更新编辑模式的业务员选项
        function updateEditSalespersonOptions() {
            const selectElement = document.getElementById('editSalespersonSelect');
            const employees = getEmployees();
            
            let optionsHtml = `<option value="">${getText('please-select-salesperson')}</option>`;
            
            // 管理员可以看到所有业务员
            employees.forEach(employee => {
                optionsHtml += `<option value="${employee.id}">${employee.name}</option>`;
            });
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 添加编辑产品行
        function addEditProductRow() {
            editProductRowCounter++;
            const tbody = document.getElementById('editProductTableBody');
            const row = document.createElement('tr');
            row.id = `editProductRow_${editProductRowCounter}`;
            row.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="text" placeholder="产品名称" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="text" placeholder="1,000" oninput="formatEditInputAndCalculate(this, ${editProductRowCounter})" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box; text-align: center;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="number" placeholder="1" min="0" max="99" oninput="calculateEditRowTotal(${editProductRowCounter})" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box; text-align: center;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="number" placeholder="0" min="0" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box; text-align: center;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3); text-align: center; color: var(--gold);" id="editRowTotal_${editProductRowCounter}">
                    ₩0
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3); text-align: center;">
                    <button type="button" onclick="removeEditProductRow(${editProductRowCounter})" style="background: #ff6666; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;" data-i18n="remove">删除</button>
                </td>
            `;
            tbody.appendChild(row);
            updateTexts(); // 更新翻译
            calculateEditTotalAmount();
        }
        
        // 删除编辑产品行
        function removeEditProductRow(rowId) {
            const row = document.getElementById(`editProductRow_${rowId}`);
            if (row) {
                row.remove();
                calculateEditTotalAmount();
            }
        }
        
        // 格式化编辑输入并计算
        function formatEditInputAndCalculate(input, rowId) {
            // 只允许输入数字和小数点
            let value = input.value.replace(/[^\d.]/g, '');
            
            // 确保只有一个小数点
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // 格式化显示
            if (value && !isNaN(parseFloat(value))) {
                const numValue = parseFloat(value);
                input.value = formatNumber(numValue);
            } else if (value === '') {
                input.value = '';
            }
            
            calculateEditRowTotal(rowId);
        }
        
        // 计算编辑单行总金额
        function calculateEditRowTotal(rowId) {
            const row = document.getElementById(`editProductRow_${rowId}`);
            if (!row) return;
            
            const inputs = row.querySelectorAll('input');
            const unitPrice = parseFloat(inputs[1].value.replace(/[^\d.]/g, '')) || 0;
            const quantity = parseFloat(inputs[2].value) || 0;
            const rowTotal = unitPrice * quantity;
            
            document.getElementById(`editRowTotal_${rowId}`).textContent = formatCurrency(rowTotal);
            calculateEditTotalAmount();
        }
        
        // 计算编辑总金额
        function calculateEditTotalAmount() {
            const totalElements = document.querySelectorAll('[id^="editRowTotal_"]');
            let total = 0;
            
            totalElements.forEach(element => {
                const amount = parseFloat(element.textContent.replace(/[^\d.]/g, '')) || 0;
                total += amount;
            });
            
            document.getElementById('editTotalProductsAmount').textContent = formatCurrency(total);
            calculateEditCurrentOutstanding();
        }
        
        // 计算编辑本次欠款
        function calculateEditCurrentOutstanding() {
            const totalAmountText = document.getElementById('editTotalProductsAmount').textContent;
            const totalAmount = parseFloat(totalAmountText.replace(/[^\d.]/g, '')) || 0;
            const receivedAmountInput = document.getElementById('editReceivedAmount');
            let receivedAmount = parseFloat(receivedAmountInput.value.replace(/[^\d.]/g, '')) || 0;
            const currentOutstanding = Math.max(0, totalAmount - receivedAmount);
            
            const currentOutstandingInput = document.getElementById('editCurrentOutstanding');
            currentOutstandingInput.value = formatNumber(currentOutstanding);
            currentOutstandingInput.placeholder = formatNumber(0);
        }
        
        // 格式化编辑实收款输入并计算
        function formatEditReceivedAmountAndCalculate(input) {
            // 只允许输入数字和小数点
            let value = input.value.replace(/[^\d.]/g, '');
            
            // 确保只有一个小数点
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // 格式化显示
            if (value && !isNaN(parseFloat(value))) {
                const numValue = parseFloat(value);
                input.value = formatNumber(numValue);
            } else if (value === '') {
                input.value = '';
            }
            
            calculateEditCurrentOutstanding();
        }
        
        // 获取编辑产品数据
        function getEditProductsData() {
            const tbody = document.getElementById('editProductTableBody');
            const rows = tbody.querySelectorAll('tr');
            const products = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const productName = inputs[0].value.trim();
                const unitPrice = parseFloat(inputs[1].value.replace(/[^\d.]/g, '')) || 0;
                const quantity = parseFloat(inputs[2].value) || 0;
                const giftQuantity = parseFloat(inputs[3].value) || 0;
                
                if (productName && (quantity > 0 || giftQuantity > 0)) {
                    products.push({
                        name: productName,
                        unitPrice: unitPrice,
                        quantity: quantity,
                        giftQuantity: giftQuantity,
                        totalAmount: unitPrice * quantity
                    });
                }
            });
            
            return products;
        }
        
        // 全局变量用于记录当前状态
        let currentSalonId = null;
        let currentTransactionId = null;
        let currentViewingSalonId = null;
        
        // 查看全部交易记录
        function viewAllTransactions(salonId, event) {
            if (event) {
                event.stopPropagation();
            }
            currentViewingSalonId = salonId;
            
            // 隐藏沙龙信息页面
            document.getElementById('salon-info').classList.remove('active');
            // 显示交易记录页面
            document.getElementById('transaction-list').classList.add('active');
            
            displayTransactionList(salonId);
            updateTexts(); // 更新页面文本
        }
        
        // 显示交易记录列表
        function displayTransactionList(salonId) {
            const salons = getSalons();
            const salon = salons.find(s => s.id === salonId);
            if (!salon) return;
            
            // 更新页面标题
            document.getElementById('transaction-list-title').textContent = `${salon.name} - ${getText('transaction-records')}`;
            
            const transactions = salon.transactions || [];
            const container = document.getElementById('transaction-records');
            
            if (transactions.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${getText('no-transactions-found')}</p></div>`;
                return;
            }
            
            // 按日期倒序排列
            const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = ``;
            
            sortedTransactions.forEach(transaction => {
                const date = new Date(transaction.date).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
                const totalAmount = transaction.totalAmount || 0;
                const receivedAmount = transaction.receivedAmount || 0;
                const outstandingAmount = transaction.outstandingAmount || (totalAmount - receivedAmount);
                
                // 获取业务员名称
                const salespersonName = transaction.salesperson || getText('unassigned');
                
                // 生成产品列表显示
                let productsDisplay = '';
                if (transaction.products && Array.isArray(transaction.products)) {
                    const productNames = transaction.products.map(p => p.name).join(', ');
                    productsDisplay = `<p style="margin: 5px 0 0 0; color: white;">${getText('transaction-content')} ${productNames}</p>`;
                } else if (transaction.products && typeof transaction.products === 'string') {
                    // 兼容旧数据格式
                    productsDisplay = `<p style="margin: 5px 0 0 0; color: white;">${getText('products')} ${transaction.products}</p>`;
                }
                
                html += `
                    <div onclick="viewTransactionDetail(${salonId}, ${transaction.id})" style="background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid rgba(212, 175, 55, 0.3); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(212, 175, 55, 0.2)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="color: var(--gold-light); margin: 0 0 10px 0;">${transaction.description || getText('transaction-default')}</h4>
                                <p style="margin: 0; color: #cccccc;">${getText('transaction-date')}: ${date}</p>
                                <p style="margin: 5px 0 0 0; color: #aaaaaa; font-size: 0.9em;">${getText('salesperson-label')}：${salespersonName}</p>
                                ${productsDisplay}
                            </div>
                            <div style="text-align: right;">
                                ${totalAmount > 0 ? `<div style="margin-bottom: 5px;"><span style="color: #90EE90;">${getText('total-products-amount')} ${formatCurrency(totalAmount)}</span></div>` : ''}
                                ${receivedAmount > 0 ? `<div style="margin-bottom: 5px;"><span style="color: #87CEEB;">${getText('received-amount')} ${formatCurrency(receivedAmount)}</span></div>` : ''}
                                ${outstandingAmount > 0 ? `<div><span style="color: #ff6666;">${getText('current-outstanding')} ${formatCurrency(outstandingAmount)}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 查看交易详情
        function viewTransactionDetail(salonId, transactionId) {
            currentViewingSalonId = salonId;
            currentTransactionId = transactionId;
            
            // 隐藏所有其他页面
            document.getElementById('salon-info').classList.remove('active');
            document.getElementById('transaction-list').classList.remove('active');
            // 显示交易详情页面
            document.getElementById('transaction-detail').classList.add('active');
            
            displayTransactionDetail(salonId, transactionId);
            updateTexts(); // 更新页面文本
        }
        
        // 显示交易详情
        function displayTransactionDetail(salonId, transactionId) {
            const salons = getSalons();
            const salon = salons.find(s => s.id === salonId);
            if (!salon) return;
            
            const transaction = salon.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const date = new Date(transaction.date).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
            const totalAmount = transaction.totalAmount || 0;
            const receivedAmount = transaction.receivedAmount || 0;
            const currentOutstanding = transaction.outstandingAmount || (totalAmount - receivedAmount);
            
            // 获取业务员完整信息
            const employees = getEmployees();
            let salespersonInfo = {
                name: transaction.salesperson || getText('unassigned'),
                mobile: ''
            };
            
            if (transaction.salespersonId) {
                const employee = employees.find(emp => emp.id == transaction.salespersonId);
                if (employee) {
                    salespersonInfo.name = employee.name;
                    salespersonInfo.mobile = employee.mobile;
                }
            }
            
            // 代理店名称
            const agentStoreName = '메시아서부지점';
            
            // 计算历史总欠款
            const historicalOutstanding = calculateTotalOutstanding(salonId) - currentOutstanding;
            const totalOutstanding = calculateTotalOutstanding(salonId);
            
            // 生成产品表格
            let productsTable = '';
            if (transaction.products && Array.isArray(transaction.products)) {
                productsTable = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--gold-light); margin-bottom: 10px;">${getText('transaction-content')}</h4>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid var(--gold);">
                            <thead style="background: rgba(212, 175, 55, 0.2);">
                                <tr>
                                    <th style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: left;">${getText('product-name')}</th>
                                    <th style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: center;">${getText('unit-price')}</th>
                                    <th style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: center;">${getText('quantity')}</th>
                                    <th style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: center;">${getText('gift-quantity')}</th>
                                    <th style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: center;">${getText('total-amount')}</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                transaction.products.forEach(product => {
                    productsTable += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid rgba(212, 175, 55, 0.3); color: white;">${product.name}</td>
                            <td style="padding: 8px; border: 1px solid rgba(212, 175, 55, 0.3); color: white; text-align: center;">${formatCurrency(product.unitPrice)}</td>
                            <td style="padding: 8px; border: 1px solid rgba(212, 175, 55, 0.3); color: white; text-align: center;">${product.quantity || 0}</td>
                            <td style="padding: 8px; border: 1px solid rgba(212, 175, 55, 0.3); color: white; text-align: center;">${product.giftQuantity || 0}</td>
                            <td style="padding: 8px; border: 1px solid rgba(212, 175, 55, 0.3); color: white; text-align: center;">${formatCurrency(product.totalAmount)}</td>
                        </tr>`;
                });
                
                productsTable += `
                            </tbody>
                            <tfoot style="background: rgba(212, 175, 55, 0.1);">
                                <tr>
                                    <td colspan="4" style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: right; font-weight: bold;">${getText('total-products-amount')}</td>
                                    <td style="padding: 8px; border: 1px solid var(--gold); color: var(--gold); text-align: center; font-weight: bold;">${formatCurrency(totalAmount)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`;
            } else if (transaction.products && typeof transaction.products === 'string') {
                // 兼容旧数据格式
                productsTable = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--gold-light); margin-bottom: 10px;">${getText('products')}</h4>
                        <p style="color: white; padding: 10px; background: rgba(212, 175, 55, 0.1); border-radius: 5px;">${transaction.products}</p>
                    </div>`;
            }
            
            const container = document.getElementById('transaction-detail-content');
            
            container.innerHTML = `
                <div style="background: rgba(212, 175, 55, 0.1); padding: 25px; border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.3);">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--gold); padding-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; text-align: center;">
                                <h2 style="color: var(--gold); margin: 0;">${getText('print-transaction-title')}</h2>
                                <p style="color: #cccccc; margin: 10px 0 0 0;">${salon.name} - ${date}</p>
                            </div>
                            <div style="flex: 1; text-align: right;">
                                ${currentUser && currentUser.position === 'admin' ? `
                                    <button onclick="showEditTransactionModal()" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-right: 10px;">${getText('edit-transaction')}</button>
                                    <button onclick="confirmDeleteTransaction()" style="background: #ff6666; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">${getText('delete-transaction')}</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px;">
                        <div>
                            <h3 style="color: var(--gold-light); margin-bottom: 15px;">${getText('salon-info')}</h3>
                            <p><strong>${getText('salon-name')}:</strong> ${salon.name}</p>
                            <p><strong>${getText('salon-address')}:</strong> ${salon.address}</p>
                            <p><strong>${getText('director-name-text')}:</strong> ${salon.directorName}</p>
                            <p><strong>${getText('director-mobile-text')}:</strong> ${formatMobile(salon.directorMobile)}</p>
                        </div>
                        
                        <div>
                            <h3 style="color: var(--gold-light); margin-bottom: 15px;">${getText('transaction-detail')}</h3>
                            <p><strong>${getText('transaction-date')}:</strong> ${date}</p>

                            <p><strong>${getText('salesperson-name').replace('：', '')}:</strong> ${salespersonInfo.name}</p>
                            ${salespersonInfo.mobile ? `<p><strong>${getText('salesperson-mobile')}:</strong> ${formatMobile(salespersonInfo.mobile)}</p>` : ''}
                            <p><strong>${getText('agent-store-name')}:</strong> ${agentStoreName}</p>
                            ${transaction.notes ? `<p><strong>${getText('notes')}</strong> ${transaction.notes}</p>` : ''}
                        </div>
                    </div>
                    
                    ${productsTable}
                    
                    <div style="border: 2px solid var(--gold); border-radius: 8px; padding: 20px; background: rgba(0,0,0,0.2);">
                        <h3 style="color: var(--gold-light); margin-bottom: 20px; text-align: center;">${getText('transaction-amount-label')}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 0.9em; color: #cccccc; margin-bottom: 5px;">${getText('total-products-amount')}</div>
                                <div style="font-size: 1.3em; color: #90EE90; font-weight: bold;">${formatCurrency(totalAmount)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #cccccc; margin-bottom: 5px;">${getText('received-amount')}</div>
                                <div style="font-size: 1.3em; color: #87CEEB; font-weight: bold;">${formatCurrency(receivedAmount)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #cccccc; margin-bottom: 5px;">${getText('historical-outstanding')}</div>
                                <div style="font-size: 1.3em; color: #ffaa66; font-weight: bold;">${formatCurrency(historicalOutstanding)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #cccccc; margin-bottom: 5px;">${getText('total-outstanding')}</div>
                                <div style="font-size: 1.3em; color: ${totalOutstanding > 0 ? '#ff6666' : '#90EE90'}; font-weight: bold;">${formatCurrency(totalOutstanding)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 返回导航功能
        function backToSalonInfo() {
            document.getElementById('transaction-list').classList.remove('active');
            document.getElementById('salon-info').classList.add('active');
        }
        
        function backToTransactionList() {
            document.getElementById('transaction-detail').classList.remove('active');
            document.getElementById('transaction-list').classList.add('active');
            // 重新显示交易列表
            if (currentViewingSalonId) {
                displayTransactionList(currentViewingSalonId);
            }
        }
        
        // 日期筛选功能
        function filterTransactions() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert(getText('select-start-end-date'));
                return;
            }
            
            const salons = getSalons();
            const salon = salons.find(s => s.id === currentViewingSalonId);
            if (!salon) return;
            
            const transactions = salon.transactions || [];
            const filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date).toISOString().split('T')[0];
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            // 更新显示
            const container = document.getElementById('transaction-records');
            
            if (filteredTransactions.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${getText('no-transactions-found')}</p></div>`;
                return;
            }
            
            // 按日期倒序排列
            const sortedTransactions = filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = ``;
            
            sortedTransactions.forEach(transaction => {
                const date = new Date(transaction.date).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
                const totalAmount = transaction.totalAmount || 0;
                const receivedAmount = transaction.receivedAmount || 0;
                const outstandingAmount = transaction.outstandingAmount || (totalAmount - receivedAmount);
                
                // 获取业务员名称
                const salespersonName = transaction.salesperson || getText('unassigned');
                
                // 生成产品列表显示
                let productsDisplay = '';
                if (transaction.products && Array.isArray(transaction.products)) {
                    const productNames = transaction.products.map(p => p.name).join(', ');
                    productsDisplay = `<p style="margin: 5px 0 0 0; color: white;">${getText('transaction-content')} ${productNames}</p>`;
                } else if (transaction.products && typeof transaction.products === 'string') {
                    // 兼容旧数据格式
                    productsDisplay = `<p style="margin: 5px 0 0 0; color: white;">${getText('products')} ${transaction.products}</p>`;
                }
                
                html += `
                    <div onclick="viewTransactionDetail(${currentViewingSalonId}, ${transaction.id})" style="background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid rgba(212, 175, 55, 0.3); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(212, 175, 55, 0.2)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="color: var(--gold-light); margin: 0 0 10px 0;">${transaction.description || getText('transaction-default')}</h4>
                                <p style="margin: 0; color: #cccccc;">${getText('transaction-date')}: ${date}</p>
                                <p style="margin: 5px 0 0 0; color: #aaaaaa; font-size: 0.9em;">${getText('salesperson-label')}：${salespersonName}</p>
                                ${productsDisplay}
                            </div>
                            <div style="text-align: right;">
                                ${totalAmount > 0 ? `<div style="margin-bottom: 5px;"><span style="color: #90EE90;">${getText('total-products-amount')} ${formatCurrency(totalAmount)}</span></div>` : ''}
                                ${receivedAmount > 0 ? `<div style="margin-bottom: 5px;"><span style="color: #87CEEB;">${getText('received-amount')} ${formatCurrency(receivedAmount)}</span></div>` : ''}
                                ${outstandingAmount > 0 ? `<div><span style="color: #ff6666;">${getText('current-outstanding')} ${formatCurrency(outstandingAmount)}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 清空日期筛选
        function clearDateFilter() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            displayTransactionList(currentViewingSalonId);
        }
        
        // 打印功能
        function printTransaction() {
            const salons = getSalons();
            const salon = salons.find(s => s.id === currentViewingSalonId);
            if (!salon) return;
            
            const transaction = salon.transactions.find(t => t.id === currentTransactionId);
            if (!transaction) return;
            
            const date = new Date(transaction.date).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
            const totalAmount = transaction.totalAmount || 0;
            const receivedAmount = transaction.receivedAmount || 0;
            const currentOutstanding = transaction.outstandingAmount || (totalAmount - receivedAmount);
            
            // 计算历史总欠款
            const historicalOutstanding = calculateTotalOutstanding(currentViewingSalonId) - currentOutstanding;
            const totalOutstanding = calculateTotalOutstanding(currentViewingSalonId);
            
            // 生成产品表格
            let productsTableHTML = '';
            if (transaction.products && Array.isArray(transaction.products)) {
                productsTableHTML = `
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin: 5px 0;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="padding: 4px; border: 1px solid #000; text-align: left; font-weight: bold; font-size: 10px;">${getText('product-name')}</th>
                                <th style="padding: 4px; border: 1px solid #000; text-align: center; font-weight: bold; font-size: 10px;">${getText('unit-price')}</th>
                                <th style="padding: 4px; border: 1px solid #000; text-align: center; font-weight: bold; font-size: 10px;">${getText('quantity')}</th>
                                <th style="padding: 4px; border: 1px solid #000; text-align: center; font-weight: bold; font-size: 10px;">${getText('total-amount')}</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                transaction.products.forEach(product => {
                    productsTableHTML += `
                        <tr>
                            <td style="padding: 3px; border: 1px solid #000; font-size: 9px;">${product.name}</td>
                            <td style="padding: 3px; border: 1px solid #000; text-align: center; font-size: 9px;">${formatCurrency(product.unitPrice)}</td>
                            <td style="padding: 3px; border: 1px solid #000; text-align: center; font-size: 9px;">${product.quantity}</td>
                            <td style="padding: 3px; border: 1px solid #000; text-align: center; font-size: 9px;">${formatCurrency(product.totalAmount)}</td>
                        </tr>`;
                });
                
                productsTableHTML += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0f0f0; font-weight: bold;">
                                <td colspan="3" style="padding: 4px; border: 1px solid #000; text-align: right; font-size: 10px;">${getText('total-products-amount')}</td>
                                <td style="padding: 4px; border: 1px solid #000; text-align: center; font-size: 10px;">${formatCurrency(totalAmount)}</td>
                            </tr>
                        </tfoot>
                    </table>`;
            }
            
            // 生成单份内容（压缩版，适合A4纸一页两份）
            function generateSingleCopyContent(copyType) {
                return `
                    <div style="width: 100%; padding: 10px; box-sizing: border-box; page-break-inside: avoid; margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 10px; border: 2px solid #000; padding: 8px;">
                            <h2 style="margin: 0; font-size: 16px; font-weight: bold;">${getText('print-transaction-title')}</h2>
                            <div style="margin: 5px 0; font-size: 12px; font-weight: bold; background: #f0f0f0; padding: 3px; border: 1px solid #000;">
                                ${copyType}
                            </div>
                            <p style="margin: 3px 0; font-size: 11px;">${salon.name} - ${date}</p>
                            ${transaction.salesperson ? `<p style="margin: 2px 0; font-size: 10px;">${getText('salesperson-name')} ${transaction.salesperson}</p>` : ''}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 10px;">
                            <div style="width: 48%;">
                                <h3 style="margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 2px;">${getText('salon-info')}</h3>
                                <p style="margin: 2px 0;"><strong>${getText('salon-name')}:</strong> ${salon.name}</p>
                                <p style="margin: 2px 0;"><strong>${getText('salon-address')}:</strong> ${salon.address}</p>
                                <p style="margin: 2px 0;"><strong>${getText('director-name-text')}:</strong> ${salon.directorName}</p>
                                <p style="margin: 2px 0;"><strong>${getText('director-mobile-text')}:</strong> ${formatMobile(salon.directorMobile)}</p>
                            </div>
                            
                            <div style="width: 48%;">
                                <h3 style="margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 2px;">${getText('transaction-detail')}</h3>
                                <p style="margin: 2px 0;"><strong>${getText('transaction-date')}:</strong> ${date}</p>
                                ${transaction.salesperson ? `<p style="margin: 2px 0;"><strong>${getText('salesperson-name').replace('：', '')}:</strong> ${transaction.salesperson}</p>` : ''}
                                ${transaction.salesperson ? `<p style="margin: 2px 0;"><strong>업무원 연락처:</strong> ${getSalespersonMobile(transaction.salespersonId)}</p>` : ''}
                                <p style="margin: 2px 0;"><strong>대리점명:</strong> 메시아서부지점</p>
                                ${transaction.notes ? `<p style="margin: 2px 0;"><strong>${getText('notes')}:</strong> ${transaction.notes}</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <h3 style="margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 2px;">${getText('transaction-content')}</h3>
                            ${productsTableHTML}
                        </div>
                        
                        <div style="border: 2px solid #000; padding: 8px; background: #f9f9f9;">
                            <h3 style="margin: 0 0 8px 0; font-size: 12px; text-align: center;">${getText('transaction-amount-label')}</h3>
                            <div style="display: flex; justify-content: space-between;">
                                <div style="text-align: center; width: 24%;">
                                    <div style="font-size: 9px; margin-bottom: 2px; color: #666;">${getText('total-products-amount')}</div>
                                    <div style="font-size: 12px; font-weight: bold; color: #008000;">${formatCurrency(totalAmount)}</div>
                                </div>
                                <div style="text-align: center; width: 24%;">
                                    <div style="font-size: 9px; margin-bottom: 2px; color: #666;">${getText('received-amount')}</div>
                                    <div style="font-size: 12px; font-weight: bold; color: #0066cc;">${formatCurrency(receivedAmount)}</div>
                                </div>
                                <div style="text-align: center; width: 24%;">
                                    <div style="font-size: 9px; margin-bottom: 2px; color: #666;">${getText('historical-outstanding')}</div>
                                    <div style="font-size: 12px; font-weight: bold; color: #ff8800;">${formatCurrency(historicalOutstanding)}</div>
                                </div>
                                <div style="text-align: center; width: 24%;">
                                    <div style="font-size: 9px; margin-bottom: 2px; color: #666;">${getText('total-outstanding')}</div>
                                    <div style="font-size: 14px; font-weight: bold; color: ${totalOutstanding > 0 ? '#cc0000' : '#008000'}; border: 2px solid ${totalOutstanding > 0 ? '#cc0000' : '#008000'}; padding: 3px;">${formatCurrency(totalOutstanding)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${getText('print-transaction-title')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 10mm;
                        }
                        
                        body {
                            font-family: 'Microsoft YaHei', 'SimSun', Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            color: #000;
                            background: #fff;
                            font-size: 12px;
                            line-height: 1.3;
                        }
                        
                        h2, h3 {
                            color: #000;
                        }
                        
                        p {
                            margin: 5px 0;
                            line-height: 1.4;
                        }
                        
                        strong {
                            font-weight: bold;
                        }
                        
                        table {
                            border-collapse: collapse;
                            width: 100%;
                        }
                        
                        th, td {
                            border: 1px solid #000;
                            padding: 6px;
                            text-align: left;
                        }
                        
                        th {
                            background: #f0f0f0;
                            font-weight: bold;
                            text-align: center;
                        }
                        
                        .copy-separator {
                            height: 15px;
                            border-bottom: 2px dashed #000;
                            margin: 10px 0;
                            position: relative;
                        }
                        
                        .copy-separator::after {
                            content: "✂";
                            position: absolute;
                            right: 10px;
                            top: -8px;
                            background: white;
                            padding: 0 3px;
                            font-size: 14px;
                        }
                        
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                            }
                            
                            .copy-separator {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${generateSingleCopyContent(getText('copy-for-director'))}
                    
                    <div class="copy-separator"></div>
                    
                    ${generateSingleCopyContent(getText('copy-for-agent'))}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
        }
        
        // 产品表格管理
        let productRowCounter = 0;
        
        // 添加产品行
        function addProductRow() {
            productRowCounter++;
            const tbody = document.getElementById('productTableBody');
            const row = document.createElement('tr');
            row.id = `productRow_${productRowCounter}`;
            row.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="text" placeholder="产品名称" oninput="checkProductHistory(this)" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="text" placeholder="1,000" oninput="formatInputAndCalculate(this, ${productRowCounter})" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box; text-align: center;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="number" placeholder="1" min="0" max="99" oninput="calculateRowTotal(${productRowCounter})" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box; text-align: center;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                    <input type="number" placeholder="0" min="0" style="width: 100%; padding: 5px; background: transparent; border: 1px solid rgba(212, 175, 55, 0.5); color: var(--text-light); border-radius: 3px; box-sizing: border-box; text-align: center;">
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3); text-align: center; color: var(--gold);" id="rowTotal_${productRowCounter}">
                    ₩0
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(212, 175, 55, 0.3); text-align: center;">
                    <button type="button" onclick="removeProductRow(${productRowCounter})" style="background: #ff6666; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;" data-i18n="remove">删除</button>
                </td>
            `;
            tbody.appendChild(row);
            updateTexts(); // 更新翻译
            calculateTotalAmount();
        }
        
        // 删除产品行
        function removeProductRow(rowId) {
            const row = document.getElementById(`productRow_${rowId}`);
            if (row) {
                row.remove();
                calculateTotalAmount();
            }
        }
        
        // 格式化输入并计算
        function formatInputAndCalculate(input, rowId) {
            // 只允许输入数字和小数点
            let value = input.value.replace(/[^\d.]/g, '');
            
            // 确保只有一个小数点
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // 格式化显示
            if (value && !isNaN(parseFloat(value))) {
                const numValue = parseFloat(value);
                input.value = formatNumber(numValue);
            } else if (value === '') {
                input.value = '';
            }
            
            calculateRowTotal(rowId);
        }
        
        // 计算单行总金额（不包括赠送数量）
        function calculateRowTotal(rowId) {
            const row = document.getElementById(`productRow_${rowId}`);
            if (!row) return;
            
            const inputs = row.querySelectorAll('input');
            const unitPrice = parseFloat(inputs[1].value.replace(/[^\d.]/g, '')) || 0;
            const quantity = parseFloat(inputs[2].value) || 0;  // 只计算出库数量，不包括赠送
            const rowTotal = unitPrice * quantity;
            
            document.getElementById(`rowTotal_${rowId}`).textContent = formatCurrency(rowTotal);
            calculateTotalAmount();
        }
        
        // 计算总金额
        function calculateTotalAmount() {
            const totalElements = document.querySelectorAll('[id^="rowTotal_"]');
            let total = 0;
            
            totalElements.forEach(element => {
                const amount = parseFloat(element.textContent.replace(/[^\d.]/g, '')) || 0;
                total += amount;
            });
            
            document.getElementById('totalProductsAmount').textContent = formatCurrency(total);
            calculateCurrentOutstanding();
        }
        
        // 计算本次欠款
        function calculateCurrentOutstanding() {
            const totalAmountText = document.getElementById('totalProductsAmount').textContent;
            const totalAmount = parseFloat(totalAmountText.replace(/[^\d.]/g, '')) || 0;
            const receivedAmountInput = document.getElementById('receivedAmount');
            let receivedAmount = parseFloat(receivedAmountInput.value.replace(/[^\d.]/g, '')) || 0;
            const currentOutstanding = Math.max(0, totalAmount - receivedAmount);
            
            const currentOutstandingInput = document.getElementById('currentOutstanding');
            currentOutstandingInput.value = formatNumber(currentOutstanding);
            currentOutstandingInput.placeholder = formatNumber(0);
        }
        
        // 格式化实收款输入并计算
        function formatReceivedAmountAndCalculate(input) {
            // 只允许输入数字和小数点
            let value = input.value.replace(/[^\d.]/g, '');
            
            // 确保只有一个小数点
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // 格式化显示
            if (value && !isNaN(parseFloat(value))) {
                const numValue = parseFloat(value);
                input.value = formatNumber(numValue);
            } else if (value === '') {
                input.value = '';
            }
            
            calculateCurrentOutstanding();
        }
        
        // 获取产品列表数据
        function getProductsData() {
            const tbody = document.getElementById('productTableBody');
            const rows = tbody.querySelectorAll('tr');
            const products = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const productName = inputs[0].value.trim();
                const unitPrice = parseFloat(inputs[1].value.replace(/[^\d.]/g, '')) || 0;
                const quantity = parseFloat(inputs[2].value) || 0;
                const giftQuantity = parseFloat(inputs[3].value) || 0;
                
                if (productName && (quantity > 0 || giftQuantity > 0)) {
                    products.push({
                        name: productName,
                        unitPrice: unitPrice,
                        quantity: quantity,
                        giftQuantity: giftQuantity,
                        totalAmount: unitPrice * quantity  // 只计算销售数量，不包括赠送
                    });
                }
            });
            
            return products;
        }
        
        // 计算沙龙的历史总欠款
        function calculateTotalOutstanding(salonId) {
            const salons = getSalons();
            const salon = salons.find(s => s.id === salonId);
            if (!salon || !salon.transactions) return 0;
            
            let totalOutstanding = 0;
            salon.transactions.forEach(transaction => {
                const products = transaction.products || [];
                let transactionTotal = 0;
                products.forEach(product => {
                    transactionTotal += product.totalAmount || 0;
                });
                
                const receivedAmount = transaction.receivedAmount || 0;
                const transactionOutstanding = transactionTotal - receivedAmount;
                totalOutstanding += transactionOutstanding;
            });
            
            return totalOutstanding;
        }
        
        // 处理交易记录表单提交
        document.addEventListener('DOMContentLoaded', async function() {
            // 初始化系统，创建默认管理员账号
            await initializeSystem();
            
            // 页面加载时添加一行产品
            addProductRow();
            
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const salespersonId = document.getElementById('salespersonSelect').value;
                const products = getProductsData();
                const receivedAmount = parseFloat(document.getElementById('receivedAmount').value.replace(/[^\d.]/g, '')) || 0;
                const currentOutstanding = parseFloat(document.getElementById('currentOutstanding').value.replace(/[^\d.]/g, '')) || 0;
                const notes = document.getElementById('transactionNotes').value.trim();
                
                if (!salespersonId) {
                    alert(translations[currentLanguage]['please-select-salesperson']);
                    return;
                }
                
                if (products.length === 0) {
                    alert(translations[currentLanguage]['add-at-least-one-product']);
                    return;
                }
                
                // 获取业务员信息
                const employees = getEmployees();
                const selectedEmployee = employees.find(emp => emp.id == salespersonId);
                
                // 计算产品总金额
                let totalProductsAmount = 0;
                products.forEach(product => {
                    totalProductsAmount += product.totalAmount;
                });
                
                if (currentSalonId) {
                    const transaction = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        salesperson: selectedEmployee ? selectedEmployee.name : '',
                        salespersonId: selectedEmployee ? selectedEmployee.id : null,
                        products: products,
                        totalAmount: totalProductsAmount,
                        receivedAmount: receivedAmount,
                        outstandingAmount: currentOutstanding,
                        notes: notes
                    };
                    
                    addTransaction(currentSalonId, transaction);
                    
                    // 清空表单
                    document.getElementById('transactionForm').reset();
                    // 清空产品表格
                    document.getElementById('productTableBody').innerHTML = '';
                    productRowCounter = 0;
                    addProductRow(); // 重新添加一行
                    updateSalespersonOptions(); // 重新加载业务员选项
                    
                    // 隐藏产品历史记录区域
                    const historySection = document.getElementById('product-history-section');
                    if (historySection) {
                        historySection.style.display = 'none';
                    }
                    
                    displaySalonList(currentFilter, currentPage); // 保持当前筛选和页面
                    closeTransactionModal();
                    alert(getText('transaction-added-success'));
                    
                    // 跳转到历史交易记录页面
                    viewAllTransactions(currentSalonId);
                }
            });
            
            // 交易模态框不允许点击外部关闭，只能通过按钮关闭
            // document.getElementById('transactionModal').addEventListener('click', function(e) {
            //     if (e.target === this) {
            //         closeTransactionModal();
            //     }
            // });
            
            // 编辑交易记录表单提交处理
            document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const salespersonId = document.getElementById('editSalespersonSelect').value;
                const products = getEditProductsData();
                const receivedAmount = parseFloat(document.getElementById('editReceivedAmount').value.replace(/[^\d.]/g, '')) || 0;
                const currentOutstanding = parseFloat(document.getElementById('editCurrentOutstanding').value.replace(/[^\d.]/g, '')) || 0;
                const notes = document.getElementById('editTransactionNotes').value.trim();
                
                if (!salespersonId) {
                    alert(translations[currentLanguage]['please-select-salesperson']);
                    return;
                }
                
                if (products.length === 0) {
                    alert(translations[currentLanguage]['add-at-least-one-product']);
                    return;
                }
                
                // 获取业务员信息
                const employees = getEmployees();
                const selectedEmployee = employees.find(emp => emp.id == salespersonId);
                
                // 计算产品总金额
                let totalProductsAmount = 0;
                products.forEach(product => {
                    totalProductsAmount += product.totalAmount;
                });
                
                // 更新交易记录
                const updatedTransaction = {
                    id: currentTransactionId,
                    date: new Date().toISOString(), // 更新时间
                    salesperson: selectedEmployee ? selectedEmployee.name : '',
                    salespersonId: selectedEmployee ? selectedEmployee.id : null,
                    products: products,
                    totalAmount: totalProductsAmount,
                    receivedAmount: receivedAmount,
                    outstandingAmount: currentOutstanding,
                    notes: notes
                };
                
                updateTransaction(currentViewingSalonId, updatedTransaction);
                
                closeEditTransactionModal();
                displayTransactionDetail(currentViewingSalonId, currentTransactionId); // 刷新详情页面
                displaySalonList(currentFilter, currentPage); // 保持当前筛选和页面
                alert(getText('transaction-updated-success'));
            });
            
            // 编辑交易模态框不允许点击外部关闭，只能通过按钮关闭
            // document.getElementById('editTransactionModal').addEventListener('click', function(e) {
            //     if (e.target === this) {
            //         closeEditTransactionModal();
            //     }
            // });
        });
        
        // 显示子菜单（支持展开/收起切换）
        function showSubmenu(menuType) {
            const targetSubmenu = document.getElementById(menuType + '-submenu');
            
            if (targetSubmenu) {
                // 如果当前子菜单已经展开，则收起它
                if (targetSubmenu.classList.contains('active')) {
                    targetSubmenu.classList.remove('active');
                } else {
                    // 先隐藏所有其他子菜单
                    const allSubmenus = document.querySelectorAll('.submenu');
                    allSubmenus.forEach(submenu => {
                        submenu.classList.remove('active');
                    });
                    
                    // 显示点击的子菜单
                    targetSubmenu.classList.add('active');
                }
            }
        }
        
        // 更新负责职员选项
        async function updateResponsibleEmployeeOptions() {
            const selectElement = document.getElementById('responsibleEmployee');
            if (!selectElement) return;
            
            const employees = await getEmployees();
            let optionsHtml = `<option value="">${getText('please-select-employee')}</option>`;
            optionsHtml += `<option value="unassigned">${getText('unassigned')}</option>`;
            
            if (currentUser) {
                if (currentUser.position === 'admin') {
                    // 管理员可以选择所有人
                    employees.forEach(employee => {
                        const positionText = getPositionText(employee.position);
                        optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                    });
                } else if (currentUser.position === 'manager') {
                    // 经理可以选择业务员
                    employees.forEach(employee => {
                        if (employee.position === 'salesperson') {
                            const positionText = getPositionText(employee.position);
                            optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                        }
                    });
                } else if (currentUser.position === 'salesperson') {
                    // 业务员只能选择自己，并且默认选中
                    const positionText = getPositionText(currentUser.position);
                    optionsHtml = `<option value="">${getText('please-select-employee')}</option>`;
                    optionsHtml += `<option value="unassigned">${getText('unassigned')}</option>`;
                    optionsHtml += `<option value="${currentUser.id}" selected>${currentUser.name} - ${positionText}</option>`;
                }
            }
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 更新编辑沙龙的负责职员选项
        async function updateEditResponsibleEmployeeOptions() {
            const selectElement = document.getElementById('editResponsibleEmployee');
            if (!selectElement) return;
            
            const employees = await getEmployees();
            let optionsHtml = `<option value="">${getText('please-select-employee')}</option>`;
            optionsHtml += `<option value="unassigned">${getText('unassigned')}</option>`;
            
            if (currentUser) {
                if (currentUser.position === 'admin') {
                    // 管理员可以选择所有人
                    employees.forEach(employee => {
                        const positionText = getPositionText(employee.position);
                        optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                    });
                } else if (currentUser.position === 'manager') {
                    // 经理可以选择业务员
                    employees.forEach(employee => {
                        if (employee.position === 'salesperson') {
                            const positionText = getPositionText(employee.position);
                            optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                        }
                    });
                } else if (currentUser.position === 'salesperson') {
                    // 业务员只能选择自己
                    const positionText = getPositionText(currentUser.position);
                    optionsHtml = `<option value="">${getText('please-select-employee')}</option>`;
                    optionsHtml += `<option value="unassigned">${getText('unassigned')}</option>`;
                    optionsHtml += `<option value="${currentUser.id}" selected>${currentUser.name} - ${positionText}</option>`;
                }
            }
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 显示内容区域
        async function showContent(contentId, event) {
            if (event) {
                event.stopPropagation(); // 阻止事件冒泡
            }
            
            // 权限检查：删除功能只有管理员可以访问
            if (contentId === 'delete-salon' || contentId === 'delete-employee') {
                if (!hasPermission('admin')) {
                    alert(contentId === 'delete-salon' ? getText('no-permission-delete-salon') : getText('no-permission-delete-employee'));
                    return;
                }
            }
            
            // 隐藏主菜单
            document.getElementById('main-menu').style.display = 'none';
            
            // 隐藏所有内容区域
            const allContent = document.querySelectorAll('.content-area');
            allContent.forEach(content => {
                content.classList.remove('active');
            });
            
            // 显示选择的内容区域
            const targetContent = document.getElementById(contentId);
            if (targetContent) {
                targetContent.classList.add('active');
                
                // 如果是沙龙信息页面，刷新列表和筛选选项
                if (contentId === 'salon-info') {
                    // 重置排序状态为默认
                    currentSortField = 'default';
                    currentSortOrder = '';
                    await updateResponsibleFilterOptions();
                    await displaySalonList(null, 1); // 初始化时显示第一页
                }
                
                // 如果是新增沙龙页面，更新负责职员选项
                if (contentId === 'new-salon') {
                    await updateResponsibleEmployeeOptions();
                    checkBatchUploadPermission();
                }
                
                // 如果是删除沙龙页面，更新选项
                if (contentId === 'delete-salon') {
                    await updateDeleteSalonOptions();
                }
                
                // 如果是职员列表页面，刷新列表
                if (contentId === 'employee-list') {
                    await displayEmployeeList();
                }
                
                // 如果是新增职员页面，根据权限设置职位选项
                if (contentId === 'new-employee') {
                    const positionSelect = document.getElementById('employeePosition');
                    if (currentUser && currentUser.position === 'manager') {
                        // 经理只能创建业务员
                        positionSelect.innerHTML = `<option value="salesperson" data-i18n="salesperson">业务员</option>`;
                    } else {
                        // 管理员可以创建所有级别
                        positionSelect.innerHTML = `
                            <option value="salesperson" data-i18n="salesperson">业务员</option>
                            <option value="manager" data-i18n="manager">经理</option>
                            <option value="admin" data-i18n="admin">管理员</option>
                        `;
                    }
                    updateTexts(); // 更新翻译
                }
                
                // 如果是删除职员页面，更新选项
                if (contentId === 'delete-employee') {
                    await updateDeleteEmployeeOptions();
                }
                
                // 如果是操作历史页面，加载历史记录
                if (contentId === 'operation-history') {
                    displayOperationHistory();
                }
                
                // 如果是审计报告页面，生成报告
                if (contentId === 'audit-report') {
                    displayAuditReport();
                }
                
                // 如果是审批管理页面，显示审批列表
                if (contentId === 'approval-management') {
                    displayApprovalList();
                }
                
                // 如果是业绩目标页面，初始化业绩目标
                if (contentId === 'performance-target') {
                    initializePerformanceTargets();
                }
            }
        }
        
        // 返回主菜单
        function backToMenu() {
            // 清除数据对比页面的操作记录
            currentComparisonOperation = null;
            
            // 隐藏所有内容区域
            const allContent = document.querySelectorAll('.content-area');
            allContent.forEach(content => {
                content.classList.remove('active');
            });
            
            // 隐藏所有子菜单
            const allSubmenus = document.querySelectorAll('.submenu');
            allSubmenus.forEach(submenu => {
                submenu.classList.remove('active');
            });
            
            // 显示主菜单
            document.getElementById('main-menu').style.display = 'grid';
        }
        
        // 点击M logo返回首页
        function goToHomePage() {
            // 清除数据对比页面的操作记录
            currentComparisonOperation = null;
            
            // 隐藏所有内容区域
            const allContent = document.querySelectorAll('.content-area');
            allContent.forEach(content => {
                content.classList.remove('active');
            });
            
            // 隐藏所有子菜单
            const allSubmenus = document.querySelectorAll('.submenu');
            allSubmenus.forEach(submenu => {
                submenu.classList.remove('active');
            });
            
            // 显示主菜单
            document.getElementById('main-menu').style.display = 'grid';
            
            // 记录操作历史
            if (currentUser) {
                recordOperation(
                    'navigation',
                    'system',
                    null,
                    '首页导航',
                    `${currentUser.name} 通过点击Logo返回首页`,
                    null,
                    null
                );
            }
        }
        
        // 处理新增沙龙表单提交
        document.getElementById('newSalonForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const salonName = document.getElementById('salonName').value;
            const salonAddress = document.getElementById('salonAddress').value;
            const businessLicense = document.getElementById('businessLicense').value;
            const salonDistrict = document.getElementById('salonDistrict').value;
            const salonPhone = document.getElementById('salonPhone').value;
            const directorName = document.getElementById('directorName').value;
            const directorMobile = document.getElementById('directorMobile').value;
            const responsibleEmployeeId = document.getElementById('responsibleEmployee').value;
            
            // 所有字段都改为可选填，只需要有沙龙名称即可
            if (salonName) {
                // 保存沙龙信息
                const newSalon = {
                    name: salonName,
                    address: salonAddress,
                    businessLicense: businessLicense,
                    district: salonDistrict,
                    phone: salonPhone,
                    directorName: directorName,
                    directorMobile: directorMobile,
                    responsibleEmployeeId: responsibleEmployeeId
                };
                
                // 检查是否需要审批
                if (currentUser.position === 'admin') {
                    // 管理员直接添加
                    const addResult = await addSalon(newSalon);
                    
                    if (addResult) {
                        let alertMessage = getText('salon-added-success') + '\n\n' + getText('salon-name-text') + '：' + salonName + '\n' + getText('salon-address-text') + '：' + salonAddress;
                        if (salonPhone) {
                            alertMessage += '\n' + getText('salon-phone-text') + '：' + salonPhone;
                        }
                        alertMessage += '\n' + getText('director-name-text') + '：' + directorName + '\n' + getText('director-mobile-text') + '：' + directorMobile;
                        alert(alertMessage);
                        // 清空表单
                        this.reset();
                        await updateResponsibleEmployeeOptions(); // 重置负责职员选项
                        // 跳转到沙龙列表页面
                        await showContent('salon-info');
                    } else {
                        alert('添加沙龙失败，请稍后重试！');
                    }
                } else {
                    // 经理和业务员需要审批
                    const description = `新增沙龙：${salonName} (${salonAddress})`;
                    submitApprovalRequest('create-salon', newSalon, description);
                    
                    alert(getText('approval-submitted'));
                    // 清空表单
                    this.reset();
                    await updateResponsibleEmployeeOptions(); // 重置负责职员选项
                    // 跳转到沙龙列表页面
                    await showContent('salon-info');
                }
            } else {
                alert(getText('salon-name-required'));
            }
        });
        
        // 新增职员姓名自动填充到账户持有人
        document.getElementById('employeeName').addEventListener('input', function(e) {
            const accountHolderField = document.getElementById('employeeAccountHolder');
            if (!accountHolderField.value.trim()) {
                accountHolderField.value = e.target.value.trim();
            }
        });
        

        
        // 处理新增职员表单提交
        document.getElementById('newEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const employeeName = document.getElementById('employeeName').value.trim();
            const employeePosition = document.getElementById('employeePosition').value;
            const employeeUsername = document.getElementById('employeeUsername').value.trim();
            const employeePassword = document.getElementById('employeePassword').value.trim();
            const employeeMobile = document.getElementById('employeeMobile').value.trim();
            
            // 银行账户信息（可选）
            const bankName = document.getElementById('employeeBankName').value.trim();
            const accountNumber = document.getElementById('employeeAccountNumber').value.trim();
            const accountHolder = document.getElementById('employeeAccountHolder').value.trim() || employeeName; // 默认使用职员姓名
            const bankBranch = document.getElementById('employeeBankBranch').value.trim();
            
            if (employeeName && employeePosition && employeeUsername && employeePassword && employeeMobile) {
                // 权限验证：经理不能创建管理员或其他经理
                if (currentUser.position === 'manager' && (employeePosition === 'admin' || employeePosition === 'manager')) {
                    alert(getText('cannot-edit-admin-permission'));
                    return;
                }
                
                const newEmployee = {
                    name: employeeName,
                    position: employeePosition,
                    username: employeeUsername,
                    password: employeePassword,
                    mobile: employeeMobile,
                    bankInfo: {
                        bankName: bankName,
                        accountNumber: accountNumber,
                        accountHolder: accountHolder,
                        bankBranch: bankBranch
                    }
                };
                
                if (await addEmployee(newEmployee)) {
                    alert(getText('employee-added-success'));
                    this.reset();
                    // 跳转到职员列表页面
                    await showContent('employee-list');
                } else {
                    alert(getText('username-already-exists'));
                }
            } else {
                alert(getText('fill-all-employee-fields'));
            }
        });

        // 编辑职员表单提交处理
        document.getElementById('editEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeId = parseInt(document.getElementById('editEmployeeId').value);
            const employeeName = document.getElementById('editEmployeeName').value.trim();
            const employeePosition = document.getElementById('editEmployeePosition').value;
            const employeeUsername = document.getElementById('editEmployeeUsername').value.trim();
            const employeePassword = document.getElementById('editEmployeePassword').value.trim();
            const employeeMobile = document.getElementById('editEmployeeMobile').value.trim();
            
            // 银行账户信息（可选）
            const editBankName = document.getElementById('editEmployeeBankName').value.trim();
            const editAccountNumber = document.getElementById('editEmployeeAccountNumber').value.trim();
            const editAccountHolder = document.getElementById('editEmployeeAccountHolder').value.trim() || employeeName;
            const editBankBranch = document.getElementById('editEmployeeBankBranch').value.trim();
            
            // 基本信息验证
            if (!employeeName || !employeeUsername || !employeeMobile) {
                alert(getText('fill-employee-basic-info'));
                return;
            }
            
            // 权限验证：经理不能修改为管理员权限
            if (currentUser.position === 'manager' && employeePosition === 'admin') {
                alert(getText('cannot-edit-admin-permission'));
                return;
            }
            
            const updatedEmployee = {
                id: employeeId,
                name: employeeName,
                position: employeePosition,
                username: employeeUsername,
                password: employeePassword,
                mobile: employeeMobile,
                bankInfo: {
                    bankName: editBankName,
                    accountNumber: editAccountNumber,
                    accountHolder: editAccountHolder,
                    bankBranch: editBankBranch
                }
            };
            
            if (await updateEmployee(updatedEmployee)) {
                alert(getText('employee-updated-success'));
                closeEditEmployeeModal();
                
                // 刷新职员列表（如果当前在职员列表页面）
                const employeeListPage = document.getElementById('employee-list');
                if (employeeListPage && employeeListPage.classList.contains('active')) {
                    await displayEmployeeList();
                }
            } else {
                alert(getText('username-already-exists-edit'));
            }
        });
        
        // 编辑职员模态框不允许点击外部关闭，只能通过按钮关闭
        // document.getElementById('editEmployeeModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeEditEmployeeModal();
        //     }
        // });
        
        // ==================== 审批系统功能 ====================
        
        // 获取待审批操作
        function getPendingApprovals() {
            return JSON.parse(localStorage.getItem('pendingApprovals')) || [];
        }
        
        // 保存待审批操作
        function savePendingApprovals(approvals) {
            localStorage.setItem('pendingApprovals', JSON.stringify(approvals));
        }
        
        // 提交审批请求
        function submitApprovalRequest(operationType, operationData, description) {
            const approvals = getPendingApprovals();
            const approval = {
                id: Date.now() + Math.random(),
                operationType: operationType, // 'create-salon', 'delete-salon'
                operationData: JSON.parse(JSON.stringify(operationData)),
                description: description,
                requestedBy: currentUser.id,
                requestedByName: currentUser.name,
                requestedByPosition: currentUser.position,
                requestedAt: new Date().toISOString(),
                status: 'pending' // pending, approved, rejected
            };
            
            approvals.push(approval);
            savePendingApprovals(approvals);
            
            // 记录操作历史
            recordOperation(
                'approval-request',
                'system',
                approval.id,
                '审批请求',
                `${currentUser.name} 请求审批：${description}`,
                null,
                approval
            );
            
            return approval.id;
        }
        
        // 审批操作
        function processApproval(approvalId, action, reason) {
            const approvals = getPendingApprovals();
            const approvalIndex = approvals.findIndex(a => a.id.toString() === approvalId.toString());
            
            if (approvalIndex === -1) return false;
            
            const approval = approvals[approvalIndex];
            approval.status = action; // 'approved' or 'rejected'
            approval.processedBy = currentUser.id;
            approval.processedByName = currentUser.name;
            approval.processedAt = new Date().toISOString();
            approval.reason = reason;
            
            if (action === 'approved') {
                // 执行被审批的操作
                if (approval.operationType === 'create-salon') {
                    // 实际创建沙龙
                    addSalon(approval.operationData);
                } else if (approval.operationType === 'delete-salon') {
                    // 实际删除沙龙
                    deleteSalon(approval.operationData.salonId);
                }
            }
            
            savePendingApprovals(approvals);
            
            // 记录审批结果
            recordOperation(
                action === 'approved' ? 'approval-approved' : 'approval-rejected',
                'system',
                approval.id,
                '审批处理',
                `${currentUser.name} ${action === 'approved' ? '批准' : '拒绝'}了 ${approval.requestedByName} 的申请：${approval.description}`,
                null,
                approval
            );
            
            return true;
        }
        
        // 显示审批列表
        function displayApprovalList() {
            const approvals = getPendingApprovals();
            const statusFilter = document.getElementById('approvalStatusFilter').value;
            const container = document.getElementById('approvalList');
            
            // 根据状态筛选
            let filteredApprovals = approvals;
            if (statusFilter) {
                filteredApprovals = approvals.filter(approval => approval.status === statusFilter);
            }
            
            if (filteredApprovals.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${getText('no-pending-approvals')}</p></div>`;
                return;
            }
            
            let html = '';
            filteredApprovals.forEach(approval => {
                const requestDate = new Date(approval.requestedAt).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
                const processDate = approval.processedAt ? new Date(approval.processedAt).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN') : '-';
                
                // 根据状态设置颜色
                let statusColor = '#cccccc';
                let statusText = getText(approval.status);
                switch(approval.status) {
                    case 'pending': statusColor = '#FFD700'; break;
                    case 'approved': statusColor = '#90EE90'; break;
                    case 'rejected': statusColor = '#ff6666'; break;
                }
                
                // 操作类型的显示文本
                let operationTypeText = '';
                switch(approval.operationType) {
                    case 'create-salon': operationTypeText = '新增沙龙'; break;
                    case 'delete-salon': operationTypeText = '删除沙龙'; break;
                }
                
                html += `
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(212, 175, 55, 0.3);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <strong style="color: var(--gold);">${getText('request-time')}:</strong><br>
                                <span style="color: #cccccc;">${requestDate}</span>
                            </div>
                            <div>
                                <strong style="color: var(--gold);">${getText('requester')}:</strong><br>
                                <span style="color: #cccccc;">${approval.requestedByName} (${getPositionText(approval.requestedByPosition)})</span>
                            </div>
                            <div>
                                <strong style="color: var(--gold);">${getText('operation-type')}:</strong><br>
                                <span style="color: #cccccc;">${operationTypeText}</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--gold);">${getText('operation-description')}:</strong><br>
                            <span style="color: #cccccc;">${approval.description}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="background: ${statusColor}; color: black; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
                                    ${statusText}
                                </span>
                                ${approval.processedAt ? `
                                    <div style="margin-top: 5px; font-size: 0.9em; color: #aaaaaa;">
                                        ${getText('process-time')}: ${processDate}<br>
                                        ${getText('processor')}: ${approval.processedByName}
                                        ${approval.reason ? `<br>意见: ${approval.reason}` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${approval.status === 'pending' ? `
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="approveOperation('${approval.id}')" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                        ${getText('approve')}
                                    </button>
                                    <button onclick="rejectOperation('${approval.id}')" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                        ${getText('reject')}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 批准操作
        function approveOperation(approvalId) {
            const reason = prompt(getText('enter-approval-reason'));
            if (reason === null) return; // 用户取消
            
            if (!reason.trim()) {
                alert(getText('approval-reason-required'));
                return;
            }
            
            if (processApproval(approvalId, 'approved', reason)) {
                alert(getText('approval-processed-success'));
                displayApprovalList(); // 刷新列表
            }
        }
        
        // 拒绝操作
        function rejectOperation(approvalId) {
            const reason = prompt(getText('enter-approval-reason'));
            if (reason === null) return; // 用户取消
            
            if (!reason.trim()) {
                alert(getText('approval-reason-required'));
                return;
            }
            
            if (processApproval(approvalId, 'rejected', reason)) {
                alert(getText('approval-processed-success'));
                displayApprovalList(); // 刷新列表
            }
        }
        
        // ==================== 操作历史记录功能 ====================
        
        // 获取操作历史记录
        function getOperationHistory() {
            return JSON.parse(localStorage.getItem('operationHistory')) || [];
        }
        
        // 保存操作历史记录
        function saveOperationHistory(history) {
            localStorage.setItem('operationHistory', JSON.stringify(history));
        }
        
        // 记录操作历史
        function recordOperation(operationType, objectType, objectId, objectName, description, beforeData = null, afterData = null) {
            const history = getOperationHistory();
            const operation = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                userId: currentUser ? currentUser.id : null,
                userName: currentUser ? currentUser.name : '系统',
                userPosition: currentUser ? currentUser.position : 'system',
                operationType: operationType, // create, edit, delete, login, logout
                objectType: objectType, // salon, transaction, employee, system
                objectId: objectId,
                objectName: objectName,
                description: description,
                beforeData: beforeData ? JSON.parse(JSON.stringify(beforeData)) : null,
                afterData: afterData ? JSON.parse(JSON.stringify(afterData)) : null,
                ipAddress: '127.0.0.1', // 在真实环境中可以获取真实IP
                browserInfo: navigator.userAgent
            };
            
            history.unshift(operation); // 添加到开头，最新的在前面
            
            // 保留最近1000条记录
            if (history.length > 1000) {
                history.splice(1000);
            }
            
            saveOperationHistory(history);
        }
        
        // 显示操作历史记录（支持分页）
        function displayOperationHistory(page = 1) {
            const history = getOperationHistory();
            const container = document.getElementById('operation-history-list');
            
            // 保存当前数据和页面
            currentHistoryData = history;
            currentHistoryPage = page;
            
            if (history.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${getText('no-operation-history')}</p></div>`;
                return;
            }
            
            // 计算分页
            const totalPages = Math.ceil(history.length / historyItemsPerPage);
            const startIndex = (page - 1) * historyItemsPerPage;
            const endIndex = startIndex + historyItemsPerPage;
            const paginatedHistory = history.slice(startIndex, endIndex);
            
            // 渲染历史记录列表
            renderHistoryItems(paginatedHistory, startIndex);
            
            // 渲染分页控件
            renderHistoryPagination(totalPages, page, history.length);
            
            // 更新用户筛选选项
            updateHistoryUserFilter();
        }
        
        // 渲染历史记录项目
        function renderHistoryItems(operations, startIndex) {
            const container = document.getElementById('operation-history-list');
            
            let html = '';
            operations.forEach((operation, index) => {
                const globalIndex = startIndex + index + 1;
                const date = new Date(operation.timestamp).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
                const operationTypeText = getText('operation-' + operation.operationType);
                const objectTypeText = getText('object-' + operation.objectType);
                
                // 根据操作类型设置颜色
                let operationColor = '#cccccc';
                switch(operation.operationType) {
                    case 'create': operationColor = '#90EE90'; break;
                    case 'edit': operationColor = '#87CEEB'; break;
                    case 'delete': operationColor = '#ff6666'; break;
                    case 'login': operationColor = '#98FB98'; break;
                    case 'logout': operationColor = '#DDA0DD'; break;
                }
                
                // 确定是否为重要操作
                const isCritical = operation.operationType === 'delete' || 
                                  (operation.operationType === 'edit' && operation.objectType === 'employee');
                
                html += `
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid rgba(212, 175, 55, 0.3); ${isCritical ? 'border-left: 4px solid #ff6666;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 20px; margin-bottom: 10px; align-items: center;">
                                    <span style="color: #999; font-size: 0.9em;">#${globalIndex}</span>
                                    <span style="color: var(--gold);">${getText('operation-time')}: ${date}</span>
                                    <span style="color: ${operationColor}; font-weight: bold;">${operationTypeText} ${objectTypeText}</span>
                                    ${isCritical ? '<span style="color: #ff6666; font-size: 0.9em;">⚠️ 重要操作</span>' : ''}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <span style="color: #aaaaaa;">${getText('operator')}: ${operation.userName} (${getPositionText(operation.userPosition)})</span>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <span style="color: white;">${getText('object-name')}: ${translateObjectName(operation.objectName || operation.objectId)}</span>
                                </div>
                                <div style="color: #cccccc; font-size: 0.9em;">
                                    ${translateOperationDescription(operation.description, operation)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="viewOperationDetails('${operation.id}')" style="background: var(--gold); color: var(--black); border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">${getText('view-details')}</button>
                                ${operation.beforeData && operation.afterData ? `<button onclick="compareOperationData('${operation.id}')" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">${getText('compare-data')}</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 渲染历史记录分页控件
        function renderHistoryPagination(totalPages, currentPage, totalItems) {
            const container = document.getElementById('operation-history-list');
            
            if (totalPages <= 1) return; // 不需要分页
            
            // 获取翻译文字
            const firstPageText = getText('first-page');
            const prevPageText = getText('prev-page');
            const nextPageText = getText('next-page');
            const lastPageText = getText('last-page');
            const goToPageText = getText('go-to-page');
            const itemsPerPageText = getText('items-per-page');
            const itemsText = getText('items');
            const jumpText = getText('jump');
            const pageInfoText = getText('page-info')
                .replace('{current}', currentPage)
                .replace('{total}', totalPages)
                .replace('{items}', totalItems);
            
            let paginationHtml = `
                <div class="history-pagination-container" style="display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; flex-wrap: wrap;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="page-btn" onclick="goToHistoryPage(1)" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === 1 ? '#666' : 'var(--gold)'}; color: ${currentPage === 1 ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${firstPageText}</button>
                        <button class="page-btn" onclick="goToHistoryPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === 1 ? '#666' : 'var(--gold)'}; color: ${currentPage === 1 ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${prevPageText}</button>
                        
                        <span style="color: var(--gold); font-size: 0.9em; margin: 0 10px;">${pageInfoText}</span>
                        
                        <button class="page-btn" onclick="goToHistoryPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === totalPages ? '#666' : 'var(--gold)'}; color: ${currentPage === totalPages ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${nextPageText}</button>
                        <button class="page-btn" onclick="goToHistoryPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px; background: ${currentPage === totalPages ? '#666' : 'var(--gold)'}; color: ${currentPage === totalPages ? '#999' : 'var(--black)'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 0.9em;">${lastPageText}</button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center; margin-left: 20px;">
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="color: var(--gold); font-size: 0.9em;">${goToPageText}：</span>
                            <input type="number" id="history-page-jump-input" min="1" max="${totalPages}" value="${currentPage}" onkeydown="if(event.key==='Enter')jumpToHistoryPage()" style="width: 60px; padding: 6px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 4px; text-align: center; font-size: 0.9em;">
                            <button onclick="jumpToHistoryPage()" style="padding: 6px 12px; background: var(--gold); color: var(--black); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">${jumpText}</button>
                        </div>
                        
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="color: var(--gold); font-size: 0.9em;">${itemsPerPageText}</span>
                            <select id="history-items-per-page-select" onchange="changeHistoryItemsPerPage()" style="padding: 6px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 4px; font-size: 0.9em;">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                            </select>
                            <span style="color: var(--gold); font-size: 0.9em;">${itemsText}</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', paginationHtml);
            
            // 设置每页显示条数选择器的当前值
            const itemsPerPageSelect = document.getElementById('history-items-per-page-select');
            if (itemsPerPageSelect) {
                itemsPerPageSelect.value = historyItemsPerPage.toString();
            }
        }
        
        // 跳转到指定历史记录页面
        function goToHistoryPage(page) {
            if (page < 1 || page > Math.ceil(currentHistoryData.length / historyItemsPerPage)) return;
            
            // 检查是否有筛选条件
            const userFilter = document.getElementById('history-user-filter').value;
            const operationFilter = document.getElementById('history-operation-filter').value;
            const objectFilter = document.getElementById('history-object-filter').value;
            const startDate = document.getElementById('history-start-date').value;
            const endDate = document.getElementById('history-end-date').value;
            
            const hasFilter = userFilter || operationFilter || objectFilter || startDate || endDate;
            
            if (hasFilter) {
                // 如果有筛选条件，重新执行筛选并显示指定页面
                const history = getOperationHistory();
                let filteredHistory = history;
                
                // 按用户筛选
                if (userFilter) {
                    filteredHistory = filteredHistory.filter(operation => 
                        operation.userId && operation.userId.toString() === userFilter
                    );
                }
                
                // 按操作类型筛选
                if (operationFilter) {
                    filteredHistory = filteredHistory.filter(operation => 
                        operation.operationType === operationFilter
                    );
                }
                
                // 按对象类型筛选
                if (objectFilter) {
                    filteredHistory = filteredHistory.filter(operation => 
                        operation.objectType === objectFilter
                    );
                }
                
                // 按日期筛选
                if (startDate) {
                    const startDateTime = new Date(startDate).getTime();
                    filteredHistory = filteredHistory.filter(operation => 
                        new Date(operation.timestamp).getTime() >= startDateTime
                    );
                }
                
                if (endDate) {
                    const endDateTime = new Date(endDate + 'T23:59:59').getTime();
                    filteredHistory = filteredHistory.filter(operation => 
                        new Date(operation.timestamp).getTime() <= endDateTime
                    );
                }
                
                displayFilteredOperationHistory(filteredHistory, page);
            } else {
                // 没有筛选条件，显示全部记录
                displayOperationHistory(page);
            }
        }

        // 通过输入框跳转到指定历史记录页面
        function jumpToHistoryPage() {
            const input = document.getElementById('history-page-jump-input');
            if (!input) return;
            
            const page = parseInt(input.value);
            const maxPage = Math.ceil(currentHistoryData.length / historyItemsPerPage);
            
            if (isNaN(page) || page < 1 || page > maxPage) {
                alert(getText('invalid-page-number').replace('{max}', maxPage));
                input.value = currentHistoryPage; // 重置为当前页
                return;
            }
            
            goToHistoryPage(page);
        }
        
        // 改变每页显示历史记录条数
        function changeHistoryItemsPerPage() {
            const select = document.getElementById('history-items-per-page-select');
            historyItemsPerPage = parseInt(select.value);
            
            // 重新显示列表，回到第一页
            displayOperationHistory(1);
        }

        // 更新历史记录用户筛选选项
        function updateHistoryUserFilter() {
            const history = getOperationHistory();
            const select = document.getElementById('history-user-filter');
            const currentValue = select.value;
            
            // 获取所有用户
            const users = new Set();
            history.forEach(operation => {
                if (operation.userName) {
                    users.add(`${operation.userId}|${operation.userName}`);
                }
            });
            
            let optionsHtml = `<option value="">${getText('all-users')}</option>`;
            users.forEach(userInfo => {
                const [userId, userName] = userInfo.split('|');
                optionsHtml += `<option value="${userId}">${userName}</option>`;
            });
            
            select.innerHTML = optionsHtml;
            select.value = currentValue; // 恢复之前的选择
        }
        
        // 筛选操作历史记录
        function filterOperationHistory() {
            const userFilter = document.getElementById('history-user-filter').value;
            const operationFilter = document.getElementById('history-operation-filter').value;
            const objectFilter = document.getElementById('history-object-filter').value;
            const startDate = document.getElementById('history-start-date').value;
            const endDate = document.getElementById('history-end-date').value;
            
            const history = getOperationHistory();
            let filteredHistory = history;
            
            // 按用户筛选
            if (userFilter) {
                filteredHistory = filteredHistory.filter(operation => 
                    operation.userId && operation.userId.toString() === userFilter
                );
            }
            
            // 按操作类型筛选
            if (operationFilter) {
                filteredHistory = filteredHistory.filter(operation => 
                    operation.operationType === operationFilter
                );
            }
            
            // 按对象类型筛选
            if (objectFilter) {
                filteredHistory = filteredHistory.filter(operation => 
                    operation.objectType === objectFilter
                );
            }
            
            // 按日期筛选
            if (startDate) {
                const startDateTime = new Date(startDate).getTime();
                filteredHistory = filteredHistory.filter(operation => 
                    new Date(operation.timestamp).getTime() >= startDateTime
                );
            }
            
            if (endDate) {
                const endDateTime = new Date(endDate + 'T23:59:59').getTime();
                filteredHistory = filteredHistory.filter(operation => 
                    new Date(operation.timestamp).getTime() <= endDateTime
                );
            }
            
            // 显示筛选结果
            displayFilteredOperationHistory(filteredHistory, 1); // 筛选后显示第一页
        }
        
        // 显示筛选后的操作历史记录（支持分页）
        function displayFilteredOperationHistory(filteredHistory, page = 1) {
            const container = document.getElementById('operation-history-list');
            
            // 保存当前筛选后的数据和页面
            currentHistoryData = filteredHistory;
            currentHistoryPage = page;
            
            if (filteredHistory.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #cccccc; padding: 40px;"><p>${getText('no-operation-history')}</p></div>`;
                return;
            }
            
            // 计算分页
            const totalPages = Math.ceil(filteredHistory.length / historyItemsPerPage);
            const startIndex = (page - 1) * historyItemsPerPage;
            const endIndex = startIndex + historyItemsPerPage;
            const paginatedHistory = filteredHistory.slice(startIndex, endIndex);
            
            // 渲染历史记录列表
            renderHistoryItems(paginatedHistory, startIndex);
            
            // 渲染分页控件
            renderHistoryPagination(totalPages, page, filteredHistory.length);
        }
        
        // 清空历史记录筛选
        function clearHistoryFilters() {
            document.getElementById('history-user-filter').value = '';
            document.getElementById('history-operation-filter').value = '';
            document.getElementById('history-object-filter').value = '';
            document.getElementById('history-start-date').value = '';
            document.getElementById('history-end-date').value = '';
            displayOperationHistory(1); // 清空筛选后回到第一页
        }
        
        // 查看操作详情
        function viewOperationDetails(operationId) {
            const history = getOperationHistory();
            const operation = history.find(op => op.id.toString() === operationId.toString());
            
            if (!operation) return;
            
            const date = new Date(operation.timestamp).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
            const operationTypeText = getText('operation-' + operation.operationType);
            const objectTypeText = getText('object-' + operation.objectType);
            
            const modalHtml = `
                <div id="operation-details-modal-${operationId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: var(--dark-gray); padding: 30px; border-radius: 10px; border: 1px solid var(--gold); width: 600px; max-width: 95vw; max-height: 95vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 style="color: var(--gold); margin-top: 0;">${getText('operation-details')}</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: var(--gold);">${getText('operation-time')}:</strong><br>
                                    <span style="color: white;">${date}</span>
                                </div>
                                <div>
                                    <strong style="color: var(--gold);">${getText('operator')}:</strong><br>
                                    <span style="color: white;">${operation.userName} (${getPositionText(operation.userPosition)})</span>
                                </div>
                                <div>
                                    <strong style="color: var(--gold);">${getText('operation-type')}:</strong><br>
                                    <span style="color: white;">${operationTypeText}</span>
                                </div>
                                <div>
                                    <strong style="color: var(--gold);">${getText('object-type')}:</strong><br>
                                    <span style="color: white;">${objectTypeText}</span>
                                </div>
                                <div>
                                    <strong style="color: var(--gold);">${getText('object-name')}:</strong><br>
                                    <span style="color: white;">${translateObjectName(operation.objectName || operation.objectId)}</span>
                                </div>
                                <div>
                                    <strong style="color: var(--gold);">${getText('ip-address')}:</strong><br>
                                    <span style="color: white;">${operation.ipAddress}</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong style="color: var(--gold);">${getText('operation-description')}:</strong><br>
                                <span style="color: white;">${translateOperationDescription(operation.description, operation)}</span>
                            </div>
                            
                            <div>
                                <strong style="color: var(--gold);">${getText('browser-info')}:</strong><br>
                                <span style="color: #cccccc; font-size: 0.9em;">${operation.browserInfo}</span>
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <button onclick="closeOperationDetailsModal('${operationId}')" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">${getText('cancel')}</button>
                            ${operation.beforeData && operation.afterData ? `<button onclick="closeOperationDetailsModal('${operationId}'); compareOperationData('${operation.id}')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">${getText('compare-data')}</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            updateTexts(); // 更新翻译
        }

        // 关闭操作详情弹窗
        function closeOperationDetailsModal(operationId) {
            const modal = document.getElementById(`operation-details-modal-${operationId}`);
            if (modal) {
                modal.remove();
            }
        }
        
        // 数据对比功能
        function compareOperationData(operationId) {
            const history = getOperationHistory();
            const operation = history.find(op => op.id.toString() === operationId.toString());
            
            if (!operation || !operation.beforeData || !operation.afterData) return;
            
            // 隐藏当前页面，显示数据对比页面
            document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
            document.getElementById('data-comparison').classList.add('active');
            
            displayDataComparison(operation);
        }
        
        // 显示数据对比
        function displayDataComparison(operation) {
            // 保存当前操作记录，用于语言切换时重新渲染
            currentComparisonOperation = operation;
            
            const container = document.getElementById('comparison-content');
            const date = new Date(operation.timestamp).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
            const operationTypeText = getText('operation-' + operation.operationType);
            const objectTypeText = getText('object-' + operation.objectType);
            
            let comparisonHtml = `
                <div style="margin-bottom: 30px; text-align: center;">
                    <h2 style="color: var(--gold);">${translateObjectName(operation.objectName || operation.objectId)} - ${operationTypeText} ${objectTypeText}</h2>
                    <p style="color: #cccccc;">${date} - ${operation.userName} (${getPositionText(operation.userPosition)})</p>
                    <p style="color: #aaaaaa;">${translateOperationDescription(operation.description, operation)}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3 style="color: #ff9999; text-align: center; margin-bottom: 20px;">${getText('data-before')}</h3>
                        <div style="background: rgba(255, 153, 153, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(255, 153, 153, 0.3);">
                            ${formatDataForComparison(operation.beforeData)}
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #99ff99; text-align: center; margin-bottom: 20px;">${getText('data-after')}</h3>
                        <div style="background: rgba(153, 255, 153, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(153, 255, 153, 0.3);">
                            ${formatDataForComparison(operation.afterData)}
                        </div>
                    </div>
                </div>
                
                <!-- 关闭按钮 -->
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeDataComparison()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">${getText('close')}</button>
                </div>
            `;
            
            container.innerHTML = comparisonHtml;
        }
        
        // 关闭数据对比查看窗口
        function closeDataComparison() {
            // 清除当前操作记录
            currentComparisonOperation = null;
            
            // 隐藏数据对比页面，返回操作历史记录页面
            document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
            document.getElementById('operation-history').classList.add('active');
        }
        
        // 获取字段名翻译
        function getFieldName(key) {
            const fieldKey = 'field-' + key;
            return getText(fieldKey) !== fieldKey ? getText(fieldKey) : key;
        }
        
        // 获取字段值翻译（针对特定字段进行值翻译）
        function getFieldValue(key, value) {
            if (key === 'position' && value) {
                // 翻译职位值
                return getPositionText(value);
            } else if (key === 'district' && value) {
                // 翻译区域值
                return getDistrictText(value);
            }
            return value;
        }
        
        // 翻译对象名称
        function translateObjectName(objectName) {
            if (!objectName) return objectName;
            
            // 对象名称映射
            const objectNameMap = {
                '首页导航': 'object-name-home-navigation',
                '系统登出': 'object-name-system-logout'
            };
            
            const translationKey = objectNameMap[objectName];
            if (translationKey) {
                const translated = getText(translationKey);
                return translated !== translationKey ? translated : objectName;
            }
            
            return objectName;
        }
        
        // 翻译操作描述
        function translateOperationDescription(description, operation) {
            if (!description) return description;
            
            // 用于匹配和替换的模式
            const patterns = [
                {
                    // 通过点击Logo返回首页
                    pattern: /^(.+)\s*通过点击Logo返回首页$/,
                    key: 'operation-desc-homepage-navigation',
                    format: (matches, translated) => `${matches[1]} ${translated}`
                },
                {
                    // 系统登出
                    pattern: /^系统登出$/,
                    key: 'operation-desc-system-logout'
                },
                {
                    // 用户 XXX (position) 登出系统
                    pattern: /^用户\s*(.+)\s*\((.+)\)\s*登出系统$/,
                    key: 'operation-desc-user-logout',
                    format: (matches, translated) => translated.replace('{user}', matches[1]).replace('{position}', getPositionText(matches[2]))
                },
                {
                    // 创建新沙龙：XXX，院长：XXX
                    pattern: /^创建新沙龙：(.+)，院长：(.*)$/,
                    key: 'operation-desc-create-salon',
                    format: (matches, translated) => translated.replace('{name}', matches[1]).replace('{director}', matches[2] || '')
                },
                {
                    // 删除沙龙：XXX，院长：XXX
                    pattern: /^删除沙龙：(.+)，院长：(.*)$/,
                    key: 'operation-desc-delete-salon',
                    format: (matches, translated) => translated.replace('{name}', matches[1]).replace('{director}', matches[2] || '')
                },
                {
                    // 编辑职员信息：XXX
                    pattern: /^编辑职员信息：(.+)$/,
                    key: 'operation-desc-edit-employee',
                    format: (matches, translated) => translated.replace('{name}', matches[1])
                }
            ];
            
            // 尝试匹配并翻译
            for (const pattern of patterns) {
                const matches = description.match(pattern.pattern);
                if (matches) {
                    const translatedText = getText(pattern.key);
                    if (translatedText !== pattern.key) {
                        if (pattern.format) {
                            return pattern.format(matches, translatedText);
                        } else {
                            return translatedText;
                        }
                    }
                    break;
                }
            }
            
            return description; // 如果没有匹配的模式，返回原文
        }
        
        // 格式化数据用于对比显示
        function formatDataForComparison(data) {
            if (!data) return `<p style="color: #666;">${getText('no-data')}</p>`;
            
            let html = '';
            
            if (typeof data === 'object') {
                for (const [key, value] of Object.entries(data)) {
                    const translatedKey = getFieldName(key);
                    
                    if (key === 'transactions' && Array.isArray(value)) {
                        html += `<div style="margin-bottom: 10px;"><strong>${translatedKey}:</strong> ${value.length} ${getText('records')}</div>`;
                    } else if (typeof value === 'object' && value !== null) {
                        html += `<div style="margin-bottom: 10px;"><strong>${translatedKey}:</strong><br>${formatDataForComparison(value)}</div>`;
                    } else {
                        const translatedValue = getFieldValue(key, value);
                        html += `<div style="margin-bottom: 10px;"><strong>${translatedKey}:</strong> ${translatedValue || getText('not-set')}</div>`;
                    }
                }
            } else {
                html = `<div>${data}</div>`;
            }
            
            return html || `<p style="color: #666;">${getText('no-data')}</p>`;
        }
        
        // 显示审计报告
        function displayAuditReport() {
            const history = getOperationHistory();
            
            // 统计数据
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const totalOperations = history.length;
            const todayOperations = history.filter(op => 
                new Date(op.timestamp) >= today
            ).length;
            
            const activeUsers = new Set(history.map(op => op.userId)).size;
            const criticalOperations = history.filter(op => 
                op.operationType === 'delete' || 
                (op.operationType === 'edit' && op.objectType === 'employee')
            ).length;
            
            // 更新统计数字
            document.getElementById('total-operations-count').textContent = totalOperations;
            document.getElementById('today-operations-count').textContent = todayOperations;
            document.getElementById('active-users-count').textContent = activeUsers;
            document.getElementById('critical-operations-count').textContent = criticalOperations;
            
            // 生成详细报告
            const reportContainer = document.getElementById('audit-report-content');
            
            // 按用户统计
            const userStats = {};
            history.forEach(op => {
                const userName = op.userName || getText('unknown-user');
                if (!userStats[userName]) {
                    userStats[userName] = {
                        total: 0,
                        create: 0,
                        edit: 0,
                        delete: 0,
                        login: 0,
                        logout: 0
                    };
                }
                userStats[userName].total++;
                userStats[userName][op.operationType]++;
            });
            
            // 按操作类型统计
            const operationStats = {
                create: history.filter(op => op.operationType === 'create').length,
                edit: history.filter(op => op.operationType === 'edit').length,
                delete: history.filter(op => op.operationType === 'delete').length,
                login: history.filter(op => op.operationType === 'login').length,
                logout: history.filter(op => op.operationType === 'logout').length
            };
            
            // 生成用户统计表格
            let userStatsHtml = `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--gold); margin-bottom: 15px;">${getText('user-operation-stats')}</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid var(--gold);">
                        <thead style="background: rgba(212, 175, 55, 0.2);">
                            <tr>
                                <th style="padding: 10px; border: 1px solid var(--gold); color: var(--gold);">${getText('user')}</th>
                                <th style="padding: 10px; border: 1px solid var(--gold); color: var(--gold);">${getText('total')}</th>
                                <th style="padding: 10px; border: 1px solid var(--gold); color: var(--gold);">${getText('create-count')}</th>
                                <th style="padding: 10px; border: 1px solid var(--gold); color: var(--gold);">${getText('edit-count')}</th>
                                <th style="padding: 10px; border: 1px solid var(--gold); color: var(--gold);">${getText('delete-count')}</th>
                                <th style="padding: 10px; border: 1px solid var(--gold); color: var(--gold);">${getText('login-count')}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(userStats).forEach(([userName, stats]) => {
                userStatsHtml += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); color: white;">${userName}</td>
                        <td style="padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); color: white; text-align: center;">${stats.total}</td>
                        <td style="padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); color: #90EE90; text-align: center;">${stats.create}</td>
                        <td style="padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); color: #87CEEB; text-align: center;">${stats.edit}</td>
                        <td style="padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); color: #ff6666; text-align: center;">${stats.delete}</td>
                        <td style="padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); color: #98FB98; text-align: center;">${stats.login}</td>
                    </tr>
                `;
            });
            
            userStatsHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // 最近的重要操作
            const recentCriticalOps = history
                .filter(op => 
                    op.operationType === 'delete' || 
                    (op.operationType === 'edit' && op.objectType === 'employee')
                )
                .slice(0, 10);
            
            let criticalOpsHtml = `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #ff6666; margin-bottom: 15px;">⚠️ ${getText('recent-critical-operations')}</h3>
            `;
            
            if (recentCriticalOps.length === 0) {
                criticalOpsHtml += `<p style="color: #666;">${getText('no-critical-operations')}</p>`;
            } else {
                recentCriticalOps.forEach(op => {
                    const date = new Date(op.timestamp).toLocaleString(currentLanguage === 'ko' ? 'ko-KR' : 'zh-CN');
                    const operationTypeText = getText('operation-' + op.operationType);
                    const objectTypeText = getText('object-' + op.objectType);
                    
                    criticalOpsHtml += `
                        <div style="background: rgba(255, 102, 102, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #ff6666;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: white;">${date} - ${op.userName} ${operationTypeText} ${objectTypeText}: ${op.objectName}</span>
                                <button onclick="viewOperationDetails('${op.id}')" style="background: transparent; border: 1px solid #ff6666; color: #ff6666; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">${getText('details')}</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            criticalOpsHtml += '</div>';
            
            reportContainer.innerHTML = userStatsHtml + criticalOpsHtml;
        }
        

        
        // 显示编辑沙龙模态框
        function showEditSalonModal(salonId) {
            const salons = getSalons();
            const salon = salons.find(s => s.id === salonId);
            
            if (!salon) return;
            
            // 填充表单数据
            document.getElementById('editSalonId').value = salon.id;
            document.getElementById('editSalonName').value = salon.name;
            document.getElementById('editSalonAddress').value = salon.address;
            document.getElementById('editSalonDistrict').value = salon.district;
            document.getElementById('editSalonPhone').value = salon.phone || '';
            document.getElementById('editDirectorName').value = salon.directorName;
            document.getElementById('editDirectorMobile').value = salon.directorMobile;
            
            // 更新负责职员选项
            updateEditResponsibleEmployeeOptions();
            
            // 设置负责职员选择
            if (salon.responsibleEmployeeId) {
                document.getElementById('editResponsibleEmployee').value = salon.responsibleEmployeeId;
            }
            
            // 显示模态框
            const modal = document.getElementById('editSalonModal');
            modal.style.display = 'flex';
        }
        
        // 关闭编辑沙龙模态框
        function closeEditSalonModal() {
            const modal = document.getElementById('editSalonModal');
            modal.style.display = 'none';
            document.getElementById('editSalonForm').reset();
        }
        
        // 编辑沙龙表单提交处理
        document.getElementById('editSalonForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const salonId = parseInt(document.getElementById('editSalonId').value);
            const salonName = document.getElementById('editSalonName').value.trim();
            const salonAddress = document.getElementById('editSalonAddress').value.trim();
            const salonDistrict = document.getElementById('editSalonDistrict').value;
            const salonPhone = document.getElementById('editSalonPhone').value.trim();
            const directorName = document.getElementById('editDirectorName').value.trim();
            const directorMobile = document.getElementById('editDirectorMobile').value.trim();
            const responsibleEmployeeId = document.getElementById('editResponsibleEmployee').value;
            
            // 基本信息验证 - 只要求沙龙名称
            if (!salonName) {
                alert(getText('salon-name-required'));
                return;
            }
            
            const updatedSalon = {
                id: salonId,
                name: salonName,
                address: salonAddress,
                district: salonDistrict,
                phone: salonPhone,
                directorName: directorName,
                directorMobile: directorMobile,
                responsibleEmployeeId: responsibleEmployeeId
            };
            
            if (updateSalon(updatedSalon)) {
                alert(getText('salon-updated-success'));
                closeEditSalonModal();
                
                // 刷新沙龙列表
                displaySalonList(currentFilter, currentPage); // 保持当前筛选和页面
                
                // 更新删除页面的选项
                updateDeleteSalonOptions();
            }
        });
        
        // 编辑沙龙模态框不允许点击外部关闭，只能通过按钮关闭
        // document.getElementById('editSalonModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeEditSalonModal();
        //     }
        // });

        // 批量控制功能
        function updateBatchControls() {
            const checkboxes = document.querySelectorAll('.salon-checkbox');
            const checkedBoxes = document.querySelectorAll('.salon-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all-salons');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const batchAssignBtn = document.getElementById('batch-assign-btn');
            const selectedCount = document.getElementById('selected-count');
            
            const checkedCount = checkedBoxes.length;
            const totalCount = checkboxes.length;
            
            // 更新全选状态
            if (checkedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCount === totalCount) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
            
            // 更新按钮状态
            if (checkedCount > 0) {
                batchDeleteBtn.disabled = false;
                batchDeleteBtn.style.cursor = 'pointer';
                batchDeleteBtn.style.opacity = '1';
                batchAssignBtn.disabled = false;
                batchAssignBtn.style.cursor = 'pointer';
                batchAssignBtn.style.opacity = '1';
            } else {
                batchDeleteBtn.disabled = true;
                batchDeleteBtn.style.cursor = 'not-allowed';
                batchDeleteBtn.style.opacity = '0.6';
                batchAssignBtn.disabled = true;
                batchAssignBtn.style.cursor = 'not-allowed';
                batchAssignBtn.style.opacity = '0.6';
            }
            
            // 更新选择计数
            selectedCount.textContent = getText('selected-count').replace('{count}', checkedCount);
        }
        
        // 全选/取消全选
        function toggleSelectAllSalons() {
            const selectAllCheckbox = document.getElementById('select-all-salons');
            const checkboxes = document.querySelectorAll('.salon-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBatchControls();
        }
        
        // 批量删除沙龙
        function batchDeleteSalons() {
            const checkedBoxes = document.querySelectorAll('.salon-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert(getText('no-salons-selected'));
                return;
            }
            
            const selectedSalonIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.salonId));
            const salons = getSalons();
            const selectedSalons = salons.filter(salon => selectedSalonIds.includes(salon.id));
            
            const salonNames = selectedSalons.map(salon => salon.name).join('、');
            
            if (!confirm(getText('confirm-batch-delete').replace('{count}', selectedSalonIds.length).replace('{names}', salonNames))) {
                return;
            }
            
            // 检查权限
            if (currentUser.position === 'admin') {
                // 管理员直接删除
                selectedSalonIds.forEach(salonId => {
                    deleteSalon(salonId);
                });
                displaySalonList(currentFilter, 1); // 刷新到第一页
                updateDeleteSalonOptions();
                alert(getText('batch-delete-success').replace('{count}', selectedSalonIds.length));
            } else {
                // 经理和业务员需要审批
                const description = `批量删除沙龙：${salonNames}（共${selectedSalonIds.length}个）`;
                submitApprovalRequest('batch-delete-salon', { salonIds: selectedSalonIds }, description);
                alert(getText('approval-submitted'));
            }
        }
        
        // 显示批量指定负责人模态框
        function showBatchAssignModal() {
            const checkedBoxes = document.querySelectorAll('.salon-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert(getText('no-salons-selected'));
                return;
            }
            
            const modal = document.getElementById('batchAssignModal');
            updateBatchAssignEmployeeOptions();
            modal.style.display = 'flex';
        }
        
        // 关闭批量指定负责人模态框
        function closeBatchAssignModal() {
            document.getElementById('batchAssignModal').style.display = 'none';
            document.getElementById('batchAssignForm').reset();
        }
        
        // 更新批量指定的员工选项
        function updateBatchAssignEmployeeOptions() {
            const selectElement = document.getElementById('batchAssignEmployee');
            const employees = getEmployees();
            
            let optionsHtml = `<option value="">${getText('please-select-employee')}</option>`;
            optionsHtml += `<option value="unassigned">${getText('unassigned')}</option>`;
            
            employees.forEach(employee => {
                if (currentUser.position === 'admin' || currentUser.position === 'manager') {
                    const positionText = getPositionText(employee.position);
                    optionsHtml += `<option value="${employee.id}">${employee.name} - ${positionText}</option>`;
                }
            });
            
            selectElement.innerHTML = optionsHtml;
        }
        
        // 执行批量指定负责人
        function executeBatchAssign() {
            const checkedBoxes = document.querySelectorAll('.salon-checkbox:checked');
            const employeeId = document.getElementById('batchAssignEmployee').value;
            
            if (!employeeId) {
                alert(getText('please-select-employee'));
                return;
            }
            
            const selectedSalonIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.salonId));
            const salons = getSalons();
            
            // 检查权限
            if (currentUser.position === 'admin' || currentUser.position === 'manager') {
                // 管理员和经理直接操作
                selectedSalonIds.forEach(salonId => {
                    const salonIndex = salons.findIndex(s => s.id === salonId);
                    if (salonIndex !== -1) {
                        salons[salonIndex].responsibleEmployeeId = employeeId === 'unassigned' ? 'unassigned' : parseInt(employeeId);
                        salons[salonIndex].lastModified = new Date().toISOString();
                    }
                });
                
                saveSalons(salons);
                displaySalonList(currentFilter, currentPage); // 保持当前筛选和页面
                closeBatchAssignModal();
                
                // 清除选择状态
                document.querySelectorAll('.salon-checkbox').forEach(cb => cb.checked = false);
                updateBatchControls();
                
                const employeeName = getEmployeeName(employeeId === 'unassigned' ? 'unassigned' : parseInt(employeeId));
                alert(getText('batch-assign-success').replace('{count}', selectedSalonIds.length).replace('{employee}', employeeName));
            } else {
                // 业务员需要审批
                const selectedSalons = salons.filter(salon => selectedSalonIds.includes(salon.id));
                const salonNames = selectedSalons.map(salon => salon.name).join('、');
                const employeeName = getEmployeeName(employeeId === 'unassigned' ? 'unassigned' : parseInt(employeeId));
                const description = getText('batch-assign-description')
                    .replace('{salons}', salonNames)
                    .replace('{count}', selectedSalonIds.length)
                    .replace('{employee}', employeeName);
                
                submitApprovalRequest('batch-assign-responsible', { 
                    salonIds: selectedSalonIds, 
                    employeeId: employeeId === 'unassigned' ? 'unassigned' : parseInt(employeeId)
                }, description);
                
                closeBatchAssignModal();
                alert(getText('approval-submitted'));
            }
        }
        
        // ==================== 业绩目标管理 ====================
        
        // 业绩目标数据存储
        function getPerformanceTargets() {
            const targets = localStorage.getItem('performanceTargets');
            return targets ? JSON.parse(targets) : {};
        }
        
        function savePerformanceTargets(targets) {
            localStorage.setItem('performanceTargets', JSON.stringify(targets));
        }
        
        // 获取业绩实际数据
        function getPerformanceActuals() {
            const actuals = localStorage.getItem('performanceActuals');
            return actuals ? JSON.parse(actuals) : {};
        }
        
        function savePerformanceActuals(actuals) {
            localStorage.setItem('performanceActuals', JSON.stringify(actuals));
        }
        
        // 初始化业绩目标页面
        function initializePerformanceTargets() {
            generateMonthOptions();
            initializeEmployeeTargets();
            displayPerformanceTargets();
        }
        
        // 生成月份选择选项
        function generateMonthOptions() {
            const monthSelect = document.getElementById('performance-month');
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            
            monthSelect.innerHTML = '';
            
            // 生成过去6个月和未来6个月的选项
            for (let i = -6; i <= 6; i++) {
                const month = new Date(currentYear, currentMonth + i, 1);
                const monthKey = `${month.getFullYear()}-${String(month.getMonth() + 1).padStart(2, '0')}`;
                const monthText = currentLanguage === 'ko' ? 
                    `${month.getFullYear()}년 ${month.getMonth() + 1}월` :
                    `${month.getFullYear()}年${month.getMonth() + 1}月`;
                
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthText;
                
                if (i === 0) {
                    option.selected = true;
                }
                
                monthSelect.appendChild(option);
            }
        }
        
        // 初始化员工目标（200万韩元 = 2000千韩元）
        function initializeEmployeeTargets() {
            const employees = getEmployees();
            const targets = getPerformanceTargets();
            const currentMonth = document.getElementById('performance-month').value;
            
            if (!targets[currentMonth]) {
                targets[currentMonth] = {};
            }
            
            let hasNewTargets = false;
            employees.forEach(employee => {
                if (!targets[currentMonth][employee.id]) {
                    targets[currentMonth][employee.id] = 2000; // 200万韩元 = 2000千韩元
                    hasNewTargets = true;
                }
            });
            
            if (hasNewTargets) {
                savePerformanceTargets(targets);
            }
        }
        
        // 显示业绩目标
        function displayPerformanceTargets() {
            const selectedMonth = document.getElementById('performance-month').value;
            initializeEmployeeTargets();
            
            const employees = getEmployees();
            const targets = getPerformanceTargets();
            const actuals = getPerformanceActuals();
            
            const monthTargets = targets[selectedMonth] || {};
            const monthActuals = actuals[selectedMonth] || {};
            
            // 计算团队总目标和总实际
            let teamTarget = 0;
            let teamActual = 0;
            
            employees.forEach(employee => {
                teamTarget += monthTargets[employee.id] || 0;
                teamActual += monthActuals[employee.id] || 0;
            });
            
            // 更新团队目标显示
            document.getElementById('team-target-amount').textContent = teamTarget.toLocaleString();
            document.getElementById('team-actual-amount').textContent = teamActual.toLocaleString();
            document.getElementById('team-target-display').textContent = teamTarget.toLocaleString();
            
            const teamProgress = teamTarget > 0 ? Math.min((teamActual / teamTarget) * 100, 100) : 0;
            document.getElementById('team-progress-text').textContent = `${teamProgress.toFixed(1)}%`;
            document.getElementById('team-progress-bar').style.width = `${teamProgress}%`;
            
            // 生成个人目标列表
            renderIndividualTargets(employees, monthTargets, monthActuals, selectedMonth);
        }
        
        // 渲染个人目标列表
        function renderIndividualTargets(employees, targets, actuals, selectedMonth) {
            const container = document.getElementById('performance-list');
            
            let html = `
                <div style="background: rgba(135, 206, 235, 0.1); padding: 20px; border-radius: 8px; border: 1px solid rgba(135, 206, 235, 0.3);">
                    <h2 style="color: #87CEEB; margin: 0 0 20px 0; text-align: center;" data-i18n="individual-targets">个人业绩目标</h2>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                            <thead>
                                <tr style="background: rgba(135, 206, 235, 0.2);">
                                    <th style="padding: 12px; text-align: left; color: #87CEEB; border: 1px solid rgba(135, 206, 235, 0.5);" data-i18n="employee-name-column">职员姓名</th>
                                    <th style="padding: 12px; text-align: center; color: #87CEEB; border: 1px solid rgba(135, 206, 235, 0.5);" data-i18n="monthly-target">月度目标</th>
                                    <th style="padding: 12px; text-align: center; color: #87CEEB; border: 1px solid rgba(135, 206, 235, 0.5);" data-i18n="monthly-actual">月度实际</th>
                                    <th style="padding: 12px; text-align: center; color: #87CEEB; border: 1px solid rgba(135, 206, 235, 0.5);" data-i18n="progress-rate">进度率(%)</th>
                                    <th style="padding: 12px; text-align: center; color: #87CEEB; border: 1px solid rgba(135, 206, 235, 0.5);" data-i18n="target-adjustment">目标调整</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            employees.forEach(employee => {
                const target = targets[employee.id] || 0;
                const actual = actuals[employee.id] || 0;
                const progress = target > 0 ? Math.min((actual / target) * 100, 100) : 0;
                
                // 检查上月业绩是否超标
                const lastMonth = getPreviousMonth(selectedMonth);
                const lastMonthActuals = getPerformanceActuals()[lastMonth] || {};
                const lastMonthTargets = getPerformanceTargets()[lastMonth] || {};
                const lastMonthActual = lastMonthActuals[employee.id] || 0;
                const lastMonthTarget = lastMonthTargets[employee.id] || 0;
                const isTargetIncreased = lastMonthActual > lastMonthTarget;
                
                // 进度条颜色
                let progressColor = '#4CAF50';
                if (progress < 50) progressColor = '#ff6666';
                else if (progress < 80) progressColor = '#ffaa00';
                
                html += `
                    <tr style="border: 1px solid rgba(135, 206, 235, 0.3);">
                        <td style="padding: 12px; color: var(--text-light); border: 1px solid rgba(135, 206, 235, 0.3);">
                            <div style="font-weight: bold;">${employee.name}</div>
                            <div style="font-size: 0.8em; color: #aaa;">${getPositionText(employee.position)}</div>
                        </td>
                        <td style="padding: 12px; text-align: center; color: var(--gold); border: 1px solid rgba(135, 206, 235, 0.3);">
                            <div style="font-size: 1.2em; font-weight: bold;">${target.toLocaleString()}</div>
                            <div style="font-size: 0.8em; color: #aaa;" data-i18n="thousand-won">千韩元</div>
                        </td>
                        <td style="padding: 12px; text-align: center; border: 1px solid rgba(135, 206, 235, 0.3);">
                            <div style="margin-bottom: 5px;">
                                <input type="number" id="actual-${employee.id}" value="${actual}" onchange="updateActualAmount('${employee.id}', this.value)" style="width: 100px; padding: 5px; background: var(--dark-gray); border: 1px solid var(--gold); color: var(--text-light); border-radius: 3px; text-align: center;">
                            </div>
                            <div style="font-size: 0.8em; color: #aaa;" data-i18n="thousand-won">千韩元</div>
                        </td>
                        <td style="padding: 12px; text-align: center; border: 1px solid rgba(135, 206, 235, 0.3);">
                            <div style="margin-bottom: 5px;">
                                <span style="font-size: 1.1em; font-weight: bold; color: ${progressColor};">${progress.toFixed(1)}%</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden; margin: 5px 0;">
                                <div style="height: 100%; background: ${progressColor}; width: ${progress}%; transition: width 0.3s ease;"></div>
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center; border: 1px solid rgba(135, 206, 235, 0.3);">
                            ${isTargetIncreased ? 
                                `<span style="color: #ffaa00; font-size: 0.9em;" data-i18n="target-increased">目标上调10%</span>` : 
                                `<span style="color: #90EE90; font-size: 0.9em;" data-i18n="target-maintained">目标保持</span>`
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // 更新多语言
            updateTexts();
        }
        
        // 更新实际金额
        function updateActualAmount(employeeId, value) {
            const selectedMonth = document.getElementById('performance-month').value;
            const actuals = getPerformanceActuals();
            
            if (!actuals[selectedMonth]) {
                actuals[selectedMonth] = {};
            }
            
            actuals[selectedMonth][employeeId] = parseFloat(value) || 0;
            savePerformanceActuals(actuals);
            
            // 重新显示业绩目标以更新团队总计
            displayPerformanceTargets();
        }
        
        // 获取上个月的键
        function getPreviousMonth(monthKey) {
            const [year, month] = monthKey.split('-').map(Number);
            const date = new Date(year, month - 2, 1); // month-2 因为JavaScript月份从0开始
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        // 重新计算目标（根据上月业绩自动调整）
        function recalculatePerformanceTargets() {
            const selectedMonth = document.getElementById('performance-month').value;
            const lastMonth = getPreviousMonth(selectedMonth);
            
            const targets = getPerformanceTargets();
            const actuals = getPerformanceActuals();
            const employees = getEmployees();
            
            if (!targets[selectedMonth]) {
                targets[selectedMonth] = {};
            }
            
            const lastMonthTargets = targets[lastMonth] || {};
            const lastMonthActuals = actuals[lastMonth] || {};
            
            let adjustedCount = 0;
            
            employees.forEach(employee => {
                const lastTarget = lastMonthTargets[employee.id] || 2000; // 默认200万韩元
                const lastActual = lastMonthActuals[employee.id] || 0;
                
                if (lastActual > lastTarget) {
                    // 上月超标，本月目标上调10%
                    targets[selectedMonth][employee.id] = Math.round(lastTarget * 1.1);
                    adjustedCount++;
                } else {
                    // 上月未达标，维持目标
                    targets[selectedMonth][employee.id] = lastTarget;
                }
            });
            
            savePerformanceTargets(targets);
            displayPerformanceTargets();
            
            alert(getText('target-recalculation-complete').replace('{count}', adjustedCount));
        }
        
        // 重置所有目标为初始值（200万韩元）
        function resetPerformanceTargets() {
            const selectedMonth = document.getElementById('performance-month').value;
            
            if (confirm(getText('confirm-reset-targets'))) {
                const targets = getPerformanceTargets();
                const employees = getEmployees();
                
                if (!targets[selectedMonth]) {
                    targets[selectedMonth] = {};
                }
                
                employees.forEach(employee => {
                    targets[selectedMonth][employee.id] = 2000; // 200万韩元 = 2000千韩元
                });
                
                savePerformanceTargets(targets);
                displayPerformanceTargets();
                
                alert(getText('targets-reset-complete'));
            }
        }
        
        // 获取职位文本
        function getPositionText(position) {
            const positionTexts = {
                'admin': currentLanguage === 'ko' ? '관리자' : '管理员',
                'manager': currentLanguage === 'ko' ? '매니저' : '经理',
                'salesperson': currentLanguage === 'ko' ? '영업사원' : '业务员'
            };
            return positionTexts[position] || position;
        }
        
        // ==================== 🔥 Firebase 云端数据同步功能 ====================
        
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyAcLyCy4FIL34AUd6vKrE_EqHV69qcFDYQ",
            authDomain: "mesiahair.firebaseapp.com",
            projectId: "mesiahair",
            storageBucket: "mesiahair.firebasestorage.app",
            messagingSenderId: "538029419112",
            appId: "1:538029419112:web:e2bb82a5fe0356e8d769dd"
        };
        
        // Firebase数据管理器
        class CloudDataManager {
            constructor() {
                this.db = null;
                this.isOnline = navigator.onLine;
                this.syncQueue = [];
                this.isInitialized = false;
                
                // 监听网络状态
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateSyncStatus();
                    this.processSyncQueue();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus();
                });
            }
            
            // 初始化Firebase
            async initialize() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    this.isInitialized = true;
                    console.log('🔥 Firebase已初始化，云端同步功能已启用');
                    
                    // 检查并迁移本地数据
                    await this.migrateLocalData();
                    
                    this.updateSyncStatus();
                    return true;
                } catch (error) {
                    console.error('❌ Firebase初始化失败:', error);
                    this.isInitialized = false;
                    this.updateSyncStatus();
                    return false;
                }
            }
            
            // 迁移本地数据到云端
            async migrateLocalData() {
                try {
                    const localEmployees = JSON.parse(localStorage.getItem('employees') || '[]');
                    const localSalons = JSON.parse(localStorage.getItem('salons') || '[]');
                    
                    if (localEmployees.length > 0) {
                        console.log('🔄 发现本地员工数据，开始迁移...');
                        for (const employee of localEmployees) {
                            await this.saveEmployee(employee);
                        }
                        console.log('✅ 员工数据迁移完成');
                    }
                    
                    if (localSalons.length > 0) {
                        console.log('🔄 发现本地沙龙数据，开始迁移...');
                        for (const salon of localSalons) {
                            await this.saveSalon(salon);
                        }
                        console.log('✅ 沙龙数据迁移完成');
                    }
                    
                } catch (error) {
                    console.error('❌ 数据迁移失败:', error);
                }
            }
            
            // 保存员工数据
            async saveEmployee(employee) {
                try {
                    if (this.isInitialized && this.isOnline) {
                        await this.db.collection('employees').doc(employee.id.toString()).set(employee);
                        console.log('☁️ 员工数据已同步到云端:', employee.name);
                        return true;
                    } else {
                        // 离线时存储到本地
                        this.addToSyncQueue(() => this.saveEmployee(employee));
                        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                        const index = employees.findIndex(emp => emp.id === employee.id);
                        if (index >= 0) {
                            employees[index] = employee;
                        } else {
                            employees.push(employee);
                        }
                        localStorage.setItem('employees', JSON.stringify(employees));
                        return true;
                    }
                } catch (error) {
                    console.error('❌ 保存员工数据失败:', error);
                    // 回退到本地存储
                    const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                    const index = employees.findIndex(emp => emp.id === employee.id);
                    if (index >= 0) {
                        employees[index] = employee;
                    } else {
                        employees.push(employee);
                    }
                    localStorage.setItem('employees', JSON.stringify(employees));
                    return true;
                }
            }
            
            // 获取员工数据
            async getEmployees() {
                try {
                    if (this.isInitialized && this.isOnline) {
                        const snapshot = await this.db.collection('employees').get();
                        const employees = [];
                        snapshot.forEach(doc => {
                            employees.push(doc.data());
                        });
                        // 同步到本地缓存
                        localStorage.setItem('employees', JSON.stringify(employees));
                        return employees;
                    } else {
                        // 离线时使用本地数据
                        return JSON.parse(localStorage.getItem('employees') || '[]');
                    }
                } catch (error) {
                    console.error('❌ 获取员工数据失败:', error);
                    return JSON.parse(localStorage.getItem('employees') || '[]');
                }
            }
            
            // 保存沙龙数据
            async saveSalon(salon) {
                try {
                    if (this.isInitialized && this.isOnline) {
                        await this.db.collection('salons').doc(salon.id.toString()).set(salon);
                        console.log('☁️ 沙龙数据已同步到云端:', salon.name);
                        return true;
                    } else {
                        // 离线时存储到本地
                        this.addToSyncQueue(() => this.saveSalon(salon));
                        const salons = JSON.parse(localStorage.getItem('salons') || '[]');
                        const index = salons.findIndex(s => s.id === salon.id);
                        if (index >= 0) {
                            salons[index] = salon;
                        } else {
                            salons.push(salon);
                        }
                        localStorage.setItem('salons', JSON.stringify(salons));
                        return true;
                    }
                } catch (error) {
                    console.error('❌ 保存沙龙数据失败:', error);
                    // 回退到本地存储
                    const salons = JSON.parse(localStorage.getItem('salons') || '[]');
                    const index = salons.findIndex(s => s.id === salon.id);
                    if (index >= 0) {
                        salons[index] = salon;
                    } else {
                        salons.push(salon);
                    }
                    localStorage.setItem('salons', JSON.stringify(salons));
                    return true;
                }
            }
            
            // 获取沙龙数据
            async getSalons() {
                try {
                    if (this.isInitialized && this.isOnline) {
                        const snapshot = await this.db.collection('salons').get();
                        const salons = [];
                        snapshot.forEach(doc => {
                            salons.push(doc.data());
                        });
                        // 同步到本地缓存
                        localStorage.setItem('salons', JSON.stringify(salons));
                        return salons;
                    } else {
                        // 离线时使用本地数据
                        return JSON.parse(localStorage.getItem('salons') || '[]');
                    }
                } catch (error) {
                    console.error('❌ 获取沙龙数据失败:', error);
                    return JSON.parse(localStorage.getItem('salons') || '[]');
                }
            }
            
            // 删除员工数据
            async deleteEmployee(employeeId) {
                try {
                    if (this.isInitialized && this.isOnline) {
                        await this.db.collection('employees').doc(employeeId.toString()).delete();
                        console.log('☁️ 员工数据已从云端删除:', employeeId);
                    } else {
                        this.addToSyncQueue(() => this.deleteEmployee(employeeId));
                    }
                    
                    // 同时删除本地数据
                    const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                    const filteredEmployees = employees.filter(emp => emp.id !== employeeId);
                    localStorage.setItem('employees', JSON.stringify(filteredEmployees));
                    return true;
                } catch (error) {
                    console.error('❌ 删除员工数据失败:', error);
                    return false;
                }
            }
            
            // 删除沙龙数据
            async deleteSalon(salonId) {
                try {
                    if (this.isInitialized && this.isOnline) {
                        await this.db.collection('salons').doc(salonId.toString()).delete();
                        console.log('☁️ 沙龙数据已从云端删除:', salonId);
                    } else {
                        this.addToSyncQueue(() => this.deleteSalon(salonId));
                    }
                    
                    // 同时删除本地数据
                    const salons = JSON.parse(localStorage.getItem('salons') || '[]');
                    const filteredSalons = salons.filter(salon => salon.id !== salonId);
                    localStorage.setItem('salons', JSON.stringify(filteredSalons));
                    return true;
                } catch (error) {
                    console.error('❌ 删除沙龙数据失败:', error);
                    return false;
                }
            }
            
            // 添加到同步队列
            addToSyncQueue(operation) {
                this.syncQueue.push(operation);
                this.updateSyncStatus();
            }
            
            // 处理同步队列
            async processSyncQueue() {
                if (!this.isInitialized || !this.isOnline) return;
                
                while (this.syncQueue.length > 0) {
                    const operation = this.syncQueue.shift();
                    try {
                        await operation();
                        console.log('✅ 队列操作同步成功');
                    } catch (error) {
                        console.error('❌ 队列操作同步失败:', error);
                        this.syncQueue.unshift(operation); // 重新加入队列
                        break;
                    }
                }
                this.updateSyncStatus();
            }
            
            // 更新同步状态显示
            updateSyncStatus() {
                const indicator = document.getElementById('sync-status-indicator');
                if (!indicator) return;
                
                const status = this.getSyncStatus();
                indicator.textContent = status.message;
                indicator.className = `sync-status ${status.type}`;
            }
            
            // 获取同步状态
            getSyncStatus() {
                if (!this.isInitialized) {
                    return { type: 'error', message: '云端同步未启用' };
                }
                
                if (!this.isOnline) {
                    return { 
                        type: 'offline', 
                        message: this.syncQueue.length > 0 ? 
                            `离线模式 (${this.syncQueue.length}项待同步)` : 
                            '离线模式'
                    };
                }
                
                if (this.syncQueue.length > 0) {
                    return { type: 'syncing', message: `同步中... (${this.syncQueue.length}项)` };
                }
                
                return { type: 'online', message: '云端已同步' };
            }
        }
        
        // 创建全局云端数据管理器
        const cloudDataManager = new CloudDataManager();
        
        // 云端同步功能已集成到上述函数中
        
        // 添加同步状态指示器
        function addSyncStatusIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'sync-status-indicator';
            indicator.className = 'sync-status offline';
            indicator.textContent = '初始化中...';
            indicator.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                padding: 6px 12px;
                border-radius: 15px;
                font-size: 0.8em;
                font-weight: bold;
                z-index: 1001;
                transition: all 0.3s ease;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .sync-status.online {
                    background: #4CAF50;
                    color: white;
                    border: 1px solid #45a049;
                }
                .sync-status.offline {
                    background: #ff9800;
                    color: white;
                    border: 1px solid #f57c00;
                }
                .sync-status.syncing {
                    background: #2196F3;
                    color: white;
                    border: 1px solid #1976D2;
                    animation: pulse 1.5s infinite;
                }
                .sync-status.error {
                    background: #f44336;
                    color: white;
                    border: 1px solid #d32f2f;
                }
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.7; }
                    100% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // 点击显示详细状态
            indicator.addEventListener('click', () => {
                const status = cloudDataManager.getSyncStatus();
                alert(`云端同步状态：${status.message}\n\n` +
                      `Firebase连接：${cloudDataManager.isInitialized ? '已连接' : '未连接'}\n` +
                      `网络状态：${cloudDataManager.isOnline ? '在线' : '离线'}\n` +
                      `待同步项目：${cloudDataManager.syncQueue.length}项`);
            });
            
            document.body.appendChild(indicator);
        }
        
        // 在页面加载完成后初始化云端同步
        document.addEventListener('DOMContentLoaded', async function() {
            // 添加同步状态指示器
            addSyncStatusIndicator();
            
            // 立即尝试初始化Firebase
            try {
                console.log('🔄 开始初始化云端同步...');
                const success = await cloudDataManager.initialize();
                if (success) {
                    console.log('🎉 云端数据同步功能已启用！');
                    cloudDataManager.updateSyncStatus();
                    // 定期更新状态
                    setInterval(() => {
                        cloudDataManager.updateSyncStatus();
                    }, 3000);
                } else {
                    console.log('⚠️ 云端同步初始化失败，将使用本地存储模式');
                    cloudDataManager.updateSyncStatus();
                }
            } catch (error) {
                console.error('❌ 云端同步初始化出错:', error);
                cloudDataManager.isInitialized = false;
                cloudDataManager.updateSyncStatus();
            }
        });
        
    </script>
</body>
</html> 