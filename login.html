<!-- login.html 登录界面接入 Firebase Authentication + 员工自主注册 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>MAKE IT HAIR Professional - 登录/注册</title>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.3.0/tsparticles.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { 
      background: #000; 
      color: white; 
      font-family: sans-serif; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      margin: 0; 
    }
    .auth-container { 
      background: rgba(30,30,30,0.9); 
      padding: 30px; 
      border-radius: 10px; 
      width: 400px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
    }
    .tab-button {
      flex: 1;
      padding: 10px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .tab-button.active {
      color: gold;
      border-bottom: 2px solid gold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
    }
    .form-row {
      display: flex;
      gap: 10px;
    }
    .form-row .form-group {
      flex: 1;
    }
    input, select { 
      width: 100%; 
      padding: 10px; 
      border: 1px solid #555;
      background: rgba(255,255,255,0.1);
      color: white;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input::placeholder {
      color: #999;
    }
    select {
      cursor: pointer;
    }
    button { 
      width: 100%; 
      padding: 12px; 
      margin-top: 20px; 
      background: gold; 
      color: black; 
      border: none; 
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #ffcc00;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .error-message {
      background: rgba(255,0,0,0.1);
      color: #ff6b6b;
      border: 1px solid #ff6b6b;
    }
    .success-message {
      background: rgba(0,255,0,0.1);
      color: #51cf66;
      border: 1px solid #51cf66;
    }
    .info-text {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    .title {
      text-align: center;
      margin-bottom: 20px;
      color: gold;
    }
  </style>
</head>
<body>
<div class="auth-container">
  <h2 class="title">MAKE IT HAIR Professional</h2>
  
  <div class="tab-container">
    <button class="tab-button active" onclick="switchTab('login')">登录</button>
    <button class="tab-button" onclick="switchTab('register')">员工注册</button>
  </div>

  <!-- 登录表单 -->
  <div id="loginTab" class="tab-content active">
    <div class="form-group">
      <label>电子邮箱</label>
      <input type="email" id="loginEmail" placeholder="请输入您的工作邮箱">
    </div>
    <div class="form-group">
      <label>密码</label>
      <input type="password" id="loginPassword" placeholder="请输入密码">
    </div>
    <button onclick="login()">登录</button>
    <div class="message error-message" id="loginError"></div>
  </div>

  <!-- 注册表单 -->
  <div id="registerTab" class="tab-content">
    <div class="form-group">
      <label>员工姓名 *</label>
      <input type="text" id="registerName" placeholder="请输入您的真实姓名">
    </div>
    
    <div class="form-group">
      <label>工作邮箱 *</label>
      <input type="email" id="registerEmail" placeholder="这将作为您的登录账号">
      <div class="info-text">此邮箱将用于登录系统</div>
    </div>
    
    <div class="form-group">
      <label>登录密码 *</label>
      <input type="password" id="registerPassword" placeholder="请设置登录密码（至少6位）">
    </div>
    
    <div class="form-group">
      <label>确认密码 *</label>
      <input type="password" id="registerConfirmPassword" placeholder="请再次输入密码">
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>手机号码 *</label>
        <input type="tel" id="registerMobile" placeholder="请输入手机号">
      </div>
      <div class="form-group">
        <label>入职日期</label>
        <input type="date" id="registerJoinDate">
      </div>
    </div>
    
    <div class="form-group">
      <label>个人简介</label>
      <input type="text" id="registerBio" placeholder="简单介绍一下自己（可选）">
    </div>
    
    <div class="info-text">
      * 必填项目 | 默认职位：业务员 | 管理员可后续调整权限
    </div>
    
    <button onclick="register()">注册为员工</button>
    <div class="message error-message" id="registerError"></div>
    <div class="message success-message" id="registerSuccess"></div>
  </div>
</div>

<script>
  // Firebase配置已在firebase-config.js中设置

  // 测试Firebase连接
  function testFirebaseConnection() {
    console.log('测试Firebase连接...');
    
    // 检查Firebase是否已初始化
    if (!firebase.apps || firebase.apps.length === 0) {
      console.error('Firebase未初始化');
      return false;
    }
    
    // 检查数据库连接
    try {
      const testRef = firebase.database().ref('test');
      console.log('Firebase数据库连接正常');
      return true;
    } catch (error) {
      console.error('Firebase数据库连接失败:', error);
      return false;
    }
  }

  // 初始化设置
  window.onload = function() {
    // 设置默认入职日期为今天
    document.getElementById('registerJoinDate').valueAsDate = new Date();
    
    // 测试Firebase连接
    testFirebaseConnection();
  };

  // 切换Tab
  function switchTab(tabName) {
    // 隐藏所有内容
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
      button.classList.remove('active');
    });
    
    // 显示选中的内容
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.classList.add('active');
    
    // 清除错误消息
    hideAllMessages();
  }

  // 隐藏所有消息
  function hideAllMessages() {
    document.querySelectorAll('.message').forEach(msg => {
      msg.style.display = 'none';
    });
  }

  // 显示错误消息
  function showError(elementId, message) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.style.display = 'block';
  }

  // 显示成功消息
  function showSuccess(elementId, message) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.style.display = 'block';
  }

  // 登录功能
  function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    hideAllMessages();
    
    if (!email || !password) {
      showError('loginError', '请填写完整的登录信息');
      return;
    }

    firebase.auth().signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        
        // 记录登录日志
        const log = {
          user: user.email,
          timestamp: new Date().toISOString(),
          type: 'login'
        };
        firebase.database().ref('logs').push(log);

        // 保存用户会话信息
        sessionStorage.setItem('user', JSON.stringify({ 
          email: user.email, 
          uid: user.uid 
        }));
        
        // 跳转到主页
        window.location.href = 'index.html';
      })
      .catch(error => {
        console.error('Login failed:', error);
        let errorMessage = '登录失败，请检查邮箱和密码';
        
        if (error.code === 'auth/user-not-found') {
          errorMessage = '账号不存在，请检查邮箱地址';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = '密码错误，请重试';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = '邮箱格式不正确';
        }
        
        showError('loginError', errorMessage);
      });
  }

  // 注册功能
  function register() {
    const name = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
    const mobile = document.getElementById('registerMobile').value.trim();
    const joinDate = document.getElementById('registerJoinDate').value;
    const bio = document.getElementById('registerBio').value.trim();
    
    hideAllMessages();
    
    // 测试Firebase连接
    if (!testFirebaseConnection()) {
      showError('registerError', 'Firebase连接失败，请检查网络连接');
      return;
    }
    
    // 验证必填字段
    if (!name || !email || !password || !confirmPassword || !mobile) {
      showError('registerError', '请填写所有必填项目');
      return;
    }
    
    // 验证密码
    if (password.length < 6) {
      showError('registerError', '密码至少需要6位字符');
      return;
    }
    
    if (password !== confirmPassword) {
      showError('registerError', '两次输入的密码不一致');
      return;
    }
    
    // 验证手机号（支持中国和韩国格式）
    const isValidMobile = 
      // 中国手机号：1[3-9]xxxxxxxxx (11位)
      /^1[3-9]\d{9}$/.test(mobile) ||
      // 中国固定电话：010-xxxxxxxx
      /^010-\d{8}$/.test(mobile) ||
      // 韩国手机号：010-xxxx-xxxx (带分隔符)
      /^010-\d{4}-\d{4}$/.test(mobile) ||
      // 韩国手机号：01xxxxxxxxx (11位不带分隔符)
      /^01[0-9]\d{8}$/.test(mobile) ||
      // 韩国其他运营商：011-xxxx-xxxx, 016-xxxx-xxxx, 017-xxxx-xxxx, 018-xxxx-xxxx, 019-xxxx-xxxx
      /^01[1,6,7,8,9]-\d{4}-\d{4}$/.test(mobile) ||
      // 韩国其他运营商不带分隔符：011xxxxxxxx, 016xxxxxxxx等
      /^01[1,6,7,8,9]\d{7}$/.test(mobile);
    
    if (!isValidMobile) {
      showError('registerError', '请输入正确的手机号码\n支持格式：\n• 中国：13812345678 或 010-12345678\n• 韩国：010-1234-5678 或 01012345678');
      return;
    }
    
    // 验证邮箱格式
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showError('registerError', '请输入正确的邮箱地址');
      return;
    }

    // 创建Firebase账户
    firebase.auth().createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        console.log('Firebase账户创建成功:', user.uid);
        
        // 创建员工记录
        const employeeId = Date.now(); // 使用时间戳作为ID
        const employeeData = {
          id: employeeId,
          name: name,
          email: email,
          mobile: mobile,
          position: 'salesperson', // 默认职位为业务员
          joinDate: joinDate || new Date().toISOString().split('T')[0],
          bio: bio || '',
          firebaseUid: user.uid, // 关联Firebase用户ID
          addTime: new Date().toISOString(),
          addedBy: 'self-register', // 标记为自主注册
          status: 'active' // 默认状态为活跃
        };
        
        console.log('准备保存员工信息:', employeeData);
        
        // 保存员工信息到Firebase数据库
        return firebase.database().ref('employees').push(employeeData).then(() => {
          console.log('员工信息保存成功');
          
          // 尝试更新用户显示名称（如果失败不影响整个流程）
          return user.updateProfile({
            displayName: name
          }).catch(profileError => {
            console.warn('更新显示名称失败，但不影响注册流程:', profileError);
            // 不抛出错误，继续执行
          });
        });
      })
      .then(() => {
        // 记录注册日志
        const log = {
          user: email,
          timestamp: new Date().toISOString(),
          type: 'register',
          data: { name: name, position: 'salesperson' }
        };
        firebase.database().ref('logs').push(log);
        
        // 显示成功消息
        showSuccess('registerSuccess', '注册成功！请使用新账号登录系统');
        
        // 清空表单
        document.getElementById('registerName').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerConfirmPassword').value = '';
        document.getElementById('registerMobile').value = '';
        document.getElementById('registerBio').value = '';
        
        // 3秒后自动切换到登录页面
        setTimeout(() => {
          switchTab('login');
          document.getElementById('loginEmail').value = email;
        }, 3000);
      })
      .catch(error => {
        console.error('Registration failed:', error);
        let errorMessage = '注册失败，请重试';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = '该邮箱已被注册，请使用其他邮箱或直接登录';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = '邮箱格式不正确';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = '密码强度太弱，请设置更复杂的密码';
        } else if (error.code === 'PERMISSION_DENIED') {
          errorMessage = '数据库权限不足，请检查Firebase配置';
        } else if (error.message && error.message.includes('displayName')) {
          errorMessage = '账号创建成功，但用户名设置失败，请联系管理员';
        }
        
        // 记录详细错误信息
        console.error('详细错误信息:', {
          code: error.code,
          message: error.message,
          stack: error.stack
        });
        
        showError('registerError', errorMessage);
      });
  }

  // 回车键登录
  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab.id === 'loginTab') {
        login();
      } else if (activeTab.id === 'registerTab') {
        register();
      }
    }
  });
</script>
</body>
</html>
