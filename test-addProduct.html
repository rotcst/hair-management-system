<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品添加功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #d4af37;
            border-radius: 10px;
        }
        button {
            background: #d4af37;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #b8941f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #d4af37;
            padding: 8px;
            text-align: center;
        }
        th {
            background: rgba(212, 175, 55, 0.2);
        }
        input {
            background: transparent;
            border: 1px solid #d4af37;
            color: white;
            padding: 5px;
            border-radius: 3px;
            width: 90%;
        }
        .log {
            background: #2a2a2a;
            border: 1px solid #555;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 产品添加功能测试</h1>
        
        <div>
            <button onclick="testAddProductRow()">➕ 测试添加产品行</button>
            <button onclick="testConsole()">📝 测试控制台</button>
            <button onclick="clearLog()">🧹 清空日志</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>产品名称</th>
                    <th>单价</th>
                    <th>数量</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- 产品行将在这里添加 -->
            </tbody>
        </table>
        
        <div class="log" id="testLog">
            <div>🚀 测试日志:</div>
        </div>
    </div>

    <script>
        // 简单的翻译系统
        const testTranslations = {
            'product-table-not-found-error': '系统错误：未找到产品表格。请刷新页面重试。',
            'add-product-row-failed': '添加产品行失败'
        };
        
        function getText(key) {
            return testTranslations[key] || key;
        }
        
        // 模拟必要的全局变量
        let productRowCounter = 0;
        let currentSalonId = 'test-salon-1';
        
        // 模拟必要的函数
        function getSalons() {
            return [{
                id: 'test-salon-1',
                name: '测试美发店',
                transactions: [{
                    id: 1,
                    date: new Date('2024-01-01'),
                    products: [{
                        name: '洗发水',
                        unitPrice: 15000,
                        quantity: 2,
                        giftQuantity: 0
                    }]
                }]
            }];
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function updateTexts() {
            // 模拟翻译更新
            log('翻译更新完成');
        }
        
        function calculateTotalAmount() {
            log('计算总金额');
        }
        
        function calculateRowTotal(rowId) {
            log(`计算行总额: ${rowId}`);
        }
        
        // 日志函数
        function log(message) {
            const logDiv = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div>🚀 测试日志:</div>';
        }
        
        function testConsole() {
            console.log('测试控制台输出');
            log('已发送测试消息到控制台');
        }
        
        // 产品历史记录检查函数（简化版）
        function checkProductHistory(input, rowId) {
            try {
                const productName = input.value.trim();
                const historyDiv = document.getElementById(`productHistory_${rowId}`);
                
                if (!historyDiv) {
                    log(`警告: 历史记录显示区域未找到: productHistory_${rowId}`);
                    return;
                }
                
                if (productName.length < 2) {
                    historyDiv.style.display = 'none';
                    return;
                }
                
                if (!currentSalonId) {
                    historyDiv.innerHTML = `<span style="color: #cccccc;">请先选择一个美发店</span>`;
                    historyDiv.style.display = 'block';
                    return;
                }
                
                log(`检查产品历史: ${productName}`);
                historyDiv.innerHTML = `<div style="color: #87CEEB;">🔍 搜索历史记录中...</div>`;
                historyDiv.style.display = 'block';
                
                // 模拟异步搜索
                setTimeout(() => {
                    if (productName.includes('洗发水')) {
                        historyDiv.innerHTML = `
                            <div style="color: #87CEEB;">
                                📦 <strong>洗发水</strong><br>
                                🕒 上次购买：2024年1月1日 (${Math.floor((new Date() - new Date('2024-01-01')) / (1000*60*60*24))}天前)<br>
                                📊 数量：2个<br>
                                💰 单价：₩15,000<br>
                                <span style="color: #FF6666;">🔴 长期未购买此产品</span>
                            </div>
                        `;
                    } else {
                        historyDiv.innerHTML = `<span style="color: #cccccc;">🆕 新产品 - 该美发店未购买过此产品</span>`;
                    }
                }, 500);
                
            } catch (error) {
                log(`错误: 产品历史记录检查失败 - ${error.message}`);
            }
        }
        
        // 主要测试函数：添加产品行
        function addProductRow() {
            try {
                log(`开始添加产品行: ${productRowCounter + 1}`);
                productRowCounter++;
                const tbody = document.getElementById('productTableBody');
                
                if (!tbody) {
                    log('错误: 未找到产品表格tbody元素');
                    alert(getText('product-table-not-found-error'));
                    return;
                }
                
                const row = document.createElement('tr');
                row.id = `productRow_${productRowCounter}`;
                row.innerHTML = `
                    <td style="position: relative;">
                        <input type="text" placeholder="产品名称" id="productName_${productRowCounter}">
                        <div id="productHistory_${productRowCounter}" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: rgba(0, 0, 0, 0.9); border: 1px solid #d4af37; border-top: none; border-radius: 0 0 3px 3px; padding: 8px; z-index: 100; font-size: 0.8em; color: #87CEEB; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>
                    </td>
                    <td>
                        <input type="text" placeholder="1,000">
                    </td>
                    <td>
                        <input type="number" placeholder="1" min="0" max="99">
                    </td>
                    <td>
                        <button onclick="removeProductRow(${productRowCounter})" style="background: #ff6666; color: white; padding: 3px 8px;">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // 为产品名称输入框添加事件监听器
                const productNameInput = document.getElementById(`productName_${productRowCounter}`);
                if (productNameInput) {
                    productNameInput.addEventListener('input', function() {
                        checkProductHistory(this, productRowCounter);
                    });
                    productNameInput.addEventListener('blur', function() {
                        setTimeout(() => {
                            const historyDiv = document.getElementById(`productHistory_${productRowCounter}`);
                            if (historyDiv) {
                                historyDiv.style.display = 'none';
                            }
                        }, 200);
                    });
                    log(`事件监听器已添加到产品名称输入框: productName_${productRowCounter}`);
                }
                
                updateTexts();
                calculateTotalAmount();
                log(`✅ 产品行添加成功: productRow_${productRowCounter}`);
                
            } catch (error) {
                log(`❌ 添加产品行失败: ${error.message}`);
                console.error('添加产品行出错:', error);
                alert(getText('add-product-row-failed') + '：' + error.message);
            }
        }
        
        function removeProductRow(rowId) {
            try {
                const row = document.getElementById(`productRow_${rowId}`);
                if (row) {
                    row.remove();
                    log(`✅ 产品行删除成功: productRow_${rowId}`);
                } else {
                    log(`⚠️ 未找到要删除的产品行: productRow_${rowId}`);
                }
            } catch (error) {
                log(`❌ 删除产品行失败: ${error.message}`);
            }
        }
        
        function testAddProductRow() {
            log('🧪 开始测试添加产品行功能...');
            addProductRow();
        }
        
        // 页面加载完成后自动添加一行
        document.addEventListener('DOMContentLoaded', function() {
            log('📄 页面加载完成');
            log('🔧 自动添加第一行产品...');
            addProductRow();
        });
    </script>
</body>
</html> 